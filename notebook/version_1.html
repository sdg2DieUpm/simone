<!DOCTYPE html>
<html class="no-js" lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://sdg2dieupm.github.io/simone/notebook/version_1.html" rel="canonical"/>
<link href="version_0.html" rel="prev"/>
<link href="version_2.html" rel="next"/>
<link href="../assets/notebook_imgs/general/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Versi√≥n 1 - Laboratorio de Sistemas Digitales II</title>
<link href="../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/notebook-extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
<body data-md-color-accent="deep_orange" data-md-color-primary="blue_grey" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cha:version1">
          Saltar a contenido
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Cabecera" class="md-header__inner md-grid">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-header__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Laboratorio de Sistemas Digitales II
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Versi√≥n 1
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Cambiar a modo oscuro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Cambiar a modo oscuro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Cambiar a modo claro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Cambiar a modo claro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="B√∫squeda" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="B√∫squeda" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Buscar" class="md-search__options">
<button aria-label="Limpiar" class="md-search__icon md-icon" tabindex="-1" title="Limpiar" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navegaci√≥n" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-nav__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
    Laboratorio de Sistemas Digitales II
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../index.html">
<span class="md-ellipsis">
    Portada
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Introducci√≥n general
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introducci√≥n general
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="intro.html">
<span class="md-ellipsis">
    Introducci√≥n a SDG2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="sesion_introduccion.html">
<span class="md-ellipsis">
    Sesi√≥n de introducci√≥n
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    Proyecto
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Proyecto
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="version_0.html">
<span class="md-ellipsis">
    Versi√≥n 0
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Versi√≥n 1
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="version_1.html">
<span class="md-ellipsis">
    Versi√≥n 1
    
  </span>
</a>
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#caracteristicas-del-boton-de-usuario-en-version-1">
<span class="md-ellipsis">
      Caracter√≠sticas del bot√≥n de usuario en Versi√≥n 1
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_button">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_button">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v1">
<span class="md-ellipsis">
      PORT: Test unitario del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-boton">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:fsm_button_c">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v1">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-1">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 1
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_2.html">
<span class="md-ellipsis">
    Versi√≥n 2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_3.html">
<span class="md-ellipsis">
    Versi√≥n 3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_4.html">
<span class="md-ellipsis">
    Versi√≥n 4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_5.html">
<span class="md-ellipsis">
    Versi√≥n 5
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    API
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            API
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/index.html">
<span class="md-ellipsis">
    Documentaci√≥n API
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    Ap√©ndices
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Ap√©ndices
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="bom.html">
<span class="md-ellipsis">
    BOM
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Acr√≥nimos
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="acronimos.html">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../pdf/manual_simone.pdf">
<span class="md-ellipsis">
    üì• Descargar como PDF
    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#caracteristicas-del-boton-de-usuario-en-version-1">
<span class="md-ellipsis">
      Caracter√≠sticas del bot√≥n de usuario en Versi√≥n 1
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_button">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_button">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v1">
<span class="md-ellipsis">
      PORT: Test unitario del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-boton">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:fsm_button_c">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v1">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del bot√≥n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-1">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 1
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cha:version1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.</span> Versi√≥n 1: bot√≥n de usuario<a class="headerlink" href="#cha:version1" title="Permanent link">¬∂</a></h1>
<p>Ya estamos en disposici√≥n de programar el bloque que controla la pulsaci√≥n del bot√≥n para encender y apagar el sistema <em>Simone</em>, y para pausarlo. Debes tener a mano en todo momento <strong>los documentos referenciados y ver los v√≠deos sugeridos</strong> a fin de entender mejor c√≥mo tienes que escribir el c√≥digo o realizar montajes.
tt</p>
<div class="admonition example">
<p class="admonition-title">Bibliograf√≠a</p>
<ol>
<li>
<p><em>‚ÄúFundamentos te√≥ricos de sistemas basados en microcontrolador STM32‚Äù</em>¬†<sup id="fnref3:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup></p>
</li>
<li>
<p><em>Datasheet ‚ÄúSTM32F446xC/E‚Äù</em>¬†<sup id="fnref:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">4</a></sup></p>
</li>
<li>
<p><em>Reference manual ‚ÄúRM0390. STM32F446xx advanced Arm-based 32-bit MCUs‚Äô</em>¬†<sup id="fnref:st2021reference"><a class="footnote-ref" href="#fn:st2021reference">5</a></sup></p>
</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title"><a href="https://www.youtube.com/channel/UCYIw_gl745WMJ1n0MamDzQw/">V√≠deos del canal de SDGII</a></p>
<ul>
<li>
<p><a href="https://youtu.be/v-HXdcEtT_4">Demostraci√≥n Simone</a></p>
</li>
<li>
<p><a href="https://youtu.be/CcbgLVfCXrw?si=A8DP1rescxJNBEb9">Blink LED y manejo de proyecto</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLTFFovUxjNnn19myGVw1kwh6GPbRxwIcC">Conceptos b√°sicos de C (canal SDG1)</a></p>
</li>
<li>
<p><a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen</a></p>
</li>
</ul>
</div>
<p>Vamos a desarrollar el <em>bot√≥n</em> de control del sistema <em>Simone</em>. Vamos a trabajar con el <em>timer</em> del sistema y m√°quinas de estado. En esta secci√≥n explicaremos los fundamentos de esta librer√≠a y posteriormente seguiremos los pasos para desarrollarla. Para desarrollar esta librer√≠a vamos a contar con la <a href="acronimos.html#acro:API"><strong>API</strong></a>.</p>
<p>En esta versi√≥n 1, el sistema solo trabaja con el bot√≥n de usuario. Las caracter√≠sticas a destacar de este montaje se muestran en el¬†. El bot√≥n de usuario est√° conectado al pin <code>PC13</code>, por lo que usaremos la interrupci√≥n externa <code>EXTI13</code> para detectar cuando pulsamos y soltamos el bot√≥n. La prioridad de la interrupci√≥n ser√° 1, la m√°s alta, para poder parar el sistema en cualquier momento.</p>
<div id="tbl:version1_button"></div>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong>Par√°metro</strong></th>
<th style="text-align: center;"><strong>Valor</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Pin</td>
<td style="text-align: center;"><code>PC13</code></td>
</tr>
<tr>
<td style="text-align: left;">Modo</td>
<td style="text-align: center;">Entrada</td>
</tr>
<tr>
<td style="text-align: left;">Pull up/ down</td>
<td style="text-align: center;">No push no pull</td>
</tr>
<tr>
<td style="text-align: left;">EXTI</td>
<td style="text-align: center;"><code>EXTI13</code></td>
</tr>
<tr>
<td style="text-align: left;">ISR</td>
<td style="text-align: center;"><code>EXTI15_10_IRQHandler()</code></td>
</tr>
<tr>
<td style="text-align: left;">Prioridad</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: left;">Subprioridad</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: left;">Tiempo anti-rebotes</td>
<td style="text-align: center;"><span class="arithmatex">\(100-200 ms\)</span></td>
</tr>
</tbody>
</table>
<h2 id="caracteristicas-del-boton-de-usuario-en-version-1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.1</span> Caracter√≠sticas del bot√≥n de usuario en Versi√≥n 1<a class="headerlink" href="#caracteristicas-del-boton-de-usuario-en-version-1" title="Permanent link">¬∂</a></h2>
<p>Estudia y practica con las m√°quinas de estado. Entiende c√≥mo se definen los estados, las tablas de transiciones, y qu√© son las funciones de entrada/¬†comprobaci√≥n y salida/¬†actuaci√≥n. Para ello vuelve a leer <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/gen_book_icon.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/gen_book_icon.png"/></a> <strong>el cap√≠tulo ‚Äú2. Introducci√≥n a las m√°quinas de estados en C‚Äù</strong>¬†<sup id="fnref:stm322025tutoriales"><a class="footnote-ref" href="#fn:stm322025tutoriales">6</a></sup>.</p>
<p>Si tienes la oportunidad de abrir un bot√≥n pulsador<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, seguramente encuentres un dise√±o mec√°nico como el de la <a href="#fig:button_mechanics">figura</a>. Se trata de una chapa met√°lica pegada a un aislante (donde toca el usuario) y colocada sobre un muelle. En la parte inferior, los pines del bot√≥n est√°n tambi√©n en contacto con una chapa met√°lica. Al presionar, la chapa superior entra en contacto con la inferior y cierra el circuito (cortocircuito), circulando la corriente a trav√©s del bot√≥n. Cuando se suelta, la corriente deja de pasar (circuito abierto).</p>
<figure><embed id="fig:button_mechanics" src="../assets/notebook_imgs/pr_chapters/version_1/button_mechanics.png" style="width:45.0%"/><figcaption aria-hidden="true">Representaci√≥n mec√°nica de un bot√≥n.</figcaption></figure>
<p>En la <a href="fig:button_nucleo">figura del esquema</a> vemos el esquem√°tico del bot√≥n de usuario <code>B1</code> en la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>. Cuando pulsamos el bot√≥n, este hace cortocircuito con <code>GND</code>, por lo que la tensi√≥n en el puerto <code>PC13</code> del microcontrolador pasa de alto a bajo (flanco de bajada).</p>
<figure><embed id="fig:button_nucleo" src="../assets/notebook_imgs/pr_chapters/version_1/button_nucleo.png" style="width:50.0%"/><figcaption aria-hidden="true">Esquema del circuito del bot√≥n en la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</figcaption></figure>
<p>Como habr√°s podido intuir, el muelle genera inestabilidades cuando se pulsa, esto es a lo que llamamos <strong>rebotes</strong> (<em>bounces</em> en ingl√©s). Estos rebotes son molestos porque se pueden interpretar como m√∫ltiples pulsaciones del usuario, por lo que hay que poner alg√∫n mecanismo para filtrarlos. Se pueden hacer mecanismos HW como un filtro paso bajo o, como en nuestro caso, se pueden implementar mecanismos SW.</p>
<p>En SW hay varias formas de implementar dicho mecanismo. En nuestra propuesta lo haremos a trav√©s de la definici√≥n de un tiempo de guarda que obliga a ignorar todo lo que pasa en ese intervalo. F√≠jate en el supuesto de la¬†<a href="#fig:button_debound">figura de rebotes</a>. <strong>Para el proyecto vamos a considerar que la pulsaci√≥n empieza cuando la ISR detecta el flanco de bajada, y hasta que se detecta un flanco de subida v√°lido</strong>. En la figura, hay una pulsaci√≥n de usuario, y la mec√°nica del bot√≥n hace que haya 2 rebotes bien definidos. El primer rebote no se detecta porque est√° dentro del tiempo de guarda. No obstante, este tiempo no es lo suficiente grande y <em>se nos cuela</em> el segundo rebote. Esta figura nos servir√° como ejemplo para entender el desarrollo de la FSM.</p>
<figure><embed id="fig:button_debound" src="../assets/notebook_imgs/pr_chapters/version_1/button_debounce.png" style="width:100.0%"/><figcaption aria-hidden="true">Ejemplo de 2 rebotes en una pulsaci√≥n con tiempo de anti-rebotes bajo.</figcaption></figure>
<p>Salvo que tengamos mucha experiencia jugando a videojuegos¬†üòÖ, no seremos muy r√°pidos pulsando el bot√≥n. Dejando un tiempo de guarda entre <span class="arithmatex">\(100-200 ms\)</span> deber√≠a ser suficiente, pero depende del deterioro de nuestro bot√≥n y quiz√°s debamos ajustarlo haciendo pruebas en el laboratorio con el osciloscopio. Ya estamos preparados para implementar la FSM.</p>
<p>Tenemos que entender que <strong>estamos desarrollando una librer√≠a.</strong> As√≠ lo vamos a hacer con todos los bloques del sistema. ¬øQu√© quiere decir esto? Tenemos que pensar que una librer√≠a es una entidad superior que me proporciona <em>‚Äúcosas‚Äù</em>. Pueden ser funciones, o elementos (estructuras). Me puede proporcionar tantos como necesite. El desarrollo de la librer√≠a es ajeno al bot√≥n que vamos a usar (ir√° en el <code>COMMON</code>, es una l√≥gica <em>com√∫n</em>, gen√©rica, independiente del HW). Puedo tener <span class="arithmatex">\(1\)</span> bot√≥n, o <span class="arithmatex">\(N\)</span> botones. Cada vez que quiera usar un bot√≥n, a este le asociar√© una <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> de bot√≥n. Las particularidades de d√≥nde est√° conectado este nuevo bot√≥n, sus caracter√≠sticas f√≠sicas (tiempo de rebote), <em>etc.</em>, son cosas espec√≠ficas del HW, por lo que estar√°n en <code>PORT</code>. La l√≥gica la vamos a hacer, siempre que se pueda, con m√°quinas de estado. El <em>bot√≥n</em> implementa su propia m√°quina de estados. Esta filosof√≠a es la que mantendremos a lo largo de todo el proyecto.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Vamos a empezar por la parte portable <code>PORT</code> de control y acceso al HW. Empezaremos con las cabeceras <code>.h</code>y seguiremos con la implementaci√≥n de las funciones de los ficheros fuente <code>.c</code>. Para comprobar que todo funciona correctamente, pasaremos el <em>test</em> unitario de la parte <code>PORT</code>. Luego, pasaremos a la parte <code>COMMON</code> de la librer√≠a, que es la l√≥gica com√∫n a todos los sistemas. Empezaremos con las cabeceras y seguiremos con la implementaci√≥n de las funciones de los ficheros fuente. Para comprobar que todo funciona correctamente, pasaremos el <em>test</em> unitario de la parte <code>COMMON</code>, y finalizaremos con el ejemplo de uso de la librer√≠a. </p>
<p>Las cabeceras <code>.h</code> van a se nuestro <strong><em>‚Äúcontrato con el usuario‚Äù</em></strong>, y en los ficheros fuente <code>.c</code> implementaremos las funciones. <strong>Este es el ciclo de desarrollo que vamos a seguir en todo el proyecto.</strong></p>
</div>
<figure style="text-align:center;"> <div style="display: flex; justify-content: center; align-items: center; gap: 10px;"> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/stm32f4_button_hw_t.png"><img alt="Estructura HW bot√≥n" id="fig:stm32f4_button_hw_t" src="../assets/notebook_imgs/pr_chapters/version_1/stm32f4_button_hw_t.png" style="width:200%;"/></a> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/fsm_button_t.png"><img alt="Estructura FSM bot√≥n" id="fig:fsm_button_t" src="../assets/notebook_imgs/pr_chapters/version_1/fsm_button_t.png" style="width:200%;"/></a> </div> <figcaption>(a) Estructura del HW del bot√≥n en PORT, (b) Estructura de la FSM del bot√≥n en COMMON.</figcaption> </figure>
<p>Las <a href="#fig:stm32f4_button_hw_t">figuras de estructuras HW</a> <a href="#fig:fsm_button_t">y SW</a> muestran las estructuras que vamos a necesitar para el bot√≥n. La estructura del HW del bot√≥n en <code>PORT</code>. El <code>PORT</code> de otro microcontrolador podr√≠a implementar internamente una estructura diferente, por eso est√° dentro de la carpeta <code>stm32f4</code>. Por ejemplo, al <em>portar</em> el c√≥digo para PC no tendr√≠a sentido definir la estructura de una GPIO. La estructura de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> del bot√≥n en <code>COMMON</code> se muestra en la <a href="#fig:fsm_button_t">figura de la FSM</a>.</p>
<p>Ahora s√≠, comencemos. Preparemos el proyecto para poder a√±adir el <em>bot√≥n</em>:</p>
<ol>
<li>
<p>Descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte PORT</strong> de la librer√≠a del <em>bot√≥n</em> correspondientes a la versi√≥n <code>V1</code>: <a href="https://github.com/sdg2DieUpm/Simone/tree/simone_v1">https://github.com/sdg2DieUpm/Simone/tree/simone_v1</a>. Solo descarga por ahora: <code>port_button.h</code>, <code>stm32f4_button.h</code> y <code>stm32f4_button.c</code> y col√≥calos en las carpetas correspondientes de tu proyecto. <strong>No a√±adas los ficheros de la parte COMMON.</strong></p>
</li>
<li>
<p>Coloca cada uno donde corresponde: <code>include</code>, o <code>src</code>. <strong>Ten en cuenta que algunos ficheros de <code>PORT</code> est√°n en la carpeta <code>stm32f4</code> porque sus funciones reciben o devuelven estructuras espec√≠ficas de la <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</strong></p>
<p>Ver√°s que no compila, y es que solo se te proporciona cierta parte del c√≥digo. Los prototipos de gran parte de las funciones p√∫blicas no est√°n definidos.</p>
</li>
</ol>
<h2 id="sec:headers_button"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.2</span> <code>PORT</code>: cabeceras de la librer√≠a del bot√≥n<a class="headerlink" href="#sec:headers_button" title="Permanent link">¬∂</a></h2>
<p>Vamos a implementar el <em>contrato con el usuario</em> de la parte dependiente del HW de librer√≠a del bot√≥n. Esto es, qu√© interfaz vamos a proporcionar al usuario para que pueda usar la librer√≠a y crear tantos botones como necesite. Lo haremos, c√≥mo no, para la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</p>
<p>Durante todo el desarrollo del proyecto, <strong>si detectas que falta alg√∫n</strong> <code>#define</code>, <strong>o</strong> <code>#include</code>, <strong>o declaraci√≥n de variable que sea necesaria o que necesite, hazlo. Lo que aqu√≠ se expone no es algo inmutable, aunque sigue unas buenas pr√°cticas.</strong></p>
<p>La <a href="#fig:template_header">figura de plantilla</a> representa las secciones de una plantilla gen√©rica de cabecera que puede utilizar a lo largo del proyecto. El orden no es un est√°ndar, ni las secciones que ah√≠ aparecen. No obstante, s√≠ es muy conveniente ser ordenado y met√≥dico en programaci√≥n. S√≠ es importante el orden en los siguientes casos:</p>
<ul>
<li>
<p>La inclusi√≥n de cabeceras ha de ser lo primero. Es importante el orden en caso de existir dependencias entre ellas.</p>
</li>
<li>
<p>Es aconsejable definir las etiquetas, macros, enumerados‚Ä¶¬†justo despu√©s para que puedan ser utilizados en la declaraci√≥n y definici√≥n de variables. <strong>Solo pondremos en el <code>.h</code> aqu√©llas que queramos que sean visibles y utilizadas por otros ficheros. En caso contrario, lo colocaremos en el <code>.c</code></strong>.</p>
</li>
<li>
<p>Si se declara alg√∫n tipo nuevo de variable, hay que hacerlo antes de que se use en el prototipo de alguna funci√≥n. <strong>Las funciones que no queramos que sean accesibles por otros ficheros no tendr√°n prototipo, y escribiremos y documentaremos directamente en el <code>.c</code>, adem√°s, se definir√°n como <code>static</code>.</strong></p>
</li>
</ul>
<figure><embed id="fig:template_header" src="../assets/notebook_imgs/pr_chapters/version_1/template_header.svg" style="width:100%"/><figcaption aria-hidden="true">Sugerencia de plantilla gen√©rica de una cabecera.</figcaption></figure>
<p>Nuestro bot√≥n es <strong>el bot√≥n de usuario <code>B1</code> de la placa (el azul) ser√° el bot√≥n para arranque y parada del juego. Est√° conectado a la GPIO PC13</strong>. Si lo queremos ver en el osciloscopio, tendremos que pinchar en el pin indicado en el <em>header</em>-Morpho izquierdo, como marca la figura <em>‚ÄúPinout y funciones header -Morpho izquierdo.‚Äù</em> del libro de fundamentos te√≥ricos¬†<sup id="fnref:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup>. El esquem√°tico del circuito del bot√≥n es el que se mostr√≥ en la <a href="#fig:button_nucleo">figura del esquem√°tico</a>.</p>
<h3 id="cabecera-port_buttonh"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.2.1</span> Cabecera port_button.h<a class="headerlink" href="#cabecera-port_buttonh" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera depende del HW pero no de las particularidades del microcontrolador <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. En ella vamos a definir las funciones que el usuario podr√° usar para gestionar el bot√≥n. <strong>F√≠jate que todas las funciones reciben el identificador del bot√≥n</strong> y solo pueden recibir o devolver variables que <strong>NO dependan del microcontrolador</strong>. Vamos a seguir los siguientes pasos:</p>
<ul>
<li>
<p>Vamos a definir (<code>#define</code>) dos valores que nombraremos en un consenso con nosotros mismos. Puede cambiarlos si lo desea, pero deber√°n ser los mismos que luego use en el resto del proyecto <strong>¬°y en los test, si los cambias, tendr√°s que tocar los ficheros de test tambi√©n!</strong> Los valores son:</p>
</li>
<li>
<p><code>PORT_USER_BUTTON_ID</code>: valor num√©rico natural que ser√° el identificador del bot√≥n para indicar arranque y parada del juego Simone. Si es nuestro primer y/¬†o √∫nico bot√≥n del sistema, le asignaremos el <code>0</code>.</p>
</li>
<li>
<p><code>PORT_USER_BUTTON_DEBOUNCE_TIME_MS</code>: tiempo del anti-rebotes del bot√≥n en <span class="arithmatex">\(ms\)</span>.</p>
</li>
<li>
<p>Escribe los prototipos de las funciones p√∫blicas que aparecen en la API del fichero <code>port_button.h</code>.</p>
</li>
<li>
<p>Puede ser buen momento ahora para documentar las funciones con Doxygen. Para que aparezca en la API el campo y su definici√≥n, hay que poner <code>/*!&lt; aqui_la_definicion */</code> junto al nombre del campo como muestra la <a href="#fig:doxygen_enum">figura de ejemplo de Doxygen en enumerados</a>.</p>
<p></p><figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/doxygen_enum.png"><img alt="Comentario de Doxygen en las claves de un enumerado." id="fig:doxygen_enum" src="../assets/notebook_imgs/pr_chapters/version_1/doxygen_enum.png" style="width:90.0%"/></a><figcaption aria-hidden="true">Comentario de Doxygen en las claves de un enumerado.</figcaption></figure><p></p>
<p>Puedes partir de los ejemplos dados en el fichero <code>port_system.h</code> y ayudarse con extensa documentaci√≥n online. <strong>Puede hacerlo en espa√±ol o ingl√©s</strong><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Podemos tener ayuda para autocomentar parcialmente el c√≥digo con Doxygen. Compruea si tienes instalada la extensi√≥n llamada <em>Doxygen Documentation Generator</em> ‚Äîa veces se instala junto con otras extensiones‚Äî; si no la tienes, puedes instalarla. Con esta extensi√≥n, si te colocas justo en la lƒ±ÃÅnea encima del nombre de la funci√≥n y escribes: <em>barra, asterisco, asterisco, enter</em> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/doxygen_autocomment.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/pr_chapters/version_1/doxygen_autocomment.png"/></a>, colocando el cursor en la tercera posici√≥n, como en la imagen, para darle a enter, se genera autom√°ticamente un esqueleto para poder completarlo. Tambi√©n se puede hacer si, colocados justo encima de la funci√≥n, damos bot√≥n derecho ‚Üí Generate Doxygen Comment.</p>
</div>
<p>Ya hemos acabado con el encabezado que interact√∫a con el HW del bot√≥n y que no depende del microcontrolador. Todav√≠a dar√° errores al compilar. Vamos ahora a programar la cabecera que s√≠ depende del microcontrolador <code>stm32f4_button.h</code>.</p>
<h3 id="cabecera-stm32f4_buttonh"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.2.2</span> Cabecera stm32f4_button.h<a class="headerlink" href="#cabecera-stm32f4_buttonh" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera depende del HW y del microcontrolador <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. En ella vamos a definir la funci√≥n que permitir√° al usuario asignar una GPIO al bot√≥n. En la versi√≥n V5, si lo necesitas, puedes a√±adir m√°s funciones que dependan del microcontrolador. Vamos a seguir los siguientes pasos:</p>
<ul>
<li>
<p>Como vamos a hacer uso de funciones de control de las GPIO, vamos a incluir <code>stm32f4xx.h</code>, que nos da acceso a los registros.</p>
</li>
<li>
<p>Vamos a definir (<code>#define</code>) los valores de la GPIO y el pin al que est√° conectado el bot√≥n, y que se indican en la <a href="#tbl:version1_button">tabla resumen del bot√≥n</a>:</p>
</li>
<li>
<p><code>STM32F4_USER_BUTTON_GPIO</code>: GPIO a la que est√° conectada el bot√≥n de usuario en la placa. Pon el nombre de la GPIO. Por ejemplo: <code>GPIOH</code>, si estuviese conectado a la GPIO H. Este nombre, es el de la estructura de <code>CMSIS</code> y se define en <code>stm32f4xx.h</code>. Puedes hacer <code>CTRL + click</code> sobre el nombre de la GPIO para ir a su definici√≥n.</p>
</li>
<li>
<p><code>STM32F4_USER_BUTTON_PIN</code>: pin/¬†l√≠nea de la GPIO del bot√≥n. Es un n√∫mero entero que va de 0 a 15.</p>
</li>
<li>
<p>En el fichero tenemos que declarar tambi√©n una estructura llamada <code>stm32f4_button_hw_t</code> (ver la <a href="#fig:stm32f4_button_hw_t">figura del struct</a>). Esta estructura se pone en el <code>.h</code> y se hace p√∫blica para que pueda ser usada por la ISR del bot√≥n en el fichero <code>interr.c</code>. Esto es as√≠ porque a las ISR no se les puede pasar argumentos. En ella se definen los campos que se muestran en la figura.</p>
<p>Esta estructura es gen√©rica para cualquier bot√≥n que vayamos a usar, no solo el de usuario <code>B1</code>, sino cualquiera que desee a√±adir m√°s tarde.</p>
<p>El campo <code>flag_pressed</code> nos indica si el bot√≥n se ha pulsado, o no. Ya vimos que cuando pulsamos nuestro bot√≥n se produce un flanco de bajada por c√≥mo est√°n conectados sus pines (ver <a href="#fig:button_debound">figura de rebotes</a>). Son las ISR las que hacen esta interpretaci√≥n.</p>
</li>
<li>
<p>Vamos declarar un array de estructuras de tipo <code>stm32f4_button_hw_t</code> como <code>extern</code> que se definir√° en el fichero fuente <code>stm32f4_button.c</code>. Este array contendr√° las caracter√≠sticas de todos los botones que tengamos en el sistema.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="n">stm32f4_button_hw_t</span><span class="w"> </span><span class="n">buttons_arr</span><span class="p">[];</span>
</code></pre></div>
<ul>
<li>Puede ser buen momento ahora para documentar la funci√≥n, la estructura y sus campos, y los <code>#define</code> con Doxygen.</li>
</ul>
<p>Ya hemos acabado con el encabezado (<em>header</em>) que interact√∫a con el HW del bot√≥n y depende del microcontrolador. Todav√≠a dar√° errores al compilar. Vamos ahora a implementar todas las funciones prototipadas aqu√≠ y en <code>port_button.h</code>.</p>
<h2 id="sec:port_button"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.3</span> <code>PORT</code>: fuente de la librer√≠a del bot√≥n<a class="headerlink" href="#sec:port_button" title="Permanent link">¬∂</a></h2>
<p>Si observas la API, ver√°s que la FSM del <em>bot√≥n</em> hace llamadas a funciones que empiezan por <code>port_</code>. Estas son funciones <em>portables</em>, y el usuario que quiera usar la librer√≠a de la FSM del <em>bot√≥n</em> debe programarlas y adaptarlas a su HW.</p>
<p>Vamos a <em>portar</em> las funciones necesarias para usar la librer√≠a bot√≥n y comprobar que la parte HW est√° bien programada. Lo haremos, c√≥mo no, para la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>. Ya tenemos las cabeceras HW del bot√≥n: las que no dependen del microcontrolador (<code>port_button.h</code>) y las que s√≠ (<code>stm32f4_button.h</code>). Vamos a programar los ficheros fuente de la parte <code>PORT</code>, que <strong>todos estar√°n en el fichero <code>stm32f4_button.c</code></strong>. Deber√°s implementar o completar todas las funciones p√∫blicas de las que ya has declarado el prototipo en el encabezado. Posteriormente completar√°s la ISR asociada al pin del bot√≥n que aparece en la API del fichero <code>interr.c</code>.</p>
<h3 id="fuentes-stm32f4_buttonc"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.3.1</span> Fuentes stm32f4_button.c<a class="headerlink" href="#fuentes-stm32f4_buttonc" title="Permanent link">¬∂</a></h3>
<ol>
<li>
<p>Incluye las librer√≠as necesarias, si falta alguna, seg√∫n indique la API.</p>
</li>
<li>
<p>Vamos a definir la <strong>variable global</strong> <code>stm32f4_button_hw_t buttons_arr\[\]</code> que se declar√≥ en el <code>.h</code>. Se trata de un array que no especifica el n√∫mero de elementos que tiene, pero cada uno ser√° de tipo <code>stm32f4_button_hw_t</code>, que representa al HW de cada bot√≥n que tengamos en nuestro sistema.</p>
<p>La declaraci√≥n e inicializaci√≥n de este array podemos hacerla a la vez, que ser√° lo m√°s aconsejable. Tambi√©n podr√≠amos hacer solo la declaraci√≥n e inicializar los valores de cada bot√≥n en una funci√≥n aparte ‚Äîque ahora mismo no tenemos definida‚Äî. Convendr√≠a recordar las secciones correspondientes de los v√≠deos de SDG1: <a href="https://youtu.be/U395gYoCHbQ?t=223">inicializaci√≥n de arrays</a> y <a href="https://youtu.be/X33jHui_l0k?t=378">arrays de estructuras</a>.</p>
<p>Asigna los valores del bot√≥n <code>PORT_USER_BUTTON_ID</code> utilizando los <code>#define</code> de <code>stm32f4_button.h</code>. Deber√° quedarte algo como lo de la <a href="#fig:buttons_array">figura de arrays</a>. Si tienes m√°s botones en el sistema, simplemente a√±adir√≠as una fila para cada bot√≥n con sus caracter√≠sticas correspondientes.</p>
<p></p><figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/buttons_array.png"><img alt="Array de botones con las caracter√≠sticas del bot√≥n de usuario." id="fig:buttons_array" src="../assets/notebook_imgs/pr_chapters/version_1/buttons_array.png" style="width:90.0%"/></a><figcaption aria-hidden="true">Array de botones con las caracter√≠sticas del bot√≥n de usuario.</figcaption></figure><p></p>
</li>
<li>
<p>Se os proporciona ya codificada la funci√≥n <code>_stm32f4_button_get()</code>. Se trata de una funci√≥n privada que devuelve un puntero a la estructura del bot√≥n que se le pasa como argumento. Esta funci√≥n, aunque prescindible, es √∫til para poder hacer un c√≥digo m√°s legible y acceder a los campos de la estructura del bot√≥n de forma m√°s sencilla desde otras funciones del fichero <code>stm32f4_button.c</code>. <strong>¬°Recuerda que esta funci√≥n es privada y por tanto debe aparecer codificada antes de cualquier funci√≥n que la utilice!</strong></p>
<p>Si el bot√≥n no existe, la funci√≥n devuelve <code>NULL</code>. Esto es habitual en funciones que devuelven punteros y es muy √∫til para detectar errores en la programaci√≥n.</p>
</li>
<li>
<p>Completa la funci√≥n <code>port_button_init()</code> como se indica en la API. F√≠jate c√≥mo la parte de c√≥digo proporcionada define la variable local <code>\*p_button</code> que nos permite acceder al bot√≥n. Tambi√©n podr√≠a haberse hecho con acceso directo al elemento del array de botones <code>buttons_arr\[button_id\]</code>, pero es m√°s elegante, seguro, y legible hacerlo con la funci√≥n <code>_stm32f4_button_get()</code>.</p>
<p><span style="color: Red">Recuerda que es muy importante indicar en el modo de la interrupci√≥n del bot√≥n que, <strong>adem√°s de detectar ambos flancos (subida y bajada), debe habilitar la petici√≥n de interrupci√≥n (registro <code>EXTI_IMR</code>)</strong></span>.</p>
</li>
<li>
<p>Codifica la funci√≥n p√∫blica declarada en el fichero <code>port_button.h</code> siguiendo la API: <code>port_button_get_pressed()</code>.</p>
<p><strong>¬°Ya hemos acabado con la implementaci√≥n de la parte HW <code>stm32f_button.c</code>!</strong> Ahora solo queda la ISR asociada al pin del bot√≥n para poder probarlo. Vamos a ello.</p>
</li>
</ol>
<h3 id="sec:interr_button"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.3.2</span> interr.c<a class="headerlink" href="#sec:interr_button" title="Permanent link">¬∂</a></h3>
<p>Abre el fichero <code>interr.c</code> e implementa la <a href="acronimos.html#acro:ISR"><strong>ISR</strong></a> <code>EXTI15_10_IRQHandler</code>. Hay que implementar la parte correspondiente a la <strong>Versi√≥n 1</strong> que indica la <a href="acronimos.html#acro:API"><strong>API</strong></a> solo.</p>
<ol>
<li>
<p>Copia este esqueleto en el documento:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">EXTI15_10_IRQHandler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* ISR user button */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EXTI</span><span class="o">-&gt;</span><span class="n">PR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIT_POS_TO_MASK</span><span class="p">(</span><span class="n">buttons_arr</span><span class="p">[</span><span class="n">PORT_USER_BUTTON_ID</span><span class="p">].</span><span class="n">pin</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>


<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Completa la ISR <code>EXTI15_10_IRQHandler</code> como se indica en la API.</p>
<p>Esta ISR es la misma para cualquier elemento que se conecte en las l√≠neas <code>10-15</code>, y por ello debe identificar cu√°l de ellas ha sido. Es por eso que tenemos la l√≠nea <code>EXTI-&gt;PR &amp; BIT_POS_TO_MASK(buttons_arr[PORT_USER_BUTTON_ID].pin)</code>, para asegurar que es el bot√≥n de usuario.</p>
<p>Esta l√≠nea comprueba si el bit de la posici√≥n del pin del bot√≥n est√° activo en el registro Pending Register <code>EXTI_PR</code>. Si es as√≠, es porque se ha producido una interrupci√≥n en el pin del bot√≥n. <strong>Es muy importante que borremos el flag de interrupci√≥n</strong> escribiendo un 1 en el bit correspondiente del registro <code>EXTI_PR</code>.</p>
<p>Debemos identificar si el flanco que ha producido la interrupci√≥n es de subida o bajada, pues el montaje HW de cada bot√≥n puede ser distinto.</p>
</li>
<li>
<p>Si queda algo por documentar puede ser buen momento ahora.</p>
</li>
</ol>
<p>Si ahora compila, el c√≥digo no deber√≠a tener ning√∫n error. <strong>¬°Ya hemos acabado con la implementaci√≥n de <em>portado</em> del bot√≥n!</strong>. Vamos a probarlo con el <em>test</em> unitario de la parte <code>PORT</code>.</p>
<h2 id="sec:test_port_v1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.4</span> <code>PORT</code>: Test unitario del bot√≥n<a class="headerlink" href="#sec:test_port_v1" title="Permanent link">¬∂</a></h2>
<p>Veremos que la l√≥gica de las m√°quinas de estado hacen uso de las funciones portables que acceden al HW del dispositivo. Es por ello que es importante comprobar primero que la parte <code>PORT</code> funciona correctamente. Vamos a hacer el test de HW del c√≥digo que hemos desarrollado de la librer√≠a del bot√≥n y probar que funciona antes de continuar con la implementaci√≥n de la l√≥gica de la parte de la FSM.</p>
<p><span style="color: Red"><strong>¬°Importante! Los test que se proporcionan comprueban solo algunos aspectos esenciales, pero no son exhaustivos. Es responsabilidad del alumno comprobar que el sistema final funciona correctamente.</strong></span> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/gen_book_icon.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/gen_book_icon.png"/></a>¬†Ten a mano y revisa el cap√≠tulo <em>‚ÄúTest unitarios y ejemplos de integraci√≥n‚Äù</em> del libro de fundamentos te√≥ricos¬†<sup id="fnref2:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup>.</p>
<p>En esta secci√≥n vamos a practicar con el concepto de <strong>depuraci√≥n</strong> (<em>debugging</em>) (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/gen_book_icon.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/gen_book_icon.png"/></a> <strong>recordar ejercicio de clase en SDG1 y las pruebas de la <em>Gu√≠a de instalaci√≥n<em> con </em>blink</em></strong>¬†<sup id="fnref:stm322025guiainstalacion"><a class="footnote-ref" href="#fn:stm322025guiainstalacion">7</a></sup>).</p>
<p>La herramienta m√°s importante y c√≥moda que tenemos para depurar es el <a href="acronimos.html#acro:IDE"><strong>IDE</strong></a> que usemos. En nuestro caso, como <em>VSCode</em> no es un <a href="acronimos.html#acro:IDE"><strong>IDE</strong></a> en s√≠ mismo, sino un editor de texto <em>vitaminado</em>, tenemos que usar extensiones. La extensi√≥n <em>Cortex-Debug</em> para <em>VSCode</em> es la que nos ayudar√° a depurar.</p>
<p>A veces no nos queda otra forma para depurar que imprimir texto por pantalla (cuando esta existe). Recuerde de la <em>Gu√≠a de instalaci√≥n</em>¬†<sup id="fnref2:stm322025guiainstalacion"><a class="footnote-ref" href="#fn:stm322025guiainstalacion">7</a></sup> que algunos dispositivos basados en ARM proporcionan una consola de <a href="acronimos.html#acro:ITM"><strong>ITM</strong></a>. ITM es una aplicaci√≥n de ARM que permite, entre otras cosas, el uso de la funci√≥n <code>printf()</code> en depuraci√≥n con la placa. Tambi√©n existen alternativas como el <em>semihosting</em>, que env√≠a mensajes a trav√©s de la pesta√±a de <em>Debug Console</em> de <em>VSCode</em>. Esta es la opci√≥n que tenemos configurada en nuestro proyecto. <strong>No hay que abusar de ellas, porque no vale para todo. Tendremos que acudir inevitablemente a ver los valores de los registros en alg√∫n momento.</strong> Bien es cierto que, una vez el proyecto est√° funcionando en producci√≥n, puede ser √∫til tener trazas (impresas, LEDs, ficheros de <em>log</em>‚Ä¶) para saber qu√© est√° pasando en caso de fallo.</p>
<p>Descarga el fichero de test HW del bot√≥n <code>test_port_button.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v1_test">https://github.com/sdg2DieUpm/simone/tree/simone_v1_test</a>. Ponlo en la carpeta <code>test/stm32f4</code> de tu proyecto. Puedes eliminar el fichero plantilla <code>test_template.c</code></p>
<ol>
<li>
<p>Conecta la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono de depuraci√≥n <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_debug.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_debug.png"/></a> y selecciona <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_run.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_run.png"/></a> Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>test_port_button</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Inmediatamente se habr√° parado en la primera l√≠nea del test. Contin√∫a la depuraci√≥n (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_continue.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_continue.png"/></a>) para ejecutar el test por completo, o pon puntos de parada si deseas ir paso a paso.</p>
</li>
<li>
<p>Se habr√° impreso por la terminal del <code>gdb-server</code> el resultado de las pruebas de los tests. Deber√≠a haber pasado todos los tests. Si no, lee el mensaje de error y corrige tu c√≥digo hasta que pasen todas las pruebas. <strong>Si no pasan las pruebas, no contin√∫es.</strong></p>
</li>
<li>
<p>La depuraci√≥n se queda en bucle en la instrucci√≥n <code>exit(UNITY_END())</code>. Para terminar la depuraci√≥n pulsa (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_stop.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_stop.png"/></a>) y repite el proceso hasta que pasen todos los test.</p>
<p>Si alg√∫n test genera una situaci√≥n de comportamiento inesperado, puede ser que no termine de ejecutarse. Comprueba d√≥nde se queda pausando la depuraci√≥n, y lee los mensajes de error que te proporciona el test.</p>
</li>
</ol>
<p>Un ejemplo de ejecuci√≥n del test se muestra en la <a href="#fig:test_port_button">ejecuci√≥n de test de la figura</a>. En este caso, la segunda comprobaci√≥n ha fallado indic√°ndonos que la GPIO elegida para el bot√≥n no es la correcta. Luego aparecen m√°s errores, pero son derivados de este. Corrigi√©ndolo, pasan todos los test correctamente. Por eso, se recomienda <strong>arreglar los errores en el orden en que aparecen</strong>.</p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/unit_test_port_button.png"><img alt="Ejecuci√≥n de los test unitarios de la parte `PORT` del bot√≥n." id="fig:test_port_button" src="../assets/notebook_imgs/pr_chapters/version_1/unit_test_port_button.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Ejecuci√≥n de los test unitarios de la parte `PORT` del bot√≥n.</figcaption></figure>
<p><strong>¬°Ya hemos acabado con la parte <code>PORT</code> del bot√≥n!</strong> Vamos ahora a implementar la parte <code>COMMON</code> de la librer√≠a del bot√≥n.</p>
<h2 id="common-cabecera-de-la-fsm-del-boton"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.5</span> <code>COMMON</code>: cabecera de la FSM del bot√≥n<a class="headerlink" href="#common-cabecera-de-la-fsm-del-boton" title="Permanent link">¬∂</a></h2>
<h3 id="sec:consideraciones_fsm_button"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.5.1</span> Consideraciones de la FSM del bot√≥n<a class="headerlink" href="#sec:consideraciones_fsm_button" title="Permanent link">¬∂</a></h3>
<p>Antes de empezar vamos a partir de una serie de consideraciones.</p>
<ul>
<li>
<p>La FSM <strong>almacena la duraci√≥n de la √∫ltima pulsaci√≥n de bot√≥n</strong>.</p>
</li>
<li>
<p>El usuario debe solicitar/¬†comprobar la duraci√≥n mediante la funci√≥n <code>fsm_button_get_duration()</code>.</p>
</li>
<li>
<p>El valor de inicio de duraci√≥n al arrancar la FSM, y el de reinicio, debe ser <span class="arithmatex">\(0 ms\)</span>.</p>
</li>
<li>
<p><strong>Un valor de <span class="arithmatex">\(0 ms\)</span> significa que no ha habido una nueva pulsaci√≥n del bot√≥n.</strong></p>
</li>
<li>
<p><strong>El usuario debe reiniciar el valor de duraci√≥n una vez le√≠do</strong>, de lo contrario, este valor puede ser malinterpretado por el usuario si se realizan sucesivas comprobaciones sin haber pulsado el bot√≥n. En tal caso estar√≠amos leyendo informaci√≥n del pasado. Para reiniciar el valor se debe llamar a la funci√≥n <code>fsm_button_reset_duration()</code>.</p>
<p>Visto de otro modo, <strong>el <em>‚Äúflag‚Äù</em> de estado de esta FSM es la variable duraci√≥n.</strong> Una duraci√≥n de 0 significa que no ha habido ninguna nueva pulsaci√≥n de bot√≥n. Un valor distinto de 0 representa que ha sido pulsado y el valor es su duraci√≥n. Es por tanto responsabilidad del usuario borrar este <em>‚Äúflag‚Äù</em> de estado.</p>
</li>
<li>
<p>La FSM contiene informaci√≥n del identificador (<code>ID</code>) del bot√≥n. Este <code>ID</code> es √∫nico y gestionado por el usuario en el <code>PORT</code>. Ah√≠ es donde el usuario proporciona identificadores e informaci√≥n HW (GPIO a la que est√° conectado y tiempo de anti-rebotes) para todos los botones de su sistema.</p>
</li>
</ul>
<figure><embed id="fig:fsm_boton" src="../assets/notebook_imgs/pr_chapters/version_1/fsm_button.png" style="width:140.0%"/><figcaption aria-hidden="true">M√°quina de estados del bot√≥n.</figcaption></figure>
<p>Nuestra librer√≠a implementa la l√≥gica de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> mostrada en la <a href="#fig:fsm_boton">FSM de la figura</a> y que llamaremos <code>fsm_button</code> (en los ficheros <code>.c</code> y <code>.h</code>). Tiene 4 estados porque <strong>implementa un mecanismo anti-rebotes SW</strong>. Los rebotes de bot√≥n o pulsaciones muy r√°pidas que duren menos que el <em>tiempo de anti-rebote</em> (<code>debounce_time</code>), se filtran. Los estados, como muestran la figura, son:</p>
<ul>
<li>
<p><code>BUTTON_RELEASED</code>: es el estado inicial de la FSM. En este estado la FSM est√° comprobando constantemente si se ha producido un flanco de bajada, <em>i.e.</em>, si se ha pulsado el bot√≥n. Cuando este se produce, guarda el instante actual y calcula el <em>timeout</em> del tiempo de guarda.</p>
</li>
<li>
<p><code>BUTTON_PRESSED_WAIT</code>: se queda esperando en este estado hasta que ha pasado el tiempo de guarda de anti-rebotes, <em>i.e.</em>, hasta que el instante actual es mayor que el <em>timeout</em>. Este es el anti-rebote de bajada. Al salir, no hace nada (funci√≥n, <code>NULL</code>).</p>
</li>
<li>
<p><code>BUTTON_PRESSED</code>: en este estado se queda mientras no se suelte el bot√≥n. Saldr√° de √©l cuando se haya detectado un flanco de subida. Ya ha pasado el tiempo de guarda, por lo que si es un rebote, se detectar√° como falso (ver ). Cuando el flanco de subida se produce, se calcula la duraci√≥n de la pulsaci√≥n.</p>
</li>
<li>
<p><code>BUTTON_RELEASED_WAIT</code>: se queda esperando en este estado hasta que ha pasado el tiempo de guarda de anti-rebotes, <em>i.e.</em>, hasta que el instante actual es mayor que el <em>timeout</em>. Este es el anti-rebote de subida. Al salir, no hace nada (funci√≥n, <code>NULL</code>).</p>
</li>
</ul>
<p>La parte <code>COMMON</code> de nuestra librer√≠a trabaja con la estructura (<code>struct</code>) <strong>p√∫blica</strong> que se muestra en la <a href="#fig:fsm_button_t">figura (b) de estructuras</a>. Con <strong>p√∫blica</strong> queremos decir que est√° declarada en el fichero <code>.h</code> y no el el <code>.c</code>, por lo que otros ficheros pueden declarar variables de este tipo.</p>
<ol>
<li>
<p>Lo primero, descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte COMMON</strong> de la librer√≠a del <em>bot√≥n</em> correspondientes a la versi√≥n <code>V1</code>: <a href="https://github.com/sdg2DieUpm/Simone/tree/simone_v1">https://github.com/sdg2DieUpm/Simone/tree/simone_v1</a>. Solo descarga lo que faltaba por implementar, es decir, los ficheros <code>fsm_button.h</code> y <code>fsm_button.c</code> y ponlos en las carpetas correspondientes de tu proyecto.</p>
<p>Ahora, vamos a completar la cabecera de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> del bot√≥n, <code>fsm_button.h</code>.</p>
</li>
<li>
<p>Incluye las librer√≠as necesarias, si falta alguna, seg√∫n indique la API.</p>
</li>
<li>
<p>Ahora vamos a definir el enumerado con los nombres de los 4 estados de la FSM. Escribe un <code>enum</code> <code>FSM_BUTTON</code> con los nombres de los estados del diagrama de la separados por <code>,</code>. No olvides poner un <code>;</code> al final del <code>enum</code>.</p>
</li>
<li>
<p>Seguidamente <strong>declararemos</strong> la estructura <code>fsm_button_t</code> para hacerla p√∫blica como indica la <a href="#fig:fsm_button_t">figura de la estructura de la FSM</a>.</p>
</li>
<li>
<p>Es buen momento para aprovechar a documentar la estructura, del mismo modo que se hizo anteriormente y se muestra en <a href="#fig:doxygen_struct">la figura de comentario</a>.</p>
<p></p><figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/doxygen_struct.png"><img alt="Comentario de Doxygen en un campo de una estructura." id="fig:doxygen_struct" src="../assets/notebook_imgs/pr_chapters/version_1/doxygen_struct.png" style="width:75.0%"/></a><figcaption aria-hidden="true">Comentario de Doxygen en un campo de una estructura.</figcaption></figure><p></p>
<p>Continuamos con las declaraciones de funciones p√∫blicas de la librer√≠a. <strong>Procedamos</strong>:</p>
</li>
<li>
<p>Escribe los prototipos de las <strong>funciones p√∫blicas</strong> que aparecen en la API del fichero <code>fsm_button.h</code>.</p>
<p>Como puedes intuir, estas no son todas las funciones de la librer√≠a, sino solo aquellas que podr√°n ser llamadas desde el exterior. Hemos establecido un criterio general por el que diremos que, si una funci√≥n va a ser accesible desde el exterior, el nombre de la funci√≥n debe empezar por <code>fsm_</code>.</p>
</li>
<li>
<p>Puede ser buen momento ahora para documentar las funciones con Doxygen. En este caso, la documentaci√≥n va encima del nombre de cada funci√≥n.</p>
</li>
</ol>
<p>Ya hemos acabado con el encabezado. Quiz√°s de errores al compilar. Vamos ahora a programar el fichero fuente <code>fsm_button.c</code>.</p>
<h2 id="sec:fsm_button_c"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.6</span> <code>COMMON</code>: fuente de la FSM del bot√≥n<a class="headerlink" href="#sec:fsm_button_c" title="Permanent link">¬∂</a></h2>
<p>Vamos a proceder con la implementaci√≥n de las funciones del <em>bot√≥n</em>. Deber√°s implementar todas las <strong>funciones p√∫blicas</strong> de las que ya has declarado el prototipo en el encabezado, y el resto de <strong>funciones privadas</strong> que aparecen en la API del fichero <code>fsm_button.c</code>. Tambi√©n definiremos las variables globales y estructuras que sean necesarias. <strong>¬°Recuerda que las funciones privadas no se declaran en el <code>.h</code>!</strong></p>
<ol>
<li>
<p>Lo primero que debe aparecer es la inclusi√≥n de cabeceras; en nuestro caso <code>fsm_button.h</code>, <code>port_button.h</code>, y <code>port_system.h</code> como indica la API.</p>
<p>Ahora empezamos a codificar las <strong>funciones privadas de la FSM</strong>. <strong>Empezaremos con las funciones de entrada o comprobaci√≥n de la FSM</strong>. Hemos establecido un criterio general por el que, <strong>si una funci√≥n es de entrada o comprobaci√≥n, ser√° privada y est√°tica, y el nombre de la funci√≥n va empezar por <code>check_</code></strong> (porque comprueba la condici√≥n de salto de la m√°quina de estados). Es muy importante aqu√≠ que hayas entendido bien los ejemplos con FSM de los tutoriales <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/gen_book_icon.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/gen_book_icon.png"/></a> <em>‚ÄúCap√≠tulo 2. Introducci√≥n a las m√°quinas de estados en C‚Äù</em> y <em>‚ÄúCap√≠tulo 3. M√°quinas de Estados Combinadas‚Äù</em>.</p>
<div class="admonition danger">
<p class="admonition-title">IMPORTANTE</p>
<p>Si te fijas en la API, todas las funciones de la m√°quina de estados reciben el mismo argumento: <code>fsm_t*</code>, un puntero a una m√°quina de estados.</p>
<p><code>fsm_button_t *p_fsm = (fsm_button_t *)(p_this);</code></p>
<p>Esto es asƒ±ÃÅ porque la librerƒ±ÃÅa <code>fsm.c</code> no sabe qu√© tipo de m√°quina de estados es. Nosotros sabemos que esta m√°quina de estados es una m√°quina con esteroides porque incluye, adem√°s, la estructura del bot√≥n. En realidad es tipo <code>fsm_button_t*</code>, un puntero a una m√°quina de estados de la estructura del bot√≥n, que por tener en su primer campo una <code>fsm_t*</code>, podemos hacer un cast y convertirla. Asƒ±ÃÅ pues, <strong>en las funciones de la m√°quina de estados, siempre tendremos que recuperar nuestro tipo haciendo este <em>cast</em></strong> como nos dice la API y hace, por ejemplo, la funci√≥n <code>fsm_button_init()</code>. <strong>En el resto de funciones que no se pasen a la librerƒ±ÃÅa <code>fsm.c</code>, trabajaremos directamente con el tipo <code>fsm_button_t*</code> que hemos creado.</strong></p>
</div>
</li>
<li>
<p>Codifica la funci√≥n <code>check_button_pressed()</code> como se indica en la API.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>check_button_released()</code> como se indica en la API.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>check_timeout()</code> como se indica en la API.</p>
</li>
<li>
<p>Puede ser buen momento ahora para documentar las funciones con Doxygen. En este caso, como las funciones no est√°n declaradas en el encabezado, la documentaci√≥n ir√° en el <code>.c</code>, encima del nombre de cada funci√≥n.</p>
<p><strong>Seguiremos con las funciones de salida o actualizaci√≥n de la FSM</strong>. Hemos establecido el criterio de que, <strong>una funci√≥n de salida o actualizaci√≥n ser√° privada y est√°tica, y el nombre de la funci√≥n empezar√° por <code>do_</code></strong> (porque va a hacer algo). Hay veces que no hay que hacer nada, por lo que para la librer√≠a <code>fsm.c</code> ser√° suficiente que apunte a <code>NULL</code>. Esto en el diagrama de la se ha representado como <span style="color: Green"><code>n/a</code></span>.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>do_store_tick_pressed()</code> como se indica en la API.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>do_set_duration()</code> como se indica en la API.</p>
</li>
<li>
<p>Documenta las funciones con Doxygen. En este caso, igual que antes, la documentaci√≥n ir√° en el <code>.c</code>, encima del nombre de cada funci√≥n.</p>
<p></p><figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_1/compile_error_3.png"><img alt="Error de compilaci√≥n durante el desarrollo de &lt;code&gt;fsm_button.c&lt;/code&gt;." id="fig:compile_error_3" src="../assets/notebook_imgs/pr_chapters/version_1/compile_error_3.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Error de compilaci√≥n durante el desarrollo de <code>fsm_button.c</code>.</figcaption></figure><p></p>
<p>Todav√≠a no hemos acabado con el desarrollo, pero vamos a compilar para ir depurando errores. Compile el programa. Ver√° errores parecidos a los que se muestran en la <a href="#fig:compile_error_3">figura de error</a>. El compilador a veces nos da alguna sugerencia de correcci√≥n, pero no tienen por qu√© ser correctas. Nos dice que:</p>
<ul>
<li>
<p>Hay una variable que no est√° declarada y que se llama <code>fsm_trans_button</code>. Se trata de la tabla de transiciones. A√∫n tenemos que escribirla.</p>
</li>
<li>
<p>Todas nuestras funciones <code>check_</code> y <code>do_</code> est√°n declaradas pero no se usan.</p>
<p>¬øPor qu√© no dice lo mismo de las funciones p√∫blicas que est√°n declaradas en el <code>.h</code> y tampoco se usan? Pues porque son p√∫blicas. El compilador no sabe qui√©n las podr√° usar y ah√≠ est√°n declaradas para qui√©n la pueda llamar. ¬øPor qu√© en el <code>.c</code> da error? Porque en el <code>Makefile</code> ‚Äîdonde est√°n las reglas de compilaci√≥n‚Äî, igual que tenemos el <em>flag</em> para que nos d√© error si la variable no se usa, lo mismo pasa con las funciones. Esto es √∫til para evitar generar c√≥digos sucios con funciones que no sirven.</p>
<p>¬øQui√©n va a usar las funciones de la m√°quina de estados? Pues las va a usar, mediante indirecci√≥n, la librer√≠a <code>fsm.c</code>. ¬øC√≥mo? Porque le vamos a pasar a la funci√≥n <code>fsm_fire()</code> la tabla de transiciones. Y es ah√≠, donde vamos a ‚Äúusar‚Äù estas funciones. ¬øY d√≥nde se llama a <code>fsm_fire</code>? Ya lo haremos, pero se hace en <code>fsm_button_fire()</code>, que a su vez es llamada por el <code>main</code>.</p>
</li>
<li>
<p>Si las us√°semos, aparecer√≠a el error de que hay funciones que no est√°n declaradas (<em>implicit declaration</em>). Son las llamadas a funciones del <code>PORT</code>, que m√°s tarde codificaremos.</p>
</li>
</ul>
<p>Mucha informaci√≥n hasta ahora, pero ver√° c√≥mo se aclara todo enseguida. <strong>Vamos a codificar la tabla (array) de transiciones de la FSM del <em>bot√≥n</em></strong>.</p>
</li>
<li>
<p>Definimos <code>static fsm_trans_t fsm_trans_button\[\] = ...</code> justo despu√©s de la funci√≥n <code>do_set_duration()</code>.</p>
<p>Recuerda que cada fila de la tabla de transiciones tiene la forma: <code>EstadoIni, FuncCompruebaCondicion, EstadoSig, FuncAccionesSiTransicion</code>. No olvides a√±adir la fila <code>-1, NULL, -1, NULL</code> que sirve a la librer√≠a <code>fsm.c</code> para detectar el fin de la tabla.</p>
<p><span style="color: Red">¬øPor qu√© es importante haber colocado la tabla en este punto? Bueno, puede ser en cualquier punto despu√©s de las funciones <code>check_</code> y <code>do_</code>, porque de lo contrario, de estar m√°s arriba, al compilar, la tabla de transiciones estar√≠a haciendo referencia a funciones que todav√≠a no se sabe que existen (¬°porque son privadas y no est√°n en el <code>.h</code>!).</span></p>
<p>Si ahora compilas, ver√°s que han desaparecido muchos errores. Ya queda menos para acabar la implementaci√≥n de la librer√≠a de la m√°quina de estados. Prosigamos:</p>
</li>
<li>
<p>Codifica la funci√≥n <code>fsm_button_get_duration()</code> como se indica en la API. Esta funci√≥n nos servir√° en el programa principal para preguntar cu√°nto tiempo ha durado la pulsaci√≥n.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>fsm_button_reset_duration()</code> como se indica en la API. Con esta, reiniciaremos el valor de la duraci√≥n a <span class="arithmatex">\(0 ms\)</span> tras leerlo.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>fsm_button_get_debounce_time_ms()</code> como se indica en la API. Esta funci√≥n ser√° usada en los test unitarios.</p>
</li>
<li>
<p>Completa la funci√≥n <code>fsm_button_init()</code> como se indica en la API.</p>
<p>F√≠jate en las funciones <code>fsm_button_fire()</code> dada, que implementaremos tambi√©n sucesivas versiones. Esta funci√≥n sirve para lanzar la <em>m√°quina de estados</em> (<code>f</code>). Ser√° usadas en el test unitario de la m√°quina de estados, en e√± <code>main.c</code>, y son √∫tiles para depurar.</p>
<p><strong>Ya hemos acabado con la programaci√≥n de la librer√≠a del bot√≥n.</strong> Toda esta l√≥gica <code>COMMON</code> <strong>puede ser usada en cualquier sistema</strong>, est√© basado en microcontrolador, o sea un PC. Hemos hecho una librer√≠a de un bot√≥n que tiene un anti-rebotes y nos devuelve la duraci√≥n de la √∫ltima pulsaci√≥n. As√≠ pues, si compilas, no deber√°n aparecer errores.</p>
</li>
<li>
<p>Documenta el c√≥digo que est√© sin comentar.</p>
</li>
</ol>
<h2 id="sec:test_fsm_v1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7</span> <code>COMMON</code> Test unitario de la FSM del bot√≥n<a class="headerlink" href="#sec:test_fsm_v1" title="Permanent link">¬∂</a></h2>
<p>Vamos a probar el test del c√≥digo que hemos desarrollado de la librer√≠a de la m√°quina de estados del bot√≥n y probar que funciona antes de continuar con la siguiente versi√≥n.
<span style="color: Red"><strong>¬°Importante! Recuerda que los test que se proporcionan comprueban solo algunos aspectos esenciales, pero no son exhaustivos. Es responsabilidad del alumno comprobar que el sistema final funciona correctamente.</strong></span></p>
<p>Descarga el fichero de test de la FSM del bot√≥n <code>test_fsm_button.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v1_test">https://github.com/sdg2DieUpm/simone/tree/simone_v1_test</a>. Ponlo en la carpeta <code>test/</code> de tu proyecto. <strong>¬°No lo metas en stm32f4/, pues no es un test espec√≠fico del microcontrolador!</strong></p>
<ol>
<li>
<p>Con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†conectada al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>test_fsm_button</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Ejecuta el test por completo, o pon puntos de parada si deseas ir paso a paso.</p>
</li>
<li>
<p>Se habr√° impreso por la terminal del <code>gdb-server</code> el resultado de las pruebas de los tests. Deber√≠a haber pasado todos los tests. Si no, lee el mensaje de error y corrige tu c√≥digo hasta que pasen todas las pruebas. <strong>Si no pasan las pruebas, no contin√∫es.</strong></p>
</li>
<li>
<p>Termina la depuraci√≥n pulsando (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_stop.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_stop.png"/></a>) y repite el proceso hasta que pasen todos los test.</p>
</li>
</ol>
<h2 id="ejemplo-de-uso-de-la-version-1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8</span> Ejemplo de uso de la Versi√≥n 1<a class="headerlink" href="#ejemplo-de-uso-de-la-version-1" title="Permanent link">¬∂</a></h2>
<p><strong>Com√∫nmente llamado test de integraci√≥n, es un c√≥digo de ejemplo que consiste en probar la librer√≠a en el sistema final, o en una versi√≥n particular, con el resto de librer√≠as y m√≥dulos</strong>. El test de integraci√≥n no hace uso de la librer√≠a <code>unity</code>, sino que es como un peque√±o programa de prueba sobre las funciones que hemos implementado. Tiene su propio <code>main</code>.</p>
<p>En los test de integraci√≥n es responsabilidad del alumno comprobar que la funcionalidad es la esperada, porque aqu√≠ no hay test unitarios que nos ayuden.</p>
<p>Nuestra librer√≠a de bot√≥n devuelve la duraci√≥n de la √∫ltima pulsaci√≥n. As√≠ pues, algunas de las comprobaciones que podemos hacer son: que la duraci√≥n de la pulsaci√≥n es la que esperamos, que se reinicia adecuadamente el valor, que funciona el anti-rebotes‚Ä¶</p>
<p>Descarga el fichero de ejemplo <code>example_v1.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v1_test">https://github.com/sdg2DieUpm/simone/tree/simone_v1_test</a>. Ponlo en la carpeta <code>example/</code> de tu proyecto.</p>
<p><strong>Procedamos</strong>:</p>
<ol>
<li>
<p>Con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†conectada al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono de depuraci√≥n <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_debug.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_debug.png"/></a> y selecciona <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_run.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_run.png"/></a> Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>example_v1</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Se parar√° en la primera l√≠nea del <code>main()</code>. Ejecuta el test por completo, o pon puntos de parada si deseas ir paso a paso. Este c√≥digo no termina, pues es un bucle <code>while</code> infinito.</p>
</li>
<li>
<p>Abre la terminal del <code>gdb-server</code> para ver los mensajes que se van imprimiendo.</p>
</li>
<li>
<p>Pulsa el bot√≥n de usuario <code>B1</code> de la placa. Deber√≠as ver que se imprime por pantalla la duraci√≥n de la pulsaci√≥n. Si no es as√≠, revisa tu c√≥digo.</p>
</li>
<li>
<p>Haz distintas pruebas y aseg√∫rate de que el comportamiento es el adecuado.</p>
</li>
</ol>
<p>¬°Hemos creado nuestra primera librer√≠a! F√≠jate que es <em>portable</em> a cualquier plataforma solo con adaptar las funciones del <code>PORT</code>.</p>
<p>No dejes de documentar el c√≥digo. <strong>Comprueba que la documentaci√≥n del c√≥digo se ha generado correctamente como se explica en la <em>‚ÄúGu√≠a de instalaci√≥n de herramientas para compilaci√≥n multiplataforma en C‚Äù</em>¬†<sup id="fnref3:stm322025guiainstalacion"><a class="footnote-ref" href="#fn:stm322025guiainstalacion">7</a></sup>.</strong>, o en el v√≠deo <a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">"[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen‚Äù</a>.</p>
<p>Guarda una copia de su proyecto como <code>simone_v1</code> para tener un punto de partida para la siguiente versi√≥n, y una copia de seguridad por si algo falla.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>No nos hacemos responsables de posibles da√±os que puedas ocasionar¬†.¬†<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">‚Ü©</a></p>
</li>
<li id="fn:2">
<p>Se recomienda documentar sus c√≥digos siempre en ingl√©s, aunque su nivel no sea muy bueno, porque si trabajamos en una empresa, no sabemos qui√©n lo tendr√° que leer.¬†<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025fundamentos">
<p>Josu√© Pag√°n Ortiz, Pedro Jos√© Malag√≥n Marzo, Rom√°n C√°rdenas Rodr√≠guez, and Juan Jos√© G√≥mez Valverde. <em>Fundamentos te√≥ricos de sistemas basados en microcontrolador STM32. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Josu√© Pag√°n Ortiz, Madrid, March 2025. URL: <a href="https://oa.upm.es/88460/">https://oa.upm.es/88460/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref2:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref3:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021datasheet">
<p>STMicroelectronics. Stm32f446xc/e. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/datasheet/stm32f446re.pdf">https://www.st.com/resource/en/datasheet/stm32f446re.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021datasheet" title="Jump back to footnote 4 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021reference">
<p>STMicroelectronics. Rm0390 reference manual. stm32f446xx advanced arm-based 32-bit mcus. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021reference" title="Jump back to footnote 5 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025tutoriales">
<p>Rom√°n C√°rdenas Rodr√≠guez, Josu√© Pag√°n Ortiz, Alberto Bosc√° Mojena, Iv√°n Mart√≠n Fern√°ndez, and Sergio Esteban Romero. <em>Tutoriales sobre los fundamentos te√≥ricos de sistemas basados en microcontrolador STM32. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Rom√°n C√°rdenas Rodriguez, Madrid, March 2025. URL: <a href="https://oa.upm.es/88470/">https://oa.upm.es/88470/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025tutoriales" title="Jump back to footnote 6 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025guiainstalacion">
<p>Josu√© Pag√°n Ortiz, Pedro Jos√© Malag√≥n Marzo, Rom√°n C√°rdenas Rodr√≠guez, Amadeo de Gracia Herranz, Sergio Esteban Romero, and Daniel Capell√°n Mart√≠n. <em>Gu√≠a de instalaci√≥n de herramientas para compilaci√≥n multiplataforma en C. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Josu√© Pag√°n Ortiz, Madrid, March 2025. URL: <a href="https://oa.upm.es/92376/">https://oa.upm.es/92376/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025guiainstalacion" title="Jump back to footnote 7 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref2:stm322025guiainstalacion" title="Jump back to footnote 7 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref3:stm322025guiainstalacion" title="Jump back to footnote 7 in the text">‚Ü©</a></p>
</li>
</ol>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Volver al principio
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
<script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>