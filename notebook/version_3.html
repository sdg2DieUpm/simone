<!DOCTYPE html>
<html class="no-js" lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://sdg2dieupm.github.io/simone/notebook/version_3.html" rel="canonical"/>
<link href="version_2.html" rel="prev"/>
<link href="version_4.html" rel="next"/>
<link href="../assets/notebook_imgs/general/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Versi√≥n 3 - Laboratorio de Sistemas Digitales II</title>
<link href="../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/notebook-extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
<body data-md-color-accent="deep_orange" data-md-color-primary="blue_grey" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cha:version3">
          Saltar a contenido
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Cabecera" class="md-header__inner md-grid">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-header__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Laboratorio de Sistemas Digitales II
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Versi√≥n 3
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Cambiar a modo oscuro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Cambiar a modo oscuro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Cambiar a modo claro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Cambiar a modo claro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="B√∫squeda" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="B√∫squeda" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Buscar" class="md-search__options">
<button aria-label="Limpiar" class="md-search__icon md-icon" tabindex="-1" title="Limpiar" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navegaci√≥n" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-nav__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
    Laboratorio de Sistemas Digitales II
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../index.html">
<span class="md-ellipsis">
    Portada
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Introducci√≥n general
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introducci√≥n general
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="intro.html">
<span class="md-ellipsis">
    Introducci√≥n a SDG2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="sesion_introduccion.html">
<span class="md-ellipsis">
    Sesi√≥n de introducci√≥n
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    Proyecto
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Proyecto
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="version_0.html">
<span class="md-ellipsis">
    Versi√≥n 0
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_1.html">
<span class="md-ellipsis">
    Versi√≥n 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_2.html">
<span class="md-ellipsis">
    Versi√≥n 2
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Versi√≥n 3
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="version_3.html">
<span class="md-ellipsis">
    Versi√≥n 3
    
  </span>
</a>
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:rgb_colors">
<span class="md-ellipsis">
      Colores RGB predefinidos
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_rgb_light">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_rgb_light">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v3">
<span class="md-ellipsis">
      PORT: Test unitario del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-rgb-light">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-fuente-de-la-fsm-del-rgb-light">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v3">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-3">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 3
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_4.html">
<span class="md-ellipsis">
    Versi√≥n 4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_5.html">
<span class="md-ellipsis">
    Versi√≥n 5
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    API
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            API
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/index.html">
<span class="md-ellipsis">
    Documentaci√≥n API
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    Ap√©ndices
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Ap√©ndices
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="bom.html">
<span class="md-ellipsis">
    BOM
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Acr√≥nimos
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="acronimos.html">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../pdf/manual_simone.pdf">
<span class="md-ellipsis">
    üì• Descargar como PDF
    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:rgb_colors">
<span class="md-ellipsis">
      Colores RGB predefinidos
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_rgb_light">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_rgb_light">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v3">
<span class="md-ellipsis">
      PORT: Test unitario del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-rgb-light">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-fuente-de-la-fsm-del-rgb-light">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v3">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del RGB light
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-3">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 3
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cha:version3"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.</span> Versi√≥n 3: <em>RGB light</em><a class="headerlink" href="#cha:version3" title="Permanent link">¬∂</a></h1>
<p>Ya tenemos una librer√≠a que nos permite tener botones que funcionan aut√≥nomamente mediante <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a>. De ella hemos creado un bot√≥n que nos permitir√° encender y apagar el juego Simone. Adem√°s, hemos creado una librer√≠a que nos permite crear teclados matriciales, tambi√©n gestionados mediante <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a>. De esta √∫ltima, hemos creado un teclado que permitir√° al jugador introducir la secuencia de colores en cada turno.</p>
<div class="admonition example">
<p class="admonition-title">Bibliograf√≠a</p>
<ol>
<li>
<p><em>"Fundamentos te√≥ricos de sistemas basados en microcontrolador STM32‚Äù</em>¬†<sup id="fnref5:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">1</a></sup></p>
</li>
<li>
<p><em>Datasheet "STM32F446xC/E‚Äù</em>¬†<sup id="fnref6:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup></p>
</li>
<li>
<p><em>Reference manual "RM0390. STM32F446xx advanced Arm-based 32-bit MCUs‚Äô</em>¬†<sup id="fnref:st2021reference"><a class="footnote-ref" href="#fn:st2021reference">3</a></sup></p>
</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title"><a href="https://www.youtube.com/channel/UCYIw_gl745WMJ1n0MamDzQw/">V√≠deos del canal de SDGII</a></p>
<ul>
<li>
<p><a href="https://youtu.be/v-HXdcEtT_4">Demostraci√≥n Simone</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLTFFovUxjNnn19myGVw1kwh6GPbRxwIcC">Conceptos b√°sicos de C (canal SDG1)</a></p>
</li>
<li>
<p><a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">"[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen‚Äù</a></p>
</li>
</ul>
</div>
<p>En este cap√≠tulo vamos a crear una librer√≠a que nos permita mostrar un <a href="acronimos.html#acro:LED"><strong>LED</strong></a> <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†donde cada color estar√° controlado por una se√±al <a href="acronimos.html#acro:PWM"><strong>PWM</strong></a>. Este elemento que llamaremos <em>RGB light</em> nos permitir√° mostrar (i) los colores de la secuencia que tiene que replicar el usuario, y (ii) dar <em>feedback</em> visual al jugador cada vez que pulse una tecla.</p>
<p>Como ya hicimos en las versiones anteriores, (i) vamos a implementar la parte <em>portable</em> <code>PORT</code> dependiente del <a href="acronimos.html#acro:HW"><strong>HW</strong></a> para comunicarnos con el LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>, y lo probaremos con un test unitario. (ii) Despu√©s, vamos a crear la l√≥gica de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> para gestionar las secuencias del juego con los distintos colores (la parte <code>COMMON</code>), y lo probaremos con un test unitario. (iii) Por √∫ltimo, montaremos el <a href="acronimos.html#acro:HW"><strong>HW</strong></a> y probaremos el funcionamiento del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†con un programa de ejemplo.</p>
<p>Cuando lea esta introducci√≥n conviene que lea y entienda el cap√≠tulo <em>"Circuito de reloj‚Äù</em> del libro¬†<sup id="fnref:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">1</a></sup>, prestando especial atenci√≥n al ejemplo proporcionado sobre PWM.</p>
<p>Cada uno de los LED (<span style="color: red; font-weight: bold;">R</span>, <span style="color: green; font-weight: bold;">G</span>, y <span style="color: blue; font-weight: bold;">B</span>) del LED estar√° conectado a una GPIO del <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. Los tres LED est√°n controlados por el mismo temporizador en modo <a href="acronimos.html#acro:PWM"><strong>PWM</strong></a>, pero cada uno con un canal de dicho temporizador. La se√±al <a href="acronimos.html#acro:PWM"><strong>PWM</strong></a> es una se√±al cuadrada que tiene un periodo fijo y un ciclo de trabajo variable. Si el ciclo de trabajo es del 100\%, el LED estar√° a m√°xima intensidad, y si es del 0\%, el LED estar√° apagado. Las caracter√≠sticas a destacar del sistema de la Versi√≥n 3 se muestran en la <a href="#tbl:version3_rgb">siguiente tabla</a>.</p>
<div id="tbl:version3_rgb"></div>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong>Par√°metro</strong></th>
<th style="text-align: center;"><strong>Valor</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Pin LED rojo</td>
<td style="text-align: center;"><code>PB6</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin LED verde</td>
<td style="text-align: center;"><code>PB8</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin LED azul</td>
<td style="text-align: center;"><code>PB9</code></td>
</tr>
<tr>
<td style="text-align: left;">Modo</td>
<td style="text-align: center;">Alternativo</td>
</tr>
<tr>
<td style="text-align: left;">Pull up/ down</td>
<td style="text-align: center;">Sin pull</td>
</tr>
<tr>
<td style="text-align: left;">Temporizador (para todos los colores)</td>
<td style="text-align: center;"><code>TIM4</code></td>
</tr>
<tr>
<td style="text-align: left;">Canal LED rojo</td>
<td style="text-align: center;">(ver la tabla de Funci√≥n Alternativa en el datasheet<sup id="fnref5:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup>)</td>
</tr>
<tr>
<td style="text-align: left;">Canal LED verde</td>
<td style="text-align: center;">(ver la tabla de Funci√≥n Alternativa en el datasheet<sup id="fnref4:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup>)</td>
</tr>
<tr>
<td style="text-align: left;">Canal LED azul</td>
<td style="text-align: center;">(ver la tabla de Funci√≥n Alternativa en el datasheet<sup id="fnref3:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup>)</td>
</tr>
<tr>
<td style="text-align: left;">Modo PWM</td>
<td style="text-align: center;">Modo PWM 1</td>
</tr>
<tr>
<td style="text-align: left;">Prescaler</td>
<td style="text-align: center;">(Calcular para frecuencia de 50 Hz)</td>
</tr>
<tr>
<td style="text-align: left;">Periodo</td>
<td style="text-align: center;">(Calcular para frecuencia de 50 Hz)</td>
</tr>
<tr>
<td style="text-align: left;">Ciclo de trabajo LED rojo</td>
<td style="text-align: center;">(variable, depende del color a mostrar)</td>
</tr>
<tr>
<td style="text-align: left;">Ciclo de trabajo LED verde</td>
<td style="text-align: center;">(variable, depende del color a mostrar)</td>
</tr>
<tr>
<td style="text-align: left;">Ciclo de trabajo LED azul</td>
<td style="text-align: center;">(variable, depende del color a mostrar)</td>
</tr>
</tbody>
</table>
<p>Un color se representa en el <a href="acronimos.html#acro:LED"><strong>LED</strong></a> <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span> mediante la combinaci√≥n de los tres colores b√°sicos: rojo, verde y azul. La combinaci√≥n de los tres colores b√°sicos en diferentes proporciones nos permite obtener una amplia gama de colores. La intensidad la controla el ciclo de trabajo (canal del temporizador), pero la frecuencia para los tres colores ser√° la misma. La frecuencia de la se√±al PWM ser√° de <span class="arithmatex">\(50 Hz\)</span>, valor lo suficientemente alto para que no se perciba el parpadeo de los LED. Nuestro ojo integrar√° esos trenes de pulsos y lo veremos como un color determinado. <strong>Si se cambia el ciclo de trabajo, estaremos controlando la intensidad de cada LED, y por tanto el color mostrado.</strong></p>
<p>¬øCu√°ndo cambiaremos los valores del ciclo de trabajo? Pues depende de la intensidad calculada de forma aleatoria seg√∫n el nivel de dificultad del juego. Cuanto m√°s dif√≠cil sea el nivel, m√°s parecidos ser√°n los colores (menor intensidad), y por tanto m√°s dif√≠cil ser√° para el usuario distinguirlos.</p>
<p><a href="#tbl:rgb_colors">La tabla de colores</a> muestra los colores que se usar√°n en el juego y los valores de ciclo de trabajo asociados a cada color <strong>para m√°xima intensidad en tanto por ciento</strong>. Los colores est√°n definidos en la librer√≠a que se proporciona <code>rgb_colors.c</code> de la parte <code>COMMON</code>, y que mencionaremos m√°s adelante.</p>
<div id="tbl:rgb_colors"></div>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Color</strong></th>
<th style="text-align: center;"><strong>LED rojo</strong></th>
<th style="text-align: center;"><strong>LED verde</strong></th>
<th style="text-align: center;"><strong>LED azul</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Rojo</td>
<td style="text-align: center;"><span class="arithmatex">\(100~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Verde</td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(100~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Azul</td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(100~\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Amarillo</td>
<td style="text-align: center;"><span class="arithmatex">\(37~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(37~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Turquesa</td>
<td style="text-align: center;"><span class="arithmatex">\(10~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(35~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(32~\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Blanco</td>
<td style="text-align: center;"><span class="arithmatex">\(100~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(100~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(100~\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Apagado</td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0~\%\)</span></td>
</tr>
</tbody>
</table>
<p>En la <a href="version_5.html">Versi√≥n 5</a> puedes implementar otros colores. Tienes una lista de colores en la <a href="https://www.downtownuplighting.com/rgb-color-chart">www.downtownuplighting.com</a>‚Äîaunque no todos se pueden mostrar en un LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>.</p>
<p>La <a href="#fig:pwm_colors">figura</a> muestra un ejemplo de se√±al PWM para un color amarillento (que no el amarillo de <a href="#tbl:rgb_colors">la tabla</a>. Se muestran en el osciloscopio dos de los LED del <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>. En la parte superior se muestra el canal de osciloscopio para el LED rojo, y en la parte inferior el canal de osciloscopio para el LED verde. F√≠jate que el periodo de la se√±al PWM es el mismo para los dos LED (<span class="arithmatex">\(20 ms\)</span>), pero el ciclo de trabajo es distinto: <span class="arithmatex">\(20.8\%\)</span> para el LED rojo y <span class="arithmatex">\(36.6\%\)</span> para el LED verde.</p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_3/pwm_colors.png"><img alt="Ejemplo de se√±ales PWM para un color amarillento." id="fig:pwm_colors" src="../assets/notebook_imgs/pr_chapters/version_3/pwm_colors.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Ejemplo de se√±ales PWM para un color amarillento.</figcaption></figure>
<p>Igual que hemos hecho hasta ahora, <strong>estamos desarrollando una librer√≠a.</strong> As√≠, cada vez que se quiera a√±adir un LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†le asociaremos una <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a>. Las particularidades de d√≥nde est√° conectado cada nuevo LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>, sus caracter√≠sticas f√≠sicas, <em>etc.</em>, son cosas espec√≠ficas del HW, por lo que estar√°n en <code>PORT</code>.</p>
<figure style="text-align:center;"> <div style="display: flex; justify-content: center; align-items: center; gap: 10px;"> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_3/rgb_color_t.png"><img alt="Estructura de un color RGB" id="fig:rgb_color_t" src="../assets/notebook_imgs/pr_chapters/version_3/rgb_color_t.png" style="width:100%;"/></a> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_3/stm32f4_rgb_light_hw_t.png"><img alt="Estructura HW LED RGB" id="fig:stm32f4_rgb_light_hw_t" src="../assets/notebook_imgs/pr_chapters/version_3/stm32f4_rgb_light_hw_t.png" style="width:100%;"/></a> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_3/fsm_rgb_light_t.png"><img alt="Estructura FSM del LED RGB" id="fig:fsm_rgb_light_t" src="../assets/notebook_imgs/pr_chapters/version_3/fsm_rgb_light_t.png" style="width:100%;"/></a> </div> <figcaption>(a) Estructura de un color RGB, (b) Estructura del HW del LED RGB en PORT, (c) Estructura de la FSM del *RGB light* en COMMON.</figcaption> </figure>
<p>Las figuras de estructuras de un <a href="#fig:rgb_color_t">color RGB</a>, <a href="#fig:stm32f4_rgb_light_hw_t">del HW</a> <a href="#fig:fsm_rgb_light_t">y del SW</a> muestran las estructuras que vamos a necesitar para el LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>.</p>
<p>Un color <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span> se define por la estructura de la <a href="#fig:rgb_color_t">figura (a)</a> con tres valores <code>uint8_t</code> que indican la intensidad de cada componente en un rango de [0, <code>COLOR_RGB_MAX_VALUE</code>]. Donde la etiqueta <code>COLOR_RGB_MAX_VALUE</code> se ha definido con un valor de <code>255</code>, por lo que este ser√° el n√∫mero de niveles de intensidad que podremos representar para cada componente.</p>
<p>La estructura del HW del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†(en <code>PORT</code>) se muestra en la <a href="#fig:stm32f4_rgb_light_hw_t">figura (b)</a>. La estructura de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> (en <code>COMMON</code>) se muestra en la <a href="#fig:fsm_rgb_light_t">figura (c)</a>.</p>
<p>Preparemos el proyecto para poder a√±adir el LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>:</p>
<ol>
<li>
<p>Descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte PORT</strong> de la librer√≠a del <em>RGB light</em> correspondientes a la versi√≥n <code>V3</code>: <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v3">https://github.com/sdg2DieUpm/simone/tree/simone_v3</a>. Solo descarga por ahora: <code>port_rgb_light.h</code>, <code>stm32f4_rgb_light.h</code>, y <code>stm32f4_rgb_light.c</code> y col√≥calos en las carpetas correspondientes. <strong>De la parte COMMON descarga solo <code>rgb_color.h</code> y <code>rgb_color.c</code></strong>, que incluyen la definici√≥n de los colores que usaremos en el juego.</p>
</li>
<li>
<p>Coloca cada uno donde corresponde: <code>PORT</code> o <code>COMMON</code>, en <code>include</code>, o <code>src</code>, como se explic√≥ en el los cap√≠tulos anteriores.</p>
</li>
<li>
<p>Ver√°s que no compila, y es que solo se proporciona un esqueleto del c√≥digo.</p>
</li>
</ol>
<h2 id="sec:rgb_colors"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1</span> Colores RGB predefinidos<a class="headerlink" href="#sec:rgb_colors" title="Permanent link">¬∂</a></h2>
<p>Antes de ponernos a programar, conviene explicar qu√© son los ficheros <code>rgb_colors.h</code> y <code>rg_colors.c</code>. Estos ficheros se han de colocar en la carpeta <code>common/include</code> y <code>common/src</code> respectivamente. Estos ficheros contienen los colores que se usar√°n en el juego. Cada color est√° representado por una estructura de tipo <code>rgb_color_t</code> que contiene tres campos: <code>r</code>, <code>g</code>, y <code>b</code>, que representan la intensidad de cada componente del color en un rango de [0, <code>COLOR_RGB_MAX_VALUE</code>]. Estos colores predefinidos son los que se muestran en la <a href="#tbl:rgb_colors">tabla</a>.</p>
<p>Estos ficheros permiten definir m√∫ltiples colores de manera sencilla y reutilizable. Si deseas a√±adir m√°s colores, puedes hacerlo en la <a href="version_5.html">Versi√≥n 5</a> definiendo nuevas variables de tipo <code>rgb_color_t</code> en el fichero <code>rgb_colors.c</code> y declar√°ndolas en el fichero <code>rgb_colors.h</code>. Tambi√©n podr√≠as cambiar el rango de intensidad modificando el valor de <code>COLOR_RGB_MAX_VALUE</code> para tener mayor o menor resoluci√≥n en la representaci√≥n de los colores.</p>
<h2 id="sec:headers_rgb_light"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.2</span> <code>PORT</code>: cabeceras de la librer√≠a del RGB light<a class="headerlink" href="#sec:headers_rgb_light" title="Permanent link">¬∂</a></h2>
<p>Vamos a implementar el <em>contrato con el usuario</em> de la parte dependiente del HW de librer√≠a del <em>RGB light</em>. Esta es la interfaz que vamos a proporcionar al usuario para que pueda usar la librer√≠a y a√±adir LEDs <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†como necesite. Vamos a <em>portar</em> las funciones necesarias para usar la librer√≠a, c√≥mo no, para la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>. Comenzaremos de nuevo por la cabecera y luego los c√≥digos fuente. El montaje de nuestro LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†con la <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>¬†se muestra en la <a href="#fig:fritzing_rgb_light">figura</a>.</p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_3/fritzing_rgb_light.png"><img alt='Montaje del LED &lt;span style="color: red; font-weight: bold;"&gt;R&lt;/span&gt;&lt;span style="color: green; font-weight: bold;"&gt;G&lt;/span&gt;&lt;span style="color: blue; font-weight: bold;"&gt;B&lt;/span&gt;¬†de c√°todo com√∫n con la &lt;span style="color: RoyalBlue; font-weight: bold;"&gt;Nucleo-STM32F446RE&lt;/span&gt;.' id="fig:fritzing_rgb_light" src="../assets/notebook_imgs/pr_chapters/version_3/fritzing_rgb_light.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Montaje del LED RGB¬†de c√°todo com√∫n con la Nucleo-STM32F446RE.</figcaption></figure>
<p>En el mercado existen numerosos LEDs <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>. En este proyecto utilizaremos un LED de c√°todo com√∫n. En este tipo de LEDs, el √°nodo de cada LED est√° conectado a un pin del microcontrolador a trav√©s de una resistencia, y los c√°todos de los tres LED est√°n internamente conectados a un pin com√∫n que ir√° a tierra. Para adquirir uno, ve a <a href="bom.html">la¬†<em>BOM</em></a>).</p>
<h3 id="cabecera-port_rgb_lighth"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.2.1</span> Cabecera port_rgb_light.h<a class="headerlink" href="#cabecera-port_rgb_lighth" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera depende del HW pero no de las particularidades del microcontrolador <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. Vamos a seguir los siguientes pasos:</p>
<ol>
<li>
<p>Incluye todas las cabeceras necesarias seg√∫n indica la API.</p>
</li>
<li>
<p>Define (<code>#define</code>) el <code>PORT_RGB_LIGHT_ID</code>, que es un valor num√©rico natural que ser√° el identificador del <em>RGB light</em> trasero. Si es el √∫nico <em>RGB light</em> del sistema, le asignaremos el 0.</p>
</li>
<li>
<p>Escribe los prototipos de las funciones p√∫blicas que aparecen en la API del fichero <code>port_rgb_light.h</code>.</p>
</li>
<li>
<p>Puede ser buen momento ahora para documentar con Doxygen.</p>
</li>
</ol>
<p>Ya hemos acabado con el encabezado que interact√∫a con el HW del <em>RGB light</em> y que no depende del microcontrolador. Todav√≠a dar√° errores al compilar. Vamos ahora a programar la cabecera que s√≠ depende del microcontrolador <code>stm32f4_rgb_light.h</code>.</p>
<h3 id="cabecera-stm32f4_rgb_lighth"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.2.2</span> Cabecera stm32f4_rgb_light.h<a class="headerlink" href="#cabecera-stm32f4_rgb_lighth" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera define los pines a los que est√° conectado el LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†de cada <em>RGB light</em> asociado.</p>
<ol>
<li>
<p>Incluye todas las cabeceras necesarias seg√∫n indica la API.</p>
</li>
<li>
<p>Define (<code>#define</code>) los valores de las GPIO de los pines de los LED rojo, verde y azul.</p>
</li>
<li>
<p>Declara la estructura <code>stm32f4_rgb_light_hw_t</code>, que contiene en sus campos los puertos y pines de cada GPIO. Presta atenci√≥n a la API.</p>
</li>
<li>
<p>Declara el array de estructuras de tipo <code>stm32f4_rgb_light_hw_t</code> como se hizo en versiones anteriores. Este array contendr√° las caracter√≠sticas de todos los LED RGB que tengamos en el sistema.</p>
</li>
<li>
<p>Documenta todo con Doxygen.</p>
</li>
</ol>
<p>Ya hemos acabado con el encabezado (<em>header</em>) que interact√∫a con el HW del <em>RGB light</em>. Todav√≠a dar√° errores al compilar. Vamos ahora a implementar todas las funciones prototipadas en <code>port_rgb_light.h</code>.</p>
<h2 id="sec:port_rgb_light"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3</span> <code>PORT</code>: fuente de la librer√≠a del RGB light<a class="headerlink" href="#sec:port_rgb_light" title="Permanent link">¬∂</a></h2>
<p>Vamos a <em>portar</em> las funciones necesarias para usar la librer√≠a del <em>RGB light</em> y comprobar que la parte HW est√° bien programada. Vamos a programar los ficheros fuente de la parte <code>PORT</code>, que <strong>todos estar√°n en el fichero <code>stm32f4_rgb_light.c</code></strong>.</p>
<h3 id="fuentes-stm32f4_rgb_lightc"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.1</span> Fuentes stm32f4_rgb_light.c<a class="headerlink" href="#fuentes-stm32f4_rgb_lightc" title="Permanent link">¬∂</a></h3>
<p>Este fichero es mucho menos extenso que el de la versi√≥n anterior. La mayor complejidad est√° en la configuraci√≥n de los canales del temporizador, pero si has le√≠do el cap√≠tulo del libro relativo a PWM y lo has entendido, no deber√≠as tener problema¬†<sup id="fnref2:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">1</a></sup>. Vamos a ello.</p>
<ol>
<li>
<p>Incluye las librer√≠as necesarias, si falta alguna, seg√∫n indique la API.</p>
</li>
<li>
<p>Igual que hicimos anteriormente, define la <strong>variable global privada</strong> <code>stm32f4_rgb_light_hw_t rgb_lights_arr[]</code> con la configuraci√≥n f√≠sica de nuesto LED RGB. Se trata del array de estructuras de tipo <code>stm32f4_rgb_light_hw_t</code>, que representa al HW de cada <em>RGB light</em> que tengamos en nuestro juego.</p>
<p>Asigna los valores HW del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†del LED <code>PORT_RGB_LIGHT_ID</code> utilizando los <code>#define</code> de <code>stm32f4_rgb_light.h</code>.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>_stm32f4_rgb_light_get()</code> de manera an√°loga a como se ha hecho en las versiones anteriores.</p>
</li>
</ol>
<p>Ahora vamos a codificar las funciones m√°s importantes de la parte <code>PORT</code> del <em>RGB light</em>, y son las que configuran el temporizador asociado al LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>.</p>
<ol>
<li>
<p>Codifica la funci√≥n <code>_timer_pwm_config()</code> como indica la API. Esta funci√≥n configura el temporizador que controla los ciclos de trabajo de los LED rojo, verde y azul. Para ello, ap√≥yate en el ejemplo <em>"timer para PWM‚Äù</em> del libro de Fundamentos¬†<sup id="fnref4:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">1</a></sup>.</p>
<p>Esta funci√≥n configura un temporizador para que genere una se√±al <a href="acronimos.html#acro:PWM"><strong>PWM</strong></a> con una frecuencia fija y un ciclo de trabajo variable. El temporizador elegido y la frecuencia se muestra en <a href="#tbl:version3_rgb">la tabla de HW para la versi√≥n 3</a>.</p>
<p>Esta funci√≥n recibe el identificador del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>. Cada <em>RGB light</em> tendr√° su propio temporizador, pero esta funci√≥n ser√° llamada para configurar todos ellos. Aseg√∫rate de que el c√≥digo se ejecuta dentro de un bloque condicional que compruebe el identificador del <em>RGB light</em>.</p>
<p>Para saber qu√© fuente de reloj habilitar para el temporizador, consulta la tabla <em>"Figure 3. STM32F446xC/E block diagram‚Äù</em> del <em>datasheet</em>¬†<sup id="fnref2:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup>. All√≠ podr√°s ver si nuestro temporizador est√° conectado al <strong>APB1</strong> o al <strong>APB2</strong>, y tenemos que habilitar el reloj en el registro <code>RCC-&gt;APB1ENR</code> o <code>RCC-&gt;APB2ENR</code> respectivamente.</p>
<p>Puedes poner los valores de los registros <code>TIMx-&gt;PSC</code> y <code>TIMx-&gt;ARR</code> a mano, o usando las ecuaciones. Puedes crear un <code>#define</code> para la frecuencia de la se√±al PWM, si te es m√°s c√≥modo. Si lo haces a mano, aseg√∫rate de que los valores son correctos.</p>
<p>Aseg√∫rate de que los registro <em>Capture Compare Enable Register</em> (<code>CCER</code>) y <em>Capture Compare Mode Register</em> (<code>CCMRx</code>) est√°n configurados correctamente. En el <em>CCER</em> se habilitan los canales de salida y en el <em>CCMRx</em> se configura el modo PWM. La <em>x</em> es el registro 1 o 2, dependiendo del canal que est√©s configurando.</p>
<p><strong>Es muy importante que la funci√≥n <code>_timer_pwm_config()</code> se llame desde la funci√≥n <code>port_rgb_light_init()</code></strong>. Si no, no se podr√°n generar las se√±ales PWM.</p>
</li>
</ol>
<p>Vamos a continuar con las funciones p√∫blicas de la parte <code>PORT</code> del <em>RGB light</em>.</p>
<ol>
<li>
<p>Completa la funci√≥n <code>port_rgb_light_init()</code> como se indica en la API.</p>
<p>Configura las GPIO y el modo alternativo de los tres LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>. Para ello, consulta la tabla de <em>Funci√≥n Alternativa</em> del <em>datasheet</em>¬†<sup id="fnref:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup>.</p>
<p>Aseg√∫rate de que la funci√≥n <code>_timer_pwm_config()</code> se llama desde esta funci√≥n y que el LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†comienza apagado.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>port_rgb_light_set_rgb</code> siguiendo la API.</p>
<p>Esta funci√≥n se encarga de configurar el ciclo de trabajo de los LED rojo, verde y azul. Lo hace con la proporci√≥n de los valores recibidos en la estructura <code>rgb_color_t</code> sobre el m√°ximo valor definido en <code>COLOR_RGB_MAX_VALUE</code>. Si el valor recibido es 0, el LED estar√° apagado, deshabilitando el canal correspondiente.</p>
<p>F√≠jate que la funci√≥n recibe el identificador del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>. Aseg√∫rate de que el c√≥digo se ejecuta dentro de un bloque condicional que compruebe el identificador del <em>RGB light</em>.</p>
<p>Sigue el <a href="#fig:port_rgb_light_set_rgb">siguiente flujograma</a> para implementar la funci√≥n <code>port_rgb_light_set_rgb()</code>:</p>
<p></p><figure><embed id="fig:port_rgb_light_set_rgb" src="../assets/notebook_imgs/pr_chapters/version_3/port_rgb_light_set_rgb_flow.png" style="width:100.0%"/><figcaption aria-hidden="true">Flujograma de la funci√≥n <code>port_rgb_light_set_rgb()</code>.</figcaption></figure><p></p>
</li>
<li>
<p>Si queda algo por documentar puede ser buen momento ahora.</p>
</li>
</ol>
<p>Ahora, compila, el c√≥digo no deber√≠a tener ning√∫n error. <strong>¬°Ya hemos acabado con la implementaci√≥n de <em>portado</em> del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>!</strong> Vamos a probarlo con el <em>test</em> unitario de la parte <code>PORT</code>.</p>
<h2 id="sec:test_port_v3"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.4</span> <code>PORT</code>: Test unitario del RGB light<a class="headerlink" href="#sec:test_port_v3" title="Permanent link">¬∂</a></h2>
<p>Vamos a comprobar que la parte <code>PORT</code> funciona correctamente pasando los test HW del c√≥digo que hemos desarrollado de la librer√≠a del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†antes de continuar con la FSM.</p>
<p><span style="color: Red"><strong>¬°Importante! Los test que se proporcionan comprueban solo algunos aspectos esenciales, pero no son exhaustivos. Es responsabilidad del alumno comprobar que el sistema final funciona correctamente.</strong></span> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/gen_book_icon.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/gen_book_icon.png"/></a>¬†Ten a mano y revisa el cap√≠tulo <em>"Test unitarios y ejemplos de integraci√≥n‚Äù</em> del libro de fundamentos te√≥ricos¬†<sup id="fnref3:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">1</a></sup>.</p>
<p>Descarga el fichero de test HW del <em>RGB light</em> <code>test_port_rgb_light.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v3_test">https://github.com/sdg2DieUpm/simone/tree/simone_v3_test</a>. Ponlo en la carpeta <code>test/stm32f4</code> de tu proyecto.</p>
<ol>
<li>
<p>Conecta la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono de depuraci√≥n <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_debug.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_debug.png"/></a> y selecciona <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_run.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_run.png"/></a> Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>test_port_rgb_light</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Comprueba que todos los test pasan correctamente en el texto mostrado en la terminal de depuraci√≥n. Si no es as√≠, lee los mensajes de error y corrige tu c√≥digo hasta que pase todas las pruebas. <strong>Si no pasa las pruebas, no contin√∫es con el siguiente test.</strong></p>
</li>
<li>
<p>Termina la depuraci√≥n pulsando (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_stop.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_stop.png"/></a>) y repite el proceso hasta que pase todos los test.</p>
</li>
</ol>
<p><strong>¬°Ya hemos acabado con la parte <code>PORT</code> del <em>RGB light</em>!</strong> Vamos ahora a implementar la parte <code>COMMON</code>.</p>
<h2 id="common-cabecera-de-la-fsm-del-rgb-light"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.5</span> <code>COMMON</code>: cabecera de la FSM del <em>RGB light</em><a class="headerlink" href="#common-cabecera-de-la-fsm-del-rgb-light" title="Permanent link">¬∂</a></h2>
<h3 id="consideraciones-de-la-fsm-del-RGB" light="light"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.5.1</span> Consideraciones de la FSM del <em>RGB light</em><a class="headerlink" href="#consideraciones-de-la-fsm-del-RGB" title="Permanent link">¬∂</a></h3>
<p>Antes de empezar vamos a partir de una serie de consideraciones.</p>
<ul>
<li>
<p>La FSM <strong>almacena el √∫ltimo color que se le ha indicado que tiene que representar y su intensidad</strong>. La intensidad se almacena en porcentaje como un un <code>uint8_t</code> pero ha de estar limitada a <code>MAX_LEVEL_INTENSITY</code> igual a <span class="arithmatex">\(100\)</span> cuando se opere con ella. El color se almacena en una estructura de tipo <code>rgb_color_t</code>.</p>
</li>
<li>
<p>La FSM contiene un campo de estado (<code>status</code>) que indica si el <em>RGB light</em> est√° activo. Si el <em>RGB light</em> est√° desactivado, no se mostrar√° ning√∫n color. Esto puede ser √∫til si, por ejemplo, tenemos m√°s de un <em>RGB light</em> en el sistema y queremos desactivar alguno de ellos.</p>
<p>La m√°quina de estados superior, la del sistema Simone, ser√° la que indique si el <em>RGB light</em> est√° activo o no. La FSM del <em>RGB light</em> solo se encargar√° de representar los colores si est√° activo.</p>
</li>
<li>
<p>La FSM contiene otro <em>flag</em> que indica si el <em>RGB light</em> est√° en modo ocioso (<code>idle</code>). En este estado, el <em>RGB light</em> ya ha puesto un color, no se ha cambiado √©ste ni la intensidad, y podemos entrar en un modo de bajo consumo <em>Sleep Mode</em> <a href="version_4.html">Versi√≥n 4</a>. En <em>Sleep Mode</em>, el n√∫cleo del procesador se detiene, pero los perif√©ricos y el sistema de reloj contin√∫an funcionando, por eso el LED permanecer√° encendido en el color que se haya quedado.</p>
</li>
<li>
<p>El <em>flag</em> <code>new_color</code> lo activa la m√°quina de estados de Simone cuando se ha cambiado el color a representar. La FSM del <em>RGB light</em> comprobar√° este <em>flag</em> para saber si tiene que cambiar el color del LED.</p>
</li>
<li>
<p>El valor de inicio de intensidad al arrancar debe ser el m√°ximo permitido. <strong>El intensidad se da en porcentaje.</strong></p>
</li>
<li>
<p>La FSM contiene informaci√≥n del identificador (<code>ID</code>) del <em>RGB light</em>. Este <code>ID</code> es √∫nico y gestionado por el usuario en el <code>PORT</code>. Ah√≠ es donde el usuario proporciona identificadores e informaci√≥n HW (GPIO a la que est√° conectado) para todos los LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†del sistema.</p>
</li>
</ul>
<figure><embed id="fig:fsm_rgb_light" src="../assets/notebook_imgs/pr_chapters/version_3/fsm_rgb_light.png" style="width:75.0%"/><figcaption aria-hidden="true">M√°quina de estados del <em>RGB light</em>.</figcaption></figure>
<p>Nuestra librer√≠a implementa la l√≥gica de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> mostrada en la <a href="#fig:fsm_rgb_light">figura</a> y que llamaremos <code>fsm_rgb_light</code> (en los ficheros <code>.c</code> y <code>.h</code>). Tiene 2 estados en los que:</p>
<ul>
<li>
<p><code>IDLE_RGB</code>: estado inicial de la FSM en el que espara a ser activada. Si se le activa se cambia al estado <code>SET_COLOR</code>. Tambi√©n se vuelve a este estado cuando el sistema no est√° activo (<code>status</code> es <code>false</code>).</p>
</li>
<li>
<p><code>SET_COLOR</code>: en este estado la FSM espera a que se le haya pasado un nuevo color base y/o una intensidad nueva. Tras poner el color, se activa el <em>flag</em> <code>idle</code> y se queda en este estado. El nuevo color se corrige modificando la intensidad del color base recibido seg√∫n el porcentaje de intensidad indicado; esto se hace con la funci√≥n privada <code>_correct_rgb_light_levels()</code> que deber√° implementar. Si se le desactiva el sistema, vuelve al estado <code>IDLE_RGB</code>.</p>
</li>
</ul>
<p>La parte <code>COMMON</code> de nuestra librer√≠a trabaja con la estructura (<code>struct</code>) <strong>p√∫blica</strong> que se muestra en la <a href="#fig:fsm_rgb_light_t">figura (c) <code>fsm_rgb_light_t</code></a>. El tipo de esta estructura est√° declarada en el fichero <code>fsm_rgb_light.h</code>.</p>
<ol>
<li>
<p>Lo primero, descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte COMMON</strong> de la librer√≠a del <em>RGB light</em> correspondientes a la versi√≥n <code>V3</code>: <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v3">https://github.com/sdg2DieUpm/simone/tree/simone_v3</a>. Solo descarga lo que faltaba por implementar, es decir, los ficheros <code>fsm_rgb_light.h</code> y <code>fsm_rgb_light.c</code>. Ponlos en las carpetas correspondientes de tu proyecto.</p>
<p>Ahora, vamos a completar la cabecera de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> del <em>RGB light</em>, <code>fsm_rgb_light.h</code>.</p>
</li>
<li>
<p>Incluye las librer√≠as necesarias, si falta alguna, seg√∫n indique la API.</p>
</li>
<li>
<p>Ahora vamos a definir el enumerado con los nombres de los estados de la FSM. Escribe el <code>enum</code> <code>FSM_RGB_LIGHT_SYSTEM</code> con los nombres de los estados del diagrama de la .</p>
</li>
<li>
<p>Defina los <code>#define</code> que se indican en la API para el m√°ximo nivel de intensidad porcentual que se pueden manejar en el <em>RGB light</em>.</p>
</li>
<li>
<p>Es buena pr√°ctica ir documentado el c√≥digo a la vez que se programa.</p>
</li>
<li>
<p>Seguidamente <strong>declararemos</strong> la estructura <code>fsm_rgb_light_t</code> y definimos sus campos. <span style="color: Red"><strong>Es muy importante que la m√°quina de estados del <em>RGB light</em></strong> <code>fsm_t</code> <strong>sea el primer campo</strong></span>.</p>
<p>Continuamos con las declaraciones de funciones p√∫blicas de la librer√≠a. <strong>Procedamos</strong>:</p>
</li>
<li>
<p>Escribe los prototipos de las <strong>funciones p√∫blicas</strong> que aparecen en la API del fichero <code>fsm_rgb_light.h</code>. A√±ada la funci√≥n <code>fsm_rgb_light_check_activity()</code> que, aunque la usaremos en la siguiente versi√≥n, tambi√©n ser√° necesaria para el test de la FSM.</p>
</li>
<li>
<p>Puede ser buen momento ahora para documentar las funciones con Doxygen.</p>
</li>
</ol>
<p>Vamos ahora a programar el fichero fuente <code>fsm_rgb_light.c</code>.</p>
<h2 id="common-fuente-de-la-fsm-del-rgb-light"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.6</span> <code>COMMON</code>: fuente de la FSM del RGB light<a class="headerlink" href="#common-fuente-de-la-fsm-del-rgb-light" title="Permanent link">¬∂</a></h2>
<p>Vamos a proceder con la implementaci√≥n de las funciones del <em>RGB light</em>. Deber√°s implementar todas las <strong>funciones p√∫blicas</strong> de las que ya has declarado el prototipo en el encabezado, y la <strong>funci√≥n privada</strong> <code>_correct_rgb_light_levels()</code> que aparece en la API del fichero <code>fsm_rgb_light.c</code>. <strong>¬°Recuerda que las funciones privadas no se declaran en el <code>.h</code>!</strong></p>
<ol>
<li>
<p>Lo primero que debe aparecer es la inclusi√≥n de cabeceras como indica la API.</p>
<p>Ahora empezamos a codificar las <strong>funciones privadas de la FSM</strong>. Bajo la l√≠nea de <code>/\* Private functions \*/</code> vamos a codificar la funci√≥n <code>_correct_rgb_light_levels()</code>.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>_correct_rgb_light_levels()</code> que se encarga de calcular los niveles de ciclo de trabajo de cada LED rejo, verde y azul. Esta funci√≥n simplemente multiplica por un valor entre [0, 1] cada uno de los componentes RGB. Esta funci√≥n <strong><span style="color: red">Ten en cuenta que el valor que almacenan no es el ciclo de trabajo entre 0 y 100, sino que quedar√° entre 0 y 255. ¬°El ciclo de trabajo se calcula en <code>port_rgb_light_set_rgb()</code>!</span></strong></p>
</li>
<li>
<p>Documenta la funci√≥n con Doxygen.</p>
<p><strong>Continuamos con las funciones de entrada o comprobaci√≥n <code>check_</code> de la FSM</strong> bajo la l√≠nea de <code>/\* State machine input or transition functions \*/</code>.</p>
</li>
<li>
<p>Codifica las funciones <code>check_active()</code>, <code>check_set_new_color()</code> y, <code>check_off()</code> como se indica en la API.</p>
</li>
<li>
<p>Documenta las funciones con Doxygen, encima del nombre de cada funci√≥n.</p>
<p><strong>Seguiremos con las funciones de salida o actualizaci√≥n de la FSM <code>do_</code></strong>.</p>
</li>
<li>
<p>Codifica las funciones <code>do_set_on()</code>, <code>do_set_color()</code> y, <code>do_set_off()</code> como se indica en la API.</p>
</li>
<li>
<p>Documenta las funciones con Doxygen. En este caso, igual que antes, la documentaci√≥n ir√° en el <code>.c</code>, encima del nombre de cada funci√≥n.</p>
<p>Todav√≠a no hemos acabado con el desarrollo, pero puedes compilar para ir depurando errores.</p>
</li>
<li>
<p>Declara la tabla de transiciones de la FSM <code>fsm_trans_rgb_light</code>. Esto eliminar√° muchos errores de compilaci√≥n.</p>
</li>
<li>
<p>Completa la funci√≥n de inicializaci√≥n de la FSM <code>fsm_rgb_light_init()</code> como se indica en la API. En esta funci√≥n se inicializan los campos de la estructura de la FSM, y se llama a la funci√≥n <code>fsm_init()</code> para inicializar la m√°quina de estados. Tambi√©n se llama a la funci√≥n <code>port_rgb_light_init()</code> para inicializar el HW del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>.</p>
</li>
<li>
<p>Codifica las funciones <code>fsm_rgb_light_fire()</code> y <code>fsm_rgb_light_destroy()</code> igual que hiciste en las versiones anteriores. Estas funciones lanzan la FSM y liberan la memoria respectivamente.</p>
</li>
<li>
<p>Codifica el resto de las funciones <code>fsm_rgb_light_xxx()</code> p√∫blicas que quedan declaradas en el <code>.h</code> como se indica en la API.</p>
</li>
<li>
<p>Documenta el c√≥digo que est√© sin comentar todav√≠a.</p>
</li>
</ol>
<p><strong>Ya hemos acabado con la programaci√≥n de la librer√≠a del <em>RGB light</em>.</strong> Ahora, si compilas, no deber√°n aparecer errores.</p>
<h2 id="sec:test_fsm_v3"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.7</span> <code>COMMON</code> Test unitario de la FSM del RGB light<a class="headerlink" href="#sec:test_fsm_v3" title="Permanent link">¬∂</a></h2>
<p>Vamos a hacer el test del c√≥digo que hemos desarrollado de la librer√≠a de la m√°quina de estados del <em>RGB light</em> y probar que funciona antes de continuar con la siguiente versi√≥n.</p>
<p><span style="color: Red"><strong>¬°Importante! Recuerda que los test que se proporcionan comprueban solo algunos aspectos esenciales, pero no son exhaustivos. Es responsabilidad del alumno comprobar que el sistema final funciona correctamente.</strong></span></p>
<p>Descarga el fichero de test de la FSM del <em>RGB light</em> <code>test_fsm_rgb_light.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v3_test">https://github.com/sdg2DieUpm/simone/tree/simone_v3_test</a>. Ponlo en la carpeta <code>test/</code> de tu proyecto. <strong>¬°No lo metas en stm32f4/, pues no es un test espec√≠fico del microcontrolador!</strong></p>
<ol>
<li>
<p>Con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†conectada al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>test_fsm_rgb_light</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Ejecuta el test por completo, o pon puntos de parada si deseas ir paso a paso.</p>
</li>
<li>
<p>Comprueba los mensajes del <code>gdb-server</code> para ver el resultado de las pruebas de los tests. Deber√≠a haber pasado todos los tests. Si no, lee el mensaje de error y corrige tu c√≥digo hasta que pasen todas las pruebas. <strong>Si no pasan las pruebas, no contin√∫es.</strong></p>
</li>
<li>
<p>Termina la depuraci√≥n pulsando (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_stop.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_stop.png"/></a>) y repite el proceso hasta que pasen todos los test.</p>
</li>
</ol>
<h2 id="ejemplo-de-uso-de-la-version-3"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.8</span> Ejemplo de uso de la Versi√≥n 3<a class="headerlink" href="#ejemplo-de-uso-de-la-version-3" title="Permanent link">¬∂</a></h2>
<p>En este test de integraci√≥n del <em>RGB light</em> es responsabilidad del alumno comprobar que la funcionalidad es la esperada. El ejemplo que se da no contempla todas las situaciones.</p>
<p>Descarga el fichero de ejemplo <code>example_v3.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v3_test">https://github.com/sdg2DieUpm/simone/tree/simone_v3_test</a>. Ponlo en la carpeta <code>example/</code> de tu proyecto.</p>
<p><strong>Procedamos</strong>:</p>
<p>Para poder hacer el ejemplo del <em>RGB light</em>, necesitamos montar el LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>. En el <a href="#fig:fritzing_rgb_light">esquema de la figura</a> se muestra un ejemplo de montaje.</p>
<ol>
<li>
<p>Monte el HW como se muestra en la .</p>
</li>
<li>
<p>Con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†conectada al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono de depuraci√≥n <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_debug.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_debug.png"/></a> y selecciona <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_run.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_run.png"/></a> Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>example_v3</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Se parar√° en la primera l√≠nea del <code>main()</code>. Ejecuta el test por completo, o pon puntos de parada si deseas ir paso a paso. Este c√≥digo no termina, pues es un bucle <code>while</code> infinito.</p>
</li>
<li>
<p>Abre la terminal del <code>gdb-server</code> para ver los mensajes que se van imprimiendo.</p>
</li>
<li>
<p>Comprueba que los colores del LED <span style="color: red; font-weight: bold;">R</span><span style="color: green; font-weight: bold;">G</span><span style="color: blue; font-weight: bold;">B</span>¬†cambian en funci√≥n de la intensidad que se le indica en los mensajes de la terminal.</p>
</li>
<li>
<p>Haz distintas pruebas y aseg√∫rate de que el comportamiento es el adecuado.</p>
</li>
</ol>
<p>¬°Hemos creado nuestra tercera librer√≠a! F√≠jate que es <em>portable</em> a cualquier plataforma solo con adaptar las funciones del <code>PORT</code>.</p>
<p>No dejes de documentar el c√≥digo. <strong>Comprueba que la documentaci√≥n del c√≥digo se ha generado correctamente como se explica en la <em>"Gu√≠a de instalaci√≥n de herramientas para compilaci√≥n multiplataforma en C‚Äù</em>¬†<sup id="fnref:stm322025guiainstalacion"><a class="footnote-ref" href="#fn:stm322025guiainstalacion">4</a></sup>.</strong>, o en el v√≠deo <a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">"[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen‚Äù</a>.</p>
<p>Guarda una copia de su proyecto como <code>simone_v3</code> para tener un punto de partida para la siguiente versi√≥n, y una copia de seguridad por si algo falla.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:stm322025fundamentos">
<p>Josu√© Pag√°n Ortiz, Pedro Jos√© Malag√≥n Marzo, Rom√°n C√°rdenas Rodr√≠guez, and Juan Jos√© G√≥mez Valverde. <em>Fundamentos te√≥ricos de sistemas basados en microcontrolador STM32. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Josu√© Pag√°n Ortiz, Madrid, March 2025. URL: <a href="https://oa.upm.es/88460/">https://oa.upm.es/88460/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025fundamentos" title="Jump back to footnote 1 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref2:stm322025fundamentos" title="Jump back to footnote 1 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref3:stm322025fundamentos" title="Jump back to footnote 1 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref4:stm322025fundamentos" title="Jump back to footnote 1 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref5:stm322025fundamentos" title="Jump back to footnote 1 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021datasheet">
<p>STMicroelectronics. Stm32f446xc/e. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/datasheet/stm32f446re.pdf">https://www.st.com/resource/en/datasheet/stm32f446re.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021datasheet" title="Jump back to footnote 2 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref2:st2021datasheet" title="Jump back to footnote 2 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref3:st2021datasheet" title="Jump back to footnote 2 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref4:st2021datasheet" title="Jump back to footnote 2 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref5:st2021datasheet" title="Jump back to footnote 2 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref6:st2021datasheet" title="Jump back to footnote 2 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021reference">
<p>STMicroelectronics. Rm0390 reference manual. stm32f446xx advanced arm-based 32-bit mcus. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021reference" title="Jump back to footnote 3 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025guiainstalacion">
<p>Josu√© Pag√°n Ortiz, Pedro Jos√© Malag√≥n Marzo, Rom√°n C√°rdenas Rodr√≠guez, Amadeo de Gracia Herranz, Sergio Esteban Romero, and Daniel Capell√°n Mart√≠n. <em>Gu√≠a de instalaci√≥n de herramientas para compilaci√≥n multiplataforma en C. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Josu√© Pag√°n Ortiz, Madrid, March 2025. URL: <a href="https://oa.upm.es/92376/">https://oa.upm.es/92376/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025guiainstalacion" title="Jump back to footnote 4 in the text">‚Ü©</a></p>
</li>
</ol>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Volver al principio
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
<script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>