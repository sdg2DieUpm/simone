<!DOCTYPE html>
<html class="no-js" lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://sdg2dieupm.github.io/simone/notebook/version_2.html" rel="canonical"/>
<link href="version_1.html" rel="prev"/>
<link href="version_3.html" rel="next"/>
<link href="../assets/notebook_imgs/general/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Versi√≥n 2 - Laboratorio de Sistemas Digitales II</title>
<link href="../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/notebook-extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
<body data-md-color-accent="deep_orange" data-md-color-primary="blue_grey" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cha:version2">
          Saltar a contenido
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Cabecera" class="md-header__inner md-grid">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-header__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Laboratorio de Sistemas Digitales II
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Versi√≥n 2
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Cambiar a modo oscuro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Cambiar a modo oscuro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Cambiar a modo claro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Cambiar a modo claro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="B√∫squeda" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="B√∫squeda" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Buscar" class="md-search__options">
<button aria-label="Limpiar" class="md-search__icon md-icon" tabindex="-1" title="Limpiar" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navegaci√≥n" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-nav__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
    Laboratorio de Sistemas Digitales II
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../index.html">
<span class="md-ellipsis">
    Portada
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Introducci√≥n general
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introducci√≥n general
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="intro.html">
<span class="md-ellipsis">
    Introducci√≥n a SDG2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="sesion_introduccion.html">
<span class="md-ellipsis">
    Sesi√≥n de introducci√≥n
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    Proyecto
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Proyecto
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="version_0.html">
<span class="md-ellipsis">
    Versi√≥n 0
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_1.html">
<span class="md-ellipsis">
    Versi√≥n 1
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Versi√≥n 2
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="version_2.html">
<span class="md-ellipsis">
    Versi√≥n 2
    
  </span>
</a>
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#caracteristicas-del-teclado-matricial-en-version-2">
<span class="md-ellipsis">
      Caracter√≠sticas del teclado matricial en Versi√≥n 2
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:layouts_keyboards">
<span class="md-ellipsis">
      Layouts de teclados matriciales
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_keyboard">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_keyboard">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_keyboard">
<span class="md-ellipsis">
      PORT: Test unitario del teclado matricial
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:fsm_keyboard">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v2">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-2">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 2
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_3.html">
<span class="md-ellipsis">
    Versi√≥n 3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_4.html">
<span class="md-ellipsis">
    Versi√≥n 4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_5.html">
<span class="md-ellipsis">
    Versi√≥n 5
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    API
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            API
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/index.html">
<span class="md-ellipsis">
    Documentaci√≥n API
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    Ap√©ndices
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Ap√©ndices
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="bom.html">
<span class="md-ellipsis">
    BOM
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Acr√≥nimos
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="acronimos.html">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../pdf/manual_simone.pdf">
<span class="md-ellipsis">
    üì• Descargar como PDF
    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#caracteristicas-del-teclado-matricial-en-version-2">
<span class="md-ellipsis">
      Caracter√≠sticas del teclado matricial en Versi√≥n 2
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:layouts_keyboards">
<span class="md-ellipsis">
      Layouts de teclados matriciales
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_keyboard">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_keyboard">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_keyboard">
<span class="md-ellipsis">
      PORT: Test unitario del teclado matricial
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:fsm_keyboard">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v2">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-2">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 2
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cha:version2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.</span> Versi√≥n 2: teclado matricial<a class="headerlink" href="#cha:version2" title="Permanent link">¬∂</a></h1>
<p>En la Versi√≥n 1 aprendimos a gestionar un √∫nico bot√≥n mediante interrupciones. Sin embargo, ¬øqu√© ocurre si nuestro sistema necesita 12, 16 o m√°s botones? Si utiliz√°ramos la estrategia anterior, necesitar√≠amos una l√≠nea de interrupci√≥n y un pin GPIO por cada bot√≥n, agotando r√°pidamente los recursos del microcontrolador.</p>
<p>Para solucionar esto, utilizamos la t√©cnica del <strong>barrido</strong> o <em>scanning</em> en un teclado matricial. Esta t√©cnica aprovecha la persistencia temporal para leer muchos pulsadores utilizando pocos pines, organiz√°ndolos en filas y columnas.</p>
<div class="admonition example">
<p class="admonition-title">Bibliograf√≠a</p>
<ol>
<li>
<p><em>‚ÄúFundamentos te√≥ricos de sistemas basados en microcontrolador STM32‚Äù</em>¬†<sup id="fnref4:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup></p>
</li>
<li>
<p><em>Datasheet ‚ÄúSTM32F446xC/E‚Äù</em>¬†<sup id="fnref2:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">4</a></sup></p>
</li>
<li>
<p><em>Reference manual ‚ÄúRM0390. STM32F446xx advanced Arm-based 32-bit MCUs‚Äô</em>¬†<sup id="fnref:st2021reference"><a class="footnote-ref" href="#fn:st2021reference">5</a></sup></p>
</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title"><a href="https://www.youtube.com/channel/UCYIw_gl745WMJ1n0MamDzQw/">V√≠deos del canal de SDGII</a></p>
<ul>
<li>
<p><a href="https://youtu.be/v-HXdcEtT_4">Demostraci√≥n Simone</a></p>
</li>
<li>
<p><a href="https://youtu.be/CcbgLVfCXrw?si=A8DP1rescxJNBEb9">Blink LED y manejo de proyecto</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLTFFovUxjNnn19myGVw1kwh6GPbRxwIcC">Conceptos b√°sicos de C (canal SDG1)</a></p>
</li>
<li>
<p><a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen</a></p>
</li>
</ul>
</div>
<p>En este cap√≠tulo vamos a crear una librer√≠a que nos permita gestionar un teclado matricial 4x4 (16 teclas) <a href="#fig:keyboard">como el de la figura</a>. A diferencia del bot√≥n, que funcionaba solo ten√≠amos una interrupci√≥n, aqu√≠ <strong>utilizaremos un temporizador que nos interrumpe para realizar una excitaci√≥n peri√≥dica de las filas y esperaremos interrupciones de las columnas.</strong></p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/keyboard.png"><img alt="Teclado matricial de membrana 4x4 usado en el proyecto Simone." id="fig:keyboard" src="../assets/notebook_imgs/pr_chapters/version_2/keyboard.png" style="width:65.0%"/></a><figcaption aria-hidden="true">Teclado matricial de membrana 4x4 usado en el proyecto Simone.</figcaption></figure>
<p>Como ya hicimos en las versiones anteriores, (i) vamos a implementar la parte <em>portable</em> <code>PORT</code> dependiente del <strong><a href="acronimos.html#acro:HW">HW</a></strong> para gestionar los niveles l√≥gicos de las filas y la lectura de las columnas, y lo probaremos con un test unitario. (ii) Despu√©s, vamos a crear la l√≥gica de la <strong><a href="acronimos.html#acro:FSM">FSM</a></strong> para gestionar el barrido y el <em>anti-rebotes</em> (la parte <code>COMMON</code>), y lo probaremos con un test unitario. (iii) Por √∫ltimo, montaremos el <strong><a href="acronimos.html#acro:HW">HW</a></strong> y probaremos el funcionamiento con un programa de ejemplo.</p>
<p>El teclado matricial es un array de pulsadores conectados en intersecciones de filas y columnas. Cuando no se pulsa ninguna tecla, no hay conexi√≥n entre filas y columnas. Al pulsar una tecla, se cortocircuita una fila con una columna espec√≠fica. Las caracter√≠sticas a destacar del sistema de la Versi√≥n 2 se muestran en la <a href="#tbl:version2_keypad">siguiente tabla</a>.</p>
<div id="tbl:version2_keypad"></div>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong>Par√°metro</strong></th>
<th style="text-align: center;"><strong>Valor</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Pin fila 1</td>
<td style="text-align: center;"><code>PA0</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin fila 2</td>
<td style="text-align: center;"><code>PA1</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin fila 3</td>
<td style="text-align: center;"><code>PA4</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin fila 4</td>
<td style="text-align: center;"><code>PB0</code></td>
</tr>
<tr>
<td style="text-align: left;">Modo filas</td>
<td style="text-align: center;">Salida</td>
</tr>
<tr>
<td style="text-align: left;">Pull up/ down filas</td>
<td style="text-align: center;">No push, no pull</td>
</tr>
<tr>
<td style="text-align: left;">Timeout de excitaci√≥n de filas</td>
<td style="text-align: center;"><span class="arithmatex">\(25 ms\)</span></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 1</td>
<td style="text-align: center;"><code>PA8</code>/ <code>EXTI8</code>/ <code>EXTI9_5_IRQHandler</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 2</td>
<td style="text-align: center;"><code>PB10</code>/ <code>EXTI10</code>/ <code>EXTI15_10_IRQHandler</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 3</td>
<td style="text-align: center;"><code>PB4</code>/ <code>EXTI4</code>/ <code>EXTI4_IRQHandler</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 4</td>
<td style="text-align: center;"><code>PB5</code>/ <code>EXTI5</code>/ <code>EXTI9_5_IRQHandler</code></td>
</tr>
<tr>
<td style="text-align: left;">Modo columnas</td>
<td style="text-align: center;">Entrada</td>
</tr>
<tr>
<td style="text-align: left;">Pull up/ down columnas</td>
<td style="text-align: center;">Pull down</td>
</tr>
<tr>
<td style="text-align: left;">Prioridad todas las columnas</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: left;">Subprioridad todas las columnas</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: left;">Tiempo anti-rebotes todas las columnas</td>
<td style="text-align: center;"><span class="arithmatex">\(100-200 ms\)</span></td>
</tr>
</tbody>
</table>
<h2 id="caracteristicas-del-teclado-matricial-en-version-2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.1</span> Caracter√≠sticas del teclado matricial en Versi√≥n 2<a class="headerlink" href="#caracteristicas-del-teclado-matricial-en-version-2" title="Permanent link">¬∂</a></h2>
<figure style="text-align:center;"> <div style="display: flex; justify-content: center; align-items: center; gap: 10px;"> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/keypad.jpeg"><img alt="Circuiter√≠a teclado" id="fig:keypad" src="../assets/notebook_imgs/pr_chapters/version_2/keypad.jpeg" style="width:100%;"/></a> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/keypad_matrix.png"><img alt="Esquema matricial" id="fig:keypad_matrix" src="../assets/notebook_imgs/pr_chapters/version_2/keypad_matrix.png" style="width:100%;"/></a> </div> <figcaption>(a) Circuio de un teclado matricial de membrana, (b) Esquema de conexiones.</figcaption> </figure>
<p>Si tiene la oportunidad de abrir en casa cualquier sistema que tenga un teclado o botonera<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, seguramente encuentre una circuiter√≠a como la de la <a href="#fig:keypad">figura (a)</a>. La goma gris es la cara interna de los botones, que est√° sobre la PCB verde. Las almohadillas negras que ve son contactos met√°licos que, cuando se pulsa el bot√≥n, se cortocircuitan con el metal de la PCB y cierran el circuito<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.</p>
<p>La idea de colocar los botones as√≠, haciendo una rejilla, es muy inteligente. Haciendo un enrejillado no es necesario tener un cable para cada bot√≥n, porque un cable por cada bot√≥n implicar√≠a tener un pin de entrada en nuestro microcontrolador por cada uno (si no se usan multiplexores, claro), y los pines no es algo que sobre, generalmente, en los encapsulados de los chips. Por ejemplo, en el <a href="#fig:keypad">teclado de la figura (a)</a> se usan 10 cables para 24 botones (ahorro del <span class="arithmatex">\(58.3\%\)</span> de conexiones/pines), y en el del teclado del laboratorio se usar√°n 8 conexiones para 16 botones (ahorro del <span class="arithmatex">\(50.0\%\)</span>).</p>
<p>Pero esta idea no sale gratis. A cambio de reducir el hardware necesario, tenemos que complicar el software un poquito. Debemos ir excitando ‚Äîponiendo tensi√≥n‚Äî las filas o columnas de forma c√≠clica para poder detectar qu√© bot√≥n se ha pulsado (lo hacemos leyendo las columnas o filas respectivamente). Si alguna columna detecta esa tensi√≥n, sabemos qu√© tecla exacta (intersecci√≥n fila-columna) se ha pulsado. Este proceso se repite para todas las filas r√°pidamente. <strong>En nuestro caso excitaremos filas</strong>. F√≠jate que solo podemos tener una fila con tensi√≥n a la vez porque, de otro modo, no ser√≠amos capaces de distinguir entre los botones de una misma columna. Si haces un dibujo, lo ver√°s f√°cilmente.</p>
<p>No te preocupes, la gesti√≥n de filas y columnas tiene f√°cil soluci√≥n si trabajamos con las m√°quinas de estado; pues para controlar la excitaci√≥n de las filas del teclado matricial tendremos la <a href="#fig:fsm_keyboard">FSM del teclado</a>.</p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/keyboard_timing.png"><img alt="Diagrama de temporizaci√≥n de excitaci√≥n de filas." id="fig:keyboard_timing" src="../assets/notebook_imgs/pr_chapters/version_2/keyboard_timing.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Diagrama de temporizaci√≥n de excitaci√≥n de filas.</figcaption></figure>
<p>El <a href="#fig:keyboard_timing">diagrama de temporizaci√≥n</a> muestra c√≥mo se excitan las filas del teclado. Cada <span class="arithmatex">\(25 ms\)</span> se excita una fila diferente poniendo un nivel l√≥gico alto en el pin correspondiente. Durante ese tiempo que est√° la fila en alto, se puede producir interrupci√≥n si se pulsa alguna tecla de esa fila. Luego, se desactiva la fila (nivel l√≥gico bajo) y se excita la siguiente fila. As√≠, en un per√≠odo de <span class="arithmatex">\(100 ms\)</span> se excitan todas las filas del teclado. Este tiempo es suficientemente r√°pido para que el usuario no note que las filas se excitan de forma secuencial.</p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/keyboard_connections.png"><img alt="Ejemplo de excitaci√≥n de fila R1, pulsando tecla 3, generando interrupci√≥n en pin conectado a columna C3." id="fig:keyboard_connections" src="../assets/notebook_imgs/pr_chapters/version_2/keyboard_connections.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Ejemplo de excitaci√≥n de fila R1, pulsando tecla 3, generando interrupci√≥n en pin conectado a columna C3.</figcaption></figure>
<p>La <a href="#fig:keyboard_connections">figura de ejemplo</a> muestra un ejemplo de c√≥mo funcionar√° el sistema. En este caso, la FSM del teclado est√° excitando la fila R1 poniendo un nivel l√≥gico alto en el pin correspondiente (cada <span class="arithmatex">\(25 ms\)</span> excita una fila). Cuando se pulsa la tecla '3', se cierra el circuito entre la fila R1 y la columna C3, lo que hace que el pin conectado a C3 detecte un nivel l√≥gico alto (<span class="arithmatex">\(3.3 V\)</span>).</p>
<p><strong>En este circuito vamos a activar las resistencias de pull-down ¬°internas! de los pines del microcontrolador conectados a las columnas</strong>, por lo que cuando no se pulsa ninguna tecla, las columnas estar√°n a nivel l√≥gico bajo (<span class="arithmatex">\(0 V\)</span>). Al pulsar la tecla '3', la columna C3 pasa a nivel l√≥gico alto debido a la conexi√≥n con la fila R1 que est√° excitada. <strong>Pasa lo contrario que con el circuito del bot√≥n, que ten√≠a una resistencia de pull-up ¬°externa!</strong> Esto genera una interrupci√≥n en el microcontrolador, que puede entonces identificar qu√© tecla se ha pulsado bas√°ndose en la fila actualmente excitada y la columna que ha generado la interrupci√≥n.</p>
<p>Recuerda que, como hicimos con el bot√≥n, <strong>estamos desarrollando una librer√≠a.</strong> El teclado matricial no tiene por qu√© saber nada de las acciones que hace el sistema cuando se pulsa una tecla. Es por eso que en nuestro proyecto, el teclado se encargar√° solo de guardar la tecla pulsada y de avisar de que ha habido una pulsaci√≥n. El sistema que use esta librer√≠a ‚Äîsea en este proyecto u otro‚Äî deber√° comprobar dicho valor guardado con un <em>get</em>. La idea es exactamente la misma que la que implement√≥ en el bot√≥n. As√≠, cada vez que se quiera a√±adir un teclado, le asociaremos una <strong><a href="acronimos.html#acro:FSM">FSM</a></strong>. Las particularidades de d√≥nde est√°n conectadas las filas y columnas son cosas espec√≠ficas del HW, por lo que estar√°n en <code>PORT</code>.</p>
<figure style="text-align:center;"> <div style="display: flex; justify-content: center; align-items: center; gap: 10px;"> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/stm32f4_keyboard_hw_t.png"><img alt="Estructura HW teclado" id="fig:stm32f4_keyboard_hw_t" src="../assets/notebook_imgs/pr_chapters/version_2/stm32f4_keyboard_hw_t.png" style="width:100%;"/></a> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/fsm_keyboard_t.png"><img alt="Estructura FSM del teclado" id="fig:fsm_keyboard_t" src="../assets/notebook_imgs/pr_chapters/version_2/fsm_keyboard_t.png" style="width:100%;"/></a> </div> <figcaption>(a) Estructura del HW del teclado en PORT, (b) Estructura de la FSM del teclado en COMMON.</figcaption> </figure>
<p>Las <a href="#fig:stm32f4_keyboard_hw_t">figuras de estructuras HW</a> <a href="#fig:fsm_keyboard_t">y SW</a> muestran las estructuras que vamos a necesitar para el teclado. La estructura del HW del teclado en <code>PORT</code>. El <code>PORT</code> de otro microcontrolador podr√≠a implementar internamente una estructura diferente, por eso est√° dentro de la carpeta <code>stm32f4</code>. Por ejemplo, al <em>portar</em> el c√≥digo para PC no tendr√≠a sentido definir la estructura de una GPIO. La estructura de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> del teclado en <code>COMMON</code> se muestra en la <a href="#fig:fsm_keyboard_t">figura de la FSM</a>.</p>
<p>Como en el caso del bot√≥n aqu√≠, aunque no hay muelles, puede haber igualmente inestabilidades en la pulsaci√≥n, <strong>rebotes</strong>, por lo e vamos a implementar, igualmente, un mecanismo antirebotes. Dejaremos unos tiempos de guarda de antirebotes tambi√©n entre <span class="arithmatex">\(100-200 ms\)</span>.</p>
<p>En el caso del teclado matricial no tenemos circuito preestablecido, por lo que podemos elegir libremente si queremos usar resistencias de <em>pull-up</em> o <em>pull-down</em> en las columnas. <strong>En este caso, usaremos resistencias de <em>pull-down</em> en las columnas y excitaremos las filas poniendo un nivel l√≥gico alto. As√≠, cuando se pulsa una tecla, la columna correspondiente pasa a nivel alto.</strong> Esto es al rev√©s de como pasaba en el bot√≥n.</p>
<p>Ahora s√≠, comencemos. Preparemos el proyecto para poder a√±adir el <em>teclado matricial</em>:</p>
<ol>
<li>Descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte PORT</strong> de la librer√≠a del <em>keyboard</em> correspondientes a la versi√≥n <code>V2</code>: <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2">https://github.com/sdg2DieUpm/simone/tree/simone_v2</a>. Solo descarga por ahora: <code>port_keyboard.h</code>, <code>stm32f4_keyboard.h</code>, y <code>stm32f4_keyboard.c</code> y col√≥calos en las carpetas correspondientes. <strong>De la parte COMMON descarga solo <code>keyboards.h</code>, y <code>keyboards.c</code></strong>, que incluyen los <em>layouts</em> de los teclados matriciales.</li>
<li>Coloca cada uno donde corresponde: <code>PORT</code> o <code>COMMON</code>, en <code>include</code>, o <code>src</code>. <strong>Ten en cuenta que algunos ficheros de <code>PORT</code> est√°n en la carpeta <code>stm32f4</code> porque sus funciones reciben o devuelven estructuras espec√≠ficas de la <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</strong></li>
</ol>
<p>Ver√°s que no compila, y es que solo se te proporciona cierta parte del c√≥digo. Los prototipos de gran parte de las funciones p√∫blicas no est√°n definidos.</p>
<h2 id="sec:layouts_keyboards"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.2</span> Layouts de teclados matriciales<a class="headerlink" href="#sec:layouts_keyboards" title="Permanent link">¬∂</a></h2>
<p>Antes de ponernos a programar, conviene explicar qu√© son los ficheros <code>keyboards.h</code> y <code>keyboards.c</code>. Estos ficheros se han de colocar en la carpeta <code>common/include</code> y <code>common/src</code> respectivamente. Estos ficheros contienen los <em>layouts</em> de los teclados matriciales que queramos usar en nuestro proyecto. Un <em>layout</em> es una matriz que define qu√© car√°cter representa cada tecla del teclado. Por ejemplo, en un teclado 4x4 t√≠pico, la primera fila podr√≠a representar los caracteres '1', '2', '3', 'A'; la segunda fila '4', '5', '6', 'B'; y as√≠ sucesivamente, pero otro de 4x4 tambi√©n podr√≠a tener una distribuci√≥n diferente (solo letras, o solo n√∫meros), ¬°o tener otro de 1x3 de colores!...</p>
<p>Estos ficheros permiten definir m√∫ltiples <em>layouts</em> para diferentes teclados matriciales, facilitando su uso en la librer√≠a del teclado. En la <a href="version_5.html">Versi√≥n 5</a> podr√≠as querer a√±adir un nuevo <em>layout</em> de alg√∫n teclado extra, o modificar el existente.</p>
<p>La estructura <code>keyboard_t</code> definida en <code>keyboards.h</code> contiene:</p>
<ul>
<li>Un puntero a una matriz de caracteres (<code>const char *keys</code>), que representa el <em>layout</em> del teclado.</li>
<li>El n√∫mero de filas (<code>uint8_t rows</code>) y columnas (<code>uint8_t cols</code>) del teclado.</li>
<li>Un caracter especial (<code>char null_key</code>) que indica que no se ha pulsado ninguna tecla. Por ejemplo el caracter <a href="acronimos.html#acro:ASCII">ASCII</a> nulo <code>'\0'</code>.</li>
</ul>
<p>En el mismo fichero se declara <code>standard_keyboard</code> como un ejemplo de <em>layout</em> para un teclado matricial 4x4. El nombre es algo gen√©rico y representativo. Este <em>layout</em> se define en <code>keyboards.c</code> como una matriz de caracteres que representa las teclas del teclado. Aqu√≠ se hace p√∫blico para que pueda ser usado en otras partes del c√≥digo; sus particularidades se definen en el <code>.c</code>.</p>
<h2 id="sec:headers_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3</span> <code>PORT</code>: cabeceras de la librer√≠a del teclado<a class="headerlink" href="#sec:headers_keyboard" title="Permanent link">¬∂</a></h2>
<p>Vamos a implementar el <em>contrato con el usuario</em> de la parte dependiente del HW de librer√≠a del teclado. Esta interfaz permitir√° configurar las filas y columnas de nuestro teclado y realizar el barrido de excitaci√≥n de filas y lectura de columnas para identificar la tecla pulsada.</p>
<p>El montaje de nuestro m√≥dulo teclado matricial tendr√° un aspecto como el mostrado en la <a href="#fig:fritzing_keyboard">figura</a>.</p>
<figure><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/pr_chapters/version_2/fritzing_keyboard.png"><img alt="Montaje del teclado matricial con la Nucleo-STM32F446RE." id="fig:fritzing_keyboard" src="../assets/notebook_imgs/pr_chapters/version_2/fritzing_keyboard.png" style="width:100.0%"/></a><figcaption aria-hidden="true">Montaje del teclado matricial con la <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span></figcaption></figure>
<p>M√°s adelante lo implementaremos.</p>
<h3 id="cabecera-port_keyboardh"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3.1</span> Cabecera port_keyboard.h<a class="headerlink" href="#cabecera-port_keyboardh" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera depende del HW pero no de las particularidades del microcontrolador <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. Vamos a seguir los siguientes pasos:</p>
<ol>
<li>Incluye todas las cabeceras necesarias seg√∫n indica la API.</li>
<li>
<p>Incluye los (<code>#define</code>) necesarios para el teclado: el identificador <code>PORT_KEYBOARD_MAIN_ID</code> que usaremos en el proyecto Simone, el <em>timeout</em> de excitaci√≥n de filas, y el tiempo de antirebotes de las teclas (<strong>mismo tiempo para todas</strong>).</p>
<p>Hemos decidido darle el nombre <code>PORT_KEYBOARD_MAIN_ID</code> al teclado que usaremos en el juego. En la <a href="version_5.html">Versi√≥n 5</a> podr√≠amos querer a√±adir m√°s teclados, y entonces habr√≠a que definir m√°s identificadores con otros nombres representativos.
3. Define el enumerado que identifica los √≠ndices de las columnas del teclado, y que ser√° de utilidad para hacer el c√≥digo m√°s legible en el manejo de las interrupciones.
4. Escribe los prototipos de las funciones p√∫blicas que aparecen en la API del fichero <code>port_keyboard.h</code>.
5. Puede ser buen momento ahora para documentar con Doxygen.</p>
</li>
</ol>
<h3 id="cabecera-stm32f4_keyboardh"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3.2</span> Cabecera stm32f4_keyboard.h<a class="headerlink" href="#cabecera-stm32f4_keyboardh" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera define los pines f√≠sicos a los que est√°n conectadas las filas y columnas de los teclados que usemos con nuestra placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</p>
<ol>
<li>Incluye todas las cabeceras necesarias.</li>
<li>
<p>Define (<code>#define</code>) los valores de las GPIO y pines para las 4 filas y las 4 columnas seg√∫n indica la <a href="#tbl:version2_keypad">tabla de caracter√≠sticas del teclado matricial</a>.</p>
</li>
<li>
<p>Declara la estructura <code>stm32f4_keyboard_hw_t</code> que contendr√° la configuraci√≥n f√≠sica del teclado.</p>
<p>Presta atenci√≥n a la documentaci√≥n que explica en cada campo qu√© deber√° contener. Recuerda que las filas son salidas y las columnas entradas.</p>
<p>Especial menci√≥n merecen los campos <code>p_row_ports</code> y <code>p_col_ports</code>, que <strong>son dobles punteros: punteros a arrays de punteros a estructuras</strong> <code>GPIO_TypeDef</code>. Estos campos permiten almacenar las referencias a los puertos GPIO de cada fila y columna del teclado. Esta es la forma de poder definir una estructura gen√©rica sin saber el tama√±o del teclado que va a gestionar. Nos da lo mismo que definamos un teclado de 2x2, 4x4 o 5x3; por eso estos campos son punteros que apuntar√°n a arrays de elementos de tipo <code>GPIO_TypeDef*</code> (por ejemplo, <code>GPIOA</code>, <code>GPIOB</code>, etc.). As√≠, podemos tener una lista din√°mica de puertos para las filas y columnas del teclado, adapt√°ndonos a cualquier configuraci√≥n f√≠sica que necesitemos.</p>
<p>El campo <code>p_layout</code> es un <strong>puntero a una estructura <code>keyboard_t</code>, que contiene el <a href="#sec:layouts_keyboards"><em>layout</em> del teclado</a></strong>. Esto nos permite asociar el dise√±o l√≥gico del teclado con su configuraci√≥n f√≠sica. Se declara <code>const</code> porque el <em>layout</em> no debe modificarse en tiempo de ejecuci√≥n.</p>
<p>F√≠jate tambi√©n que <strong>la estructura NO guarda la tecla pulsada</strong>, sino que guarda el √≠ndice de la fila que se est√° excitando y la columna que genera la interrupci√≥n. La gesti√≥n de la tecla pulsada se har√° en la FSM del teclado, que es independiente del HW.</p>
</li>
<li>
<p>Declara el array de estructuras de tipo <code>stm32f4_keyboard_hw_t</code> como se hizo con el bot√≥n. Este array contendr√° las caracter√≠sticas de todos los teclados que tengamos en el sistema.</p>
</li>
<li>
<p>Documenta todo con Doxygen.</p>
</li>
</ol>
<p>Ya hemos acabado con el encabezado (<em>header</em>) que interact√∫a con el HW. Todav√≠a dar√° errores al compilar. Vamos ahora a implementar todas las funciones prototipadas en <code>port_keyboard.h</code>.</p>
<h2 id="sec:port_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4</span> <code>PORT</code>: fuente de la librer√≠a del teclado<a class="headerlink" href="#sec:port_keyboard" title="Permanent link">¬∂</a></h2>
<p>Vamos a <em>portar</em> las funciones necesarias para controlar los pines del teclado. Programaremos los ficheros fuente de la parte <code>PORT</code>, que <strong>todos estar√°n en el fichero <code>stm32f4_keyboard.c</code></strong>.</p>
<h3 id="fuentes-stm32f4_keyboardc"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4.1</span> Fuentes stm32f4_keyboard.c<a class="headerlink" href="#fuentes-stm32f4_keyboardc" title="Permanent link">¬∂</a></h3>
<p>La complejidad aqu√≠ reside en la gesti√≥n de m√∫ltiples pines y en la l√≥gica de configuraci√≥n de entrada/salida.</p>
<ol>
<li>Incluye las librer√≠as necesarias.</li>
<li>Ver√°s que en la plantilla proporcionada se han definido 4 arrays que corresponden con laos puertos y pines de las filas y columnas del teclado. Estos arrays se usan para inicializar la estructura del teclado. Estos son los arrays de elementos <code>GPIO_TypeDef*</code> (y <code>uint8_t</code>) de los que hablabamos anteriormente y alos que apuntar√° la estructura <code>stm32f4_keyboard_hw_t</code> del teclado principal <code>KEYBOARD_MAIN</code>.</li>
<li>
<p>Define la <strong>variable global privada</strong> <code>stm32f4_keyboard_hw_t keyboards_arr</code> con la configuraci√≥n f√≠sica de nuestro teclado tal y como hicimos con el bot√≥n. Los campos <code>p_row_ports</code>, <code>p_row_pins</code>, <code>p_col_ports</code>, y <code>p_col_pins</code> deben apuntar a los arrays definidos en el paso anterior. El campo <code>p_layout</code> <strong>debe apuntar a la direcci√≥n de memoria</strong> del <em>layout</em> del teclado est√°ndar definido en <code>keyboards.c</code>. El resto de campos se inicializan en la funci√≥n <code>port_keyboard_init()</code>.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>_stm32f4_keyboard_get()</code> para recuperar la configuraci√≥n del hardware, de modo an√°logo a como se hizo para el bot√≥n.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>port_keyboard_init()</code> como se indica en la API.</p>
<p><span style="color: Red">Recuerda que es muy importante indicar en el modo de las interrupciones de las columnas del teclado que, <strong>adem√°s de detectar ambos flancos (subida y bajada), debe habilitar la petici√≥n de interrupci√≥n (registro <code>EXTI_IMR</code>)</strong></span>.</p>
<p>Se recomienda usar bucles para configurar las filas y columnas, y evitar el <em>spaghetti code</em>. Esto hace que el c√≥digo sea m√°s compacto y f√°cil de leer y mantener.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>port_keyboard_excite_row()</code> como se indica en la API. Esta funci√≥n debe <strong>activar la fila indicada y ¬°desactivar las restantes!</strong></p>
</li>
<li>
<p>Codifica la funci√≥n <code>port_keyboard_excite_next_row()</code> como se indica en la API. Esta funci√≥n llama a la anterior pero antes actualiza <code>current_excited_row</code>, que es el √≠ndice de la fila a ser excitada.</p>
</li>
<li>
<p>Codifica todos los <em>getters</em> y <em>setters</em> que aparecen en el <code>.h</code> como indica la API. Especial atenci√≥n a la funci√≥n <code>port_keyboard_get_key_value()</code>, que debe devolver el car√°cter ASCII correspondiente a la tecla pulsada, usando el <em>layout</em> del teclado.</p>
<p>Como en nuestra estructura <strong>no tenemos definida de manera fija el array del <em>layout</em> del teclado</strong>, sino que tenemos un puntero a una estructura <code>keyboard_t</code>, no podemos acceder directamente al array de teclas tratado como matriz bidimensional con los √≠ndices de la fila y columna. En su lugar, <strong>debemos tratar el array como unidimensional</strong> -que es, por otro lado, como est√° almacenado en memoria- y calcular la posici√≥n del caracter de la tecla pulsada usando la f√≥rmula:</p>
<div class="highlight"><pre><span></span><code><span class="n">key</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">excited</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="n">columns</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="n">interrupting</span>
</code></pre></div>
<p>Vamos a codificar ahora las funciones que gestionan el temporizador que controla la excitaci√≥n de las filas.</p>
<p></p><div id="tbl:version2_timer"></div><p></p>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong>Par√°metro</strong></th>
<th style="text-align: center;"><strong>Valor</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Temporizador</td>
<td style="text-align: center;"><code>TIM5</code></td>
</tr>
<tr>
<td style="text-align: left;">Prescaler</td>
<td style="text-align: center;">(a calcular para <code>PORT_KEYBOARDS_TIMEOUT_MS</code>)</td>
</tr>
<tr>
<td style="text-align: left;">Periodo</td>
<td style="text-align: center;">(a calcular para <code>PORT_KEYBOARDS_TIMEOUT_MS</code>)</td>
</tr>
<tr>
<td style="text-align: left;">ISR</td>
<td style="text-align: center;"><code>TIM5_IRQHandler</code></td>
</tr>
<tr>
<td style="text-align: left;">Prioridad</td>
<td style="text-align: center;">2</td>
</tr>
<tr>
<td style="text-align: left;">Subrioridad</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Codifica la funci√≥n <code>_timer_scan_column_config()</code> como indica la API. Esta funci√≥n configura el <em><em>temporizador que controla el tiempo de excitaci√≥n de las filas de cualquier teclado que se monte en el juego; si hubiese m√°s de uno, todos se excitar√≠an a la vez. Para ello, ap√≥yate en el ejemplo </em>"timer para interrupci√≥n peri√≥dica"</em> del libro de fundamentos te√≥ricos¬†<sup id="fnref2:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup>.</p>
<p>Esta funci√≥n configura un temporizador para que genere una interrupci√≥n de <code>PORT_KEYBOARDS_TIMEOUT_MS</code> milisegundos desde que se habilita el mismo. El temporizador elegido se muestra en la <a href="#tbl:version2_timer">tabla de caracter√≠sticas del teclado</a>.</p>
<p>Lo vamos a usar para que genere interrupciones peri√≥dicas. Lo activaremos cuando durante el juego sea turno del jugador que use el teclado matricial, y lo desactivaremos cuando se est√© reproduciendo la secuencia de colores.</p>
<p>Para saber qu√© fuente de reloj habilitar para el temporizador, consulta la tabla <em>"Figure 3. STM32F446xC/E block diagram"</em> del <em>datasheet "STM32F446xC/E"</em>¬†<sup id="fnref:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">4</a></sup>. All√≠ podr√°s ver si nuestro temporizador est√° conectado al <strong>APB1</strong> o al <strong>APB2</strong>, y tenemos que habilitar el reloj en el registro <code>RCC-&gt;APB1ENR</code> o <code>RCC-&gt;APB2ENR</code> respectivamente.</p>
<p>Es importante que no pongas los valores de los registros de configuraci√≥n del temporizador a mano, sino que uses las ecuaciones que se proporcionan en el libro de fundamentos te√≥ricos¬†<sup id="fnref3:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup> para calcular los valores de los registros <code>TIMx-&gt;PSC</code> y <code>TIMx-&gt;ARR</code>. En cualquier momento podr√≠amos querer cambiar el periodo de excitaci√≥n de filas y, si lo hacemos a mano, podr√≠amos cometer errores, adem√°s de que es menos legible.</p>
<p>**Es muy importante que la funci√≥n <code>_timer_scan_column_config()</code> se llame desde la funci√≥n <code>port_keyboard_init()</code>. Si no, no se podr√°n generar interrupciones para excitar filas y leer columnas.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>port_keyboard_start_scan()</code> que se encarga de habilitar las interrupciones del temporizador y activar la cuenta (reseteando el contador). En esta funci√≥n se resetea el flag <code>flag_row_timeout</code>, y se excita la primera fila del teclado.</p>
</li>
<li>Codifica la funci√≥n <code>port_keyboard_stop_scan()</code> que deshabilita las interrupciones del temporizador y detiene la cuenta. Del mismo modo, apaga todas las filas del teclado.</li>
</ol>
<p>**¬°Ya hemos acabado con la implementaci√≥n de la parte HW <code>stm32f\_keyboard.c</code> del teclado. Ahora solo queda la ISR asociada a dicho temporizador en el fichero `interr.c``. Vamos a ello.</p>
<h3 id="interrc"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4.2</span> interr.c<a class="headerlink" href="#interrc" title="Permanent link">¬∂</a></h3>
<p>Abre el fichero <code>interr.c</code>. Tenemos que codificar las <a href="acronimos.html#acro:ISR"><strong>ISR</strong></a> para gestionar las interrupciones de cada una de las columnas y del temporizador de excitaci√≥n de filas.</p>
<p>Es muy importante que notes que algunas  est√°n compartidas <a href="acronimos.html#acro:ISR"><strong>ISR</strong></a> por distintas l√≠neas. Esto ya lo vimos en la <a href="version_1.html#sec:interr_button">Versi√≥n 1 con el bot√≥n</a>. Por ejemplo la ISR <code>EXTI15_10_IRQHandler()</code> gestiona las interrupciones de las l√≠neas 10 a la 15 <strong>de cualquier <a href="acronimos.html#acro:GPIO">GPIO</a></strong>, y es por ello que hab√≠amos puesto un <code>if</code> para identificar la fuente. Es ahora cuando le vas a encontrar m√°s sentido a ese bloque condicional.</p>
<p>F√≠jate en las <a href="acronimos.html#acro:ISR"><strong>ISR</strong></a> de las interrupciones de las columnas del teclado matricial en la <a href="#tbl:version2_keypad">tabla de caracter√≠sticas del teclado</a>: 2 de las columnas comparten <a href="acronimos.html#acro:ISR"><strong>ISR</strong></a>, y otra de ellas la comparte con el bot√≥n. Vamos a codificar dichas <a href="acronimos.html#acro:ISR"><strong>ISR</strong></a>:</p>
<ol>
<li>
<p>Completa la ISR <code>EXTI15_10_IRQHandler</code> para gestionar la interrupci√≥n de la columna <code>PORT_KEYBOARD_COL_1</code> (la segunda) del teclado matricial. Recuerda que esta ISR tambi√©n gestiona la interrupci√≥n del bot√≥n, por lo que debes mantener el bloque condicional <code>if</code> que ya estaba implementado.</p>
<p>F√≠jate, en la API, en el <em>TODO</em> para Versi√≥n 2.</p>
<div class="admonition note funci√≥n auxiliar">
<p class="admonition-title">Note</p>
<p>Tanto esta ISR como las siguientes hacen llamadas la funci√≥n privada <code>_check_column_interrupt()</code>, que se encargar√° de gestionar el flag de pulsaci√≥n de tecla y guardar el √≠ndice de la columna que ha generado la interrupci√≥n. <strong>Esta funci√≥n auxiliar es opcional implementarla, pero hace el c√≥digo m√°s legible y evita repetir c√≥digo.</strong> Si no quieres implementarla, aseg√∫rate de hacer en cada ISR de cada columna lo que la API indica para esta funci√≥n.</p>
<p>Si quieres implementar <code>_check_column_interrupt()</code>, hazlo ahora. Debes colocarla antes de cualquier funci√≥n que la use.</p>
</div>
<p>Esta ISR, cuando salta, se encarga de llamar a la funci√≥n correspondiente para <em>settear</em> el estado del flag de pulsaci√≥n de tecla y guardar el √≠ndice de la columna que ha generado la interrupci√≥n.</p>
</li>
<li>
<p>Codifica la ISR <code>EXTI9_5_IRQHandler</code> para gestionar las interrupciones de las columnas <code>PORT_KEYBOARD_COL_0</code> (la primera) y <code>PORT_KEYBOARD_COL_3</code> (la cuarta) del teclado matricial. Esta ISR gestiona las interrupciones de dos l√≠neas del teclado matricial, por lo que debes mantener un bloque condicional <code>if</code> como en de la ISR anterior.</p>
</li>
<li>
<p>Codifica la ISR <code>EXTI4_IRQHandler</code> para gestionar la interrupci√≥n de la columna <code>PORT_KEYBOARD_COL_2</code> (la tercera) del teclado matricial. Como esta ISR no est√° compartida entre l√≠neas del <code>EXTI</code>, no es necesario un bloque condicional.</p>
</li>
<li>
<p>Por √∫ltimo, codifica la ISR <code>TIM5_IRQHandler</code> como se indica en la API. Recuerda que las ISR no reciben ni devuelven nada.</p>
<p>Esta ISR, cuando salta, se encarga de llamar a la funci√≥n correspondiente para <em>settear</em> el estado del flag de <em>timeout</em> que permitir√° excitar la siguiente fila del teclado.</p>
</li>
<li>
<p>Si queda algo por documentar puede ser buen momento ahora.</p>
</li>
</ol>
<p>Si ahora compilas, el c√≥digo no deber√≠a tener ning√∫n error. <strong>¬°Ya hemos acabado con la implementaci√≥n de <em>portado</em> de excitaci√≥n de filas para lectura de teclas en un teclado matricial!</strong>. Vamos a probarlo con el <em>test</em> unitario de la parte <code>PORT</code> para esta parte.</p>
<h2 id="sec:test_port_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.5</span> <code>PORT</code>: Test unitario del teclado matricial<a class="headerlink" href="#sec:test_port_keyboard" title="Permanent link">¬∂</a></h2>
<p>Vamos a comprobar que la parte <code>PORT</code> funciona correctamente pasando los test HW del c√≥digo que hemos desarrollado antes de continuar.</p>
<p><span style="color: Red"><strong>¬°Importante! Los test que se proporcionan comprueban solo algunos aspectos esenciales, pero no son exhaustivos. Es responsabilidad del alumno comprobar que el sistema final funciona correctamente.</strong></span> <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/gen_book_icon.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/gen_book_icon.png"/></a>¬†Ten a mano y revisa el cap√≠tulo <em>‚ÄúTest unitarios y ejemplos de integraci√≥n‚Äù</em> del libro de fundamentos te√≥ricos¬†<sup id="fnref:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup>.</p>
<p>Descarga el fichero de test HW del teclado <code>test_port_keyboard.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2_test">https://github.com/sdg2DieUpm/simone/tree/simone_v2_test</a>. Ponlo en la carpeta <code>test/stm32f4</code> de tu proyecto.</p>
<ol>
<li>
<p>Conecta la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono de depuraci√≥n <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_debug.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_debug.png"/></a> y selecciona <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_run.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_run.png"/></a> Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>test_port_keyboard</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Comprueba que todos los test pasan correctamente en el texto mostrado en la terminal de depuraci√≥n. Si no es as√≠, lee los mensajes de error y corrige tu c√≥digo hasta que pase todas las pruebas. <strong>Si no pasa las pruebas, no contin√∫es programando, corrigelas.</strong></p>
</li>
<li>
<p>Termina la depuraci√≥n pulsando (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_stop.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_stop.png"/></a>) y repite el proceso hasta que pase todos los test.</p>
</li>
</ol>
<p><strong>¬°Ya hemos acabado con la parte <code>PORT</code> del teclado!</strong> Vamos ahora a implementar la parte <code>COMMON</code> de la librer√≠a del teclado.</p>
<h2 id="common-cabecera-de-la-fsm-del-teclado"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.6</span> <code>COMMON</code>: cabecera de la FSM del teclado<a class="headerlink" href="#common-cabecera-de-la-fsm-del-teclado" title="Permanent link">¬∂</a></h2>
<h3 id="consideraciones-de-la-fsm-del-teclado"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.6.1</span> Consideraciones de la FSM del teclado<a class="headerlink" href="#consideraciones-de-la-fsm-del-teclado" title="Permanent link">¬∂</a></h3>
<p>Antes de ponernos a programar, conviene explicar algunos aspectos importantes de la FSM del teclado matricial.</p>
<ul>
<li>
<p>La FSM <strong>almacena el caracter <code>char</code> de la √∫ltima  tecla pulsada</strong>.</p>
</li>
<li>
<p>El usuario debe solicitar/¬†comprobar el caracter mediante la funci√≥n <code>fsm_keyboard_get_key_value()</code>.</p>
</li>
<li>
<p>El valor de inicio del caracter al arrancar la FSM, y el valor de reinicio, debe ser le valor de tecla inv√°lida que haya definido el <em>layout</em> del teclado. En nuestro caso, el valor de tecla inv√°lida es el caracter nulo <code>'\0'</code>, que est√° definido en la estructura <code>keyboard_t</code> del <em>layout</em> del teclado. En otro teclado podr√≠a ser otro, por lo que no hay que poner este valor <em>a pincho</em>, sino el que nos devuelva <code>port_keyboard_get_invalid_key_value()</code>.</p>
<p>¬°Ojo! üëÅ <strong>¬°Al inicializar la FSM, hay que inicializar el <code>port_keyboard_init()</code>, porque de lo contrario, no podremos leer qu√© tecla es inv√°lida seg√∫n el <em>layout</em>!</strong></p>
</li>
<li>
<p><strong>Un valor de <code>invalid_key</code> significa que no ha habido una nueva pulsaci√≥n del teclado.</strong></p>
</li>
<li>
<p><strong>El usuario debe reiniciar el valor de tecla pulsada una vez le√≠do</strong>, de lo contrario, este valor puede ser malinterpretado por el usuario si se realizan sucesivas comprobaciones sin haber pulsado el teclado. Es an√°logo a lo que hac√≠amos con el bot√≥n.  Para reiniciar el valor se debe llamar a la funci√≥n <code>fsm_keyboard_reset_key_value()</code>.</p>
</li>
<li>
<p>La FSM contiene informaci√≥n del identificador (<code>ID</code>) del teclado que maneja. Este <code>ID</code> es √∫nico y gestionado por el usuario en el <code>PORT</code>. Ah√≠ es donde el usuario proporciona identificadores e informaci√≥n HW (GPIOs a la que est√° conectado y tiempo de anti-rebotes) para todos los teclados de su sistema.</p>
</li>
</ul>
<figure><embed id="fig:fsm_keyboard" src="../assets/notebook_imgs/pr_chapters/version_2/fsm_keyboard.png" style="width:100.0%"/><figcaption aria-hidden="true">M√°quina de estados del teclado matricial.</figcaption></figure>
<p>Nuestra librer√≠a implementa la l√≥gica de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> mostrada en el <a href="#fig:fsm_keyboard">diagrama de la figura</a> y que llamaremos <code>fsm_keyboard</code> (en los ficheros <code>.c</code> y <code>.h</code>). Es an√°loga a la del bot√≥n, salvo por una <strong>autotransici√≥n</strong> en el primer estado. Tiene 4 estados porque <strong>implementa tambi√©n un mecanismo anti-rebotes SW</strong>. Nos centramos en la descripci√≥n de ese primer estado y su autotransici√≥n, para el resto, vaya la descripci√≥n hecha en <a href="version_1.html#sec:consideraciones_fsm_button">las consideraciones de la FSM del bot√≥n</a>:</p>
<ul>
<li>
<p><code>KEYBOARD_RELEASED_WAIT_ROW</code>: es el estado inicial de la m√°quina de estados, y es al estado al que vuelve cuando se pulsa ¬°y se suelta! una tecla. En este estado, adem√°s, se comprueba si ha pasado el <em>timeout</em> de excitaci√≥n de filas (flag <code>flag_row_timeout</code>), y si es as√≠, se excita la siguiente fila del teclado, <strong>permaneciendo en este estado (autotransici√≥n)</strong>. Esta excitaci√≥n se hace llamando a la funci√≥n <code>port_keyboard_excite_next_row()</code>. Si, durante la excitaci√≥n de una fila, se detecta una interrupci√≥n de subida en alguna columna, se guardar√° el <em>tick</em> de tiempo en el que se puls√≥ la tecla; transcurrido el tiempo suficiente para evitar rebotes, al soltar y producirse una interrupci√≥n en flanco de bajada, se llamar√° a <code>do_set_key_value()</code> que  guardar√° la tecla pulsada tras ped√≠rselo al <code>PORT</code>.</p>
<p><strong>Ser√° el usuario en su programa principal quien deba reiniciar el valor de tecla pulsada una vez le√≠do, llamando a la funci√≥n <code>fsm_keyboard_reset_key_value()</code></strong>, como se hac√≠a con el bot√≥n.</p>
</li>
</ul>
<p>La parte <code>COMMON</code> de nuestra librer√≠a trabaja con la estructura (<code>struct</code>) <strong>p√∫blica</strong> que se muestra en la <a href="#fig:fsm_keyboard_t">figura (b) de estructuras</a>.</p>
<ol>
<li>
<p>Descarga del repositorio los ficheros correspondientes <strong>a la parte COMMON</strong> de la librer√≠a del <em>teclado</em> correspondientes a la versi√≥n <code>V2</code>: <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2">https://github.com/sdg2DieUpm/simone/tree/simone_v2</a>. Solo descarga lo que faltaba por implementar, es decir, los ficheros <code>fsm_keyboard.h</code> y <code>fsm_keyboard.c</code> y ponlos en las carpetas correspondientes de tu proyecto.</p>
<p>Ahora, vamos a completar la cabecera de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> del teclado, <code>fsm_keyboard.h</code>.</p>
</li>
<li>
<p>Incluye las librer√≠as necesarias, si falta alguna, seg√∫n indique la API.</p>
</li>
<li>
<p>Escribe el <code>enum</code> <code>FSM_KEYBOARD</code> con los nombres de los estados del diagrama de la separados por <code>,</code>. <strong>No olvides poner un <code>;</code> al final del <code>enum</code>.</strong></p>
</li>
<li>
<p><strong>Declara</strong> la estructura <code>fsm_keyboard_t</code> para hacerla p√∫blica como indica la <a href="#fig:fsm_keyboard_t">figura de la estructura de la FSM</a>, y documenta cada campo con Doxygen.</p>
<p>Continuamos con las declaraciones de funciones p√∫blicas de la librer√≠a. <strong>Procedamos</strong>:</p>
</li>
<li>
<p>Escribe los prototipos de las <strong>funciones p√∫blicas</strong> que aparecen en la API del fichero <code>fsm_keyboard.h</code> y documenta cada funci√≥n con Doxygen. Recuerda que la documentaci√≥n va encima del nombre de cada funci√≥n.</p>
</li>
</ol>
<p>Ya hemos acabado con el encabezado. Quiz√°s de errores al compilar. Vamos ahora a programar el fichero fuente <code>fsm_keyboard.c</code>.</p>
<h2 id="sec:fsm_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.7</span> <code>COMMON</code>: fuente de la FSM del teclado<a class="headerlink" href="#sec:fsm_keyboard" title="Permanent link">¬∂</a></h2>
<p>Vamos a proceder con la implementaci√≥n de las funciones del <em>teclado</em>. Deber√°s implementar todas las <strong>funciones p√∫blicas</strong> de las que ya has declarado el prototipo en el encabezado, y el resto de <strong>funciones privadas</strong> que aparecen en la API del fichero <code>fsm_keyboard.c</code>. Tambi√©n definiremos las variables globales y estructuras que sean necesarias. <strong>¬°Recuerda que las funciones privadas no se declaran en el <code>.h</code>!</strong></p>
<ol>
<li>
<p>Incluye las cabeceras que indica la API.</p>
<p>Ahora empezamos a codificar las <strong>funciones privadas de entrada o comprobaci√≥n de la FSM <code>check_</code></strong>.</p>
</li>
<li>
<p>Codifica las funciones <code>check_row_timeout()</code>, <code>check_keyboard_pressed()</code>, <code>check_keyboard_released()</code>, y <code>check_timeout()</code> como se indica en la API.</p>
<p>Puede ser buen momento ahora para documentar las funciones con Doxygen. En este caso, como las funciones no est√°n declaradas en el encabezado, la documentaci√≥n ir√° en el <code>.c</code>, encima del nombre de cada funci√≥n.</p>
</li>
<li>
<p>Codifica las funciones <code>do_excite_next_row()</code>, <code>do_store_tick_pressed()</code>, <code>do_clear_key_value()</code>, y <code>do_set_key_value()</code> como se indica en la API.</p>
<p>Documenta las funciones con Doxygen igual que antes.</p>
</li>
<li>
<p>Definimos <code>static fsm_trans_t fsm_trans_keyboard[] = ...</code> justo despu√©s de la funci√≥n <code>do_set_key_value()</code> siguiendo el <a href="#fig:fsm_keyboard">diagrama de la FSM</a>.</p>
<p>Recuerda que debe haber una fila en la tabla por cada flecha de transici√≥n entre estados de la forma: <code>EstadoIni, FuncCompruebaCondicion, EstadoSig, FuncAccionesSiTransicion</code>. No olvides a√±adir la fila <code>-1, NULL, -1, NULL</code>. No olvides que el <code>EstadoIni</code> de la primera transici√≥n es el estado inicial de la FSM.</p>
</li>
<li>
<p>Codifica las funciones <code>fsm_keyboard_start_scan()</code>, <code>fsm_keyboard_stop_scan()</code>, <code>fsm_keyboard_get_key_value()</code>, y <code>fsm_keyboard_get_is_valid_key()</code> como se indica en la API. Con esta √∫ltima funci√≥n, el usuario podr√° comprobar si la √∫ltima tecla pulsada es v√°lida o no.</p>
<p>Codifica tambi√©n la funci√≥n <code>fsm_keyboard_reset_key_value()</code> con la que el usuario podr√° reiniciar el valor de la tecla pulsada a <code>invalid_key</code> tras leerla.</p>
</li>
<li>
<p>Completa la funci√≥n <code>fsm_keyboard_init()</code> como se indica en la API.</p>
</li>
<li>
<p>Codifica la funci√≥n <code>fsm_keyboard_fire()</code> de manera an√°loga a <a href="version_1.html#sec:fsm_button_c">como se hizo en la FSM del bot√≥n</a>.</p>
</li>
<li>
<p>Documenta el c√≥digo que est√© sin comentar.</p>
</li>
</ol>
<p><strong>Ya hemos acabado con la programaci√≥n de la librer√≠a del teclado.</strong> Toda esta l√≥gica <code>COMMON</code> <strong>puede ser usada en cualquier sistema</strong>. Hemos hecho una librer√≠a de un teclado que tiene un anti-rebotes y nos devuelve el valor de la √∫ltima tecla pulsada. As√≠ pues, si compilas, no deber√≠an aparecer errores.</p>
<h2 id="sec:test_fsm_v2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.8</span> <code>COMMON</code> Test unitario de la FSM del teclado<a class="headerlink" href="#sec:test_fsm_v2" title="Permanent link">¬∂</a></h2>
<p>Vamos a probar el test del c√≥digo que hemos desarrollado de la librer√≠a de la m√°quina de estados del teclado y probar que funciona antes de continuar con la siguiente versi√≥n.
<span style="color: Red"><strong>¬°Importante! Recuerda que los test que se proporcionan comprueban solo algunos aspectos esenciales, pero no son exhaustivos. Es responsabilidad del alumno comprobar que el sistema final funciona correctamente.</strong></span></p>
<p>Descarga el fichero de test de la FSM del teclado <code>test_fsm_keyboard.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2_test">https://github.com/sdg2DieUpm/simone/tree/simone_v2_test</a>. Ponlo en la carpeta <code>test/</code> de tu proyecto. <strong>¬°No lo metas en stm32f4/, pues no es un test espec√≠fico del microcontrolador!</strong></p>
<ol>
<li>
<p>Con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>¬†conectada al ordenador.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>test_fsm_keyboard</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Ejecuta el test por completo, o pon puntos de parada si deseas ir paso a paso.</p>
</li>
<li>
<p>Se habr√° impreso por la terminal del <code>gdb-server</code> el resultado de las pruebas de los tests. Deber√≠a haber pasado todos los tests. Si no, lee el mensaje de error y corrige tu c√≥digo hasta que pasen todas las pruebas. <strong>Si no pasan las pruebas, no contin√∫es.</strong></p>
</li>
<li>
<p>Termina la depuraci√≥n pulsando (<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_stop.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_stop.png"/></a>) y repite el proceso hasta que pasen todos los test.</p>
</li>
</ol>
<h2 id="ejemplo-de-uso-de-la-version-2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.9</span> Ejemplo de uso de la Versi√≥n 2<a class="headerlink" href="#ejemplo-de-uso-de-la-version-2" title="Permanent link">¬∂</a></h2>
<p>El test de integraci√≥n no hace uso de la librer√≠a <code>unity</code>, sino que es como un peque√±o programa de prueba sobre las funciones que hemos implementado y tiene su propio <code>main</code>.</p>
<p>En los test de integraci√≥n es responsabilidad del alumno comprobar que la funcionalidad es la esperada, porque aqu√≠ no hay test unitarios que nos ayuden.</p>
<p>Nuestra librer√≠a de teclado devuelve el valor de la √∫ltima tecla pulsada. As√≠ pues, algunas de las comprobaciones que podemos hacer son: que todas las teclas de todas las columnas aparecen impresas por pantalla, que se reinicia adecuadamente el valor tras leerlo, que funciona el anti-rebotes‚Ä¶</p>
<p>Descarga el fichero de ejemplo <code>example_v2.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2_test">https://github.com/sdg2DieUpm/simone/tree/simone_v2_test</a>. Ponlo en la carpeta <code>example/</code> de tu proyecto.</p>
<p><strong>Procedamos</strong>:</p>
<p>Para poder hacer el ejemplo del teclado matricial, necesitamos conectarlo como se muestra en el montaje de la <a href="#fig:fritzing_keyboard">figura</a>. <strong>F√≠jate que las filas son los pines  de la izquierda si miramos el teclado de frente</strong>. </p>
<ol>
<li>
<p>Monta el circuito del teclado matricial como se muestra en la <a href="#fig:fritzing_keyboard">figura</a>.</p>
</li>
<li>
<p>Pulsa sobre el <strong>icono de depuraci√≥n <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_debug.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_debug.png"/></a> y selecciona <a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../assets/notebook_imgs/general/icon_run.png"><img alt="image" class="inline-img" src="../assets/notebook_imgs/general/icon_run.png"/></a> Clean and Debug</strong> sobre la plataforma que queramos depurar (<code>stm32f446re</code>).</p>
</li>
<li>
<p>En el desplegable que se abre, selecciona el test <code>example_v2</code>. Se compilar√° y se cargar√° en la placa.</p>
</li>
<li>
<p>Se parar√° en la primera l√≠nea del <code>main()</code>. Ejecuta el test por completo, o pon puntos de parada si deseas ir paso a paso. Este c√≥digo no termina, pues es un bucle <code>while</code> infinito.</p>
</li>
<li>
<p>Abre la terminal del <code>gdb-server</code> para ver los mensajes que se van imprimiendo.</p>
</li>
<li>
<p>Pulsa una a una todas las teclas del teclado.Deber√≠as ver que se imprime por pantalla el caracter de la pulsaci√≥n. Si no es as√≠, revisa tu c√≥digo.</p>
</li>
<li>
<p>Haz distintas pruebas y aseg√∫rate de que el comportamiento es el adecuado.</p>
</li>
</ol>
<p>¬°Hemos creado nuestra primera librer√≠a! F√≠jate que es <em>portable</em> a cualquier plataforma solo con adaptar las funciones del <code>PORT</code>.</p>
<p>No dejes de documentar el c√≥digo. <strong>Comprueba que la documentaci√≥n del c√≥digo se ha generado correctamente como se explica en la <em>‚ÄúGu√≠a de instalaci√≥n de herramientas para compilaci√≥n multiplataforma en C‚Äù</em>¬†<sup id="fnref:stm322025guiainstalacion"><a class="footnote-ref" href="#fn:stm322025guiainstalacion">6</a></sup>.</strong>, o en el v√≠deo <a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">"[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen‚Äù</a>.</p>
<p>Guarda una copia de su proyecto como <code>simone_v2</code> para tener un punto de partida para la siguiente versi√≥n, y una copia de seguridad por si algo falla.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>Por ejemplo, un teclado de ordenador, una calculadora, un cajero autom√°tico, etc. No nos hacemos responsables de posibles da√±os que pueda ocasionar üòÖ.¬†<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">‚Ü©</a></p>
</li>
<li id="fn:2">
<p>Para un mejor contacto, el circuito de la imagen son dos pistas de cobre en zig-zag que se cortocircuitan al pulsar el bot√≥n. Lo m√°s simple ser√≠a una cruz que no se toca, pero su contacto es menos fiable. En teclados m√°s avanzados, puede haber circuitos adicionales para mejorar la durabilidad o la respuesta t√°ctil.¬†<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025fundamentos">
<p>Josu√© Pag√°n Ortiz, Pedro Jos√© Malag√≥n Marzo, Rom√°n C√°rdenas Rodr√≠guez, and Juan Jos√© G√≥mez Valverde. <em>Fundamentos te√≥ricos de sistemas basados en microcontrolador STM32. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Josu√© Pag√°n Ortiz, Madrid, March 2025. URL: <a href="https://oa.upm.es/88460/">https://oa.upm.es/88460/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref2:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref3:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref4:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021datasheet">
<p>STMicroelectronics. Stm32f446xc/e. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/datasheet/stm32f446re.pdf">https://www.st.com/resource/en/datasheet/stm32f446re.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021datasheet" title="Jump back to footnote 4 in the text">‚Ü©</a><a class="footnote-backref" href="#fnref2:st2021datasheet" title="Jump back to footnote 4 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021reference">
<p>STMicroelectronics. Rm0390 reference manual. stm32f446xx advanced arm-based 32-bit mcus. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021reference" title="Jump back to footnote 5 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025guiainstalacion">
<p>Josu√© Pag√°n Ortiz, Pedro Jos√© Malag√≥n Marzo, Rom√°n C√°rdenas Rodr√≠guez, Amadeo de Gracia Herranz, Sergio Esteban Romero, and Daniel Capell√°n Mart√≠n. <em>Gu√≠a de instalaci√≥n de herramientas para compilaci√≥n multiplataforma en C. Sistemas Digitales II, Sistemas Electr√≥nicos</em>. Josu√© Pag√°n Ortiz, Madrid, March 2025. URL: <a href="https://oa.upm.es/92376/">https://oa.upm.es/92376/</a>.¬†<a class="footnote-backref" href="#fnref:stm322025guiainstalacion" title="Jump back to footnote 6 in the text">‚Ü©</a></p>
</li>
</ol>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Volver al principio
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
<script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>