
<!DOCTYPE html>

<html class="no-js" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://sdg2dieupm.github.io/simone/notebook/version_2.html" rel="canonical"/>
<link href="version_1.html" rel="prev"/>
<link href="version_3.html" rel="next"/>
<link href="../assets/general/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Versi√≥n 2 - Laboratorio de Sistemas Digitales II</title>
<link href="../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/notebook-extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="deep_orange" data-md-color-primary="blue_grey" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cha:version2">
          Saltar a contenido
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Cabecera" class="md-header__inner md-grid">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-header__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Laboratorio de Sistemas Digitales II
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Versi√≥n 2
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Cambiar a modo oscuro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Cambiar a modo oscuro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Cambiar a modo claro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Cambiar a modo claro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="B√∫squeda" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="B√∫squeda" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Buscar" class="md-search__options">
<button aria-label="Limpiar" class="md-search__icon md-icon" tabindex="-1" title="Limpiar" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navegaci√≥n" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-nav__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
    Laboratorio de Sistemas Digitales II
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../index.html">
<span class="md-ellipsis">
    Portada
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Introducci√≥n general
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introducci√≥n general
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="intro.html">
<span class="md-ellipsis">
    Introducci√≥n a SDG2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="sesion_introduccion.html">
<span class="md-ellipsis">
    Sesi√≥n de introducci√≥n
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    Proyecto
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Proyecto
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="version_0.html">
<span class="md-ellipsis">
    Versi√≥n 0
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_1.html">
<span class="md-ellipsis">
    Versi√≥n 1
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Versi√≥n 2
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="version_2.html">
<span class="md-ellipsis">
    Versi√≥n 2
    
  </span>
</a>
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#caracteristicas-del-teclado-matricial-en-version-2">
<span class="md-ellipsis">
      Caracter√≠sticas del teclado matricial en Versi√≥n 2
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:layouts_keyboards">
<span class="md-ellipsis">
      Layouts de teclados matriciales
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_keyboard">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_keyboard">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v2">
<span class="md-ellipsis">
      PORT: Test unitario del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-fuente-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v2">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-2">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 2
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_3.html">
<span class="md-ellipsis">
    Versi√≥n 3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_4.html">
<span class="md-ellipsis">
    Versi√≥n 4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_5.html">
<span class="md-ellipsis">
    Versi√≥n 5
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    API
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            API
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/index.html">
<span class="md-ellipsis">
    Documentaci√≥n API
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    Ap√©ndices
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Ap√©ndices
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="bom.html">
<span class="md-ellipsis">
    BOM
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Acr√≥nimos
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="acronimos.html">
<span class="md-ellipsis">
    Acr√≥nimos
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#caracteristicas-del-teclado-matricial-en-version-2">
<span class="md-ellipsis">
      Caracter√≠sticas del teclado matricial en Versi√≥n 2
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:layouts_keyboards">
<span class="md-ellipsis">
      Layouts de teclados matriciales
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_keyboard">
<span class="md-ellipsis">
      PORT: cabeceras de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_keyboard">
<span class="md-ellipsis">
      PORT: fuente de la librer√≠a del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v2">
<span class="md-ellipsis">
      PORT: Test unitario del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-fuente-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v2">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-2">
<span class="md-ellipsis">
      Ejemplo de uso de la Versi√≥n 2
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cha:version2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.</span> Versi√≥n 2: teclado matricial<a class="headerlink" href="#cha:version2" title="Permanent link">¬∂</a></h1>
<p>En la versi√≥n anterior aprendimos a gestionar un √∫nico bot√≥n mediante interrupciones. Sin embargo, ¬øqu√© ocurre si nuestro sistema necesita 12, 16 o m√°s botones? Si utiliz√°ramos la estrategia anterior, necesitar√≠amos una l√≠nea de interrupci√≥n y un pin GPIO por cada bot√≥n, agotando r√°pidamente los recursos del microcontrolador.</p>
<p>Para solucionar esto, utilizamos la t√©cnica del <strong>barrido</strong> o <em>scanning</em> en un teclado matricial. Esta t√©cnica aprovecha la persistencia temporal para leer muchos pulsadores utilizando pocos pines, organiz√°ndolos en filas y columnas.</p>
<div class="admonition example">
<p class="admonition-title">Bibliograf√≠a</p>
<ol>
<li>
<p><em>‚ÄúFundamentos te√≥ricos de sistemas basados en microcontrolador STM32‚Äù</em>¬†<sup id="fnref:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">3</a></sup></p>
</li>
<li>
<p><em>Datasheet ‚ÄúSTM32F446xC/E‚Äù</em>¬†<sup id="fnref:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">4</a></sup></p>
</li>
<li>
<p><em>Reference manual ‚ÄúRM0390. STM32F446xx advanced Arm-based 32-bit MCUs‚Äô</em>¬†<sup id="fnref:st2021reference"><a class="footnote-ref" href="#fn:st2021reference">5</a></sup></p>
</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title"><a href="https://www.youtube.com/channel/UCYIw_gl745WMJ1n0MamDzQw/">V√≠deos del canal de SDGII</a></p>
<ul>
<li>
<p><a href="#TO-DO">Demostraci√≥n Simone</a></p>
</li>
<li>
<p><a href="https://youtu.be/CcbgLVfCXrw?si=A8DP1rescxJNBEb9">Blink LED y manejo de proyecto</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLTFFovUxjNnn19myGVw1kwh6GPbRxwIcC">Conceptos b√°sicos de C (canal SDG1)</a></p>
</li>
<li>
<p><a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">[MatrixMCU] Documentaci√≥n de c√≥digo con Doxygen</a></p>
</li>
</ul>
</div>
<p>En este cap√≠tulo vamos a crear una librer√≠a que nos permita gestionar un teclado matricial de 4x4 (16 teclas). A diferencia del bot√≥n, que funcionaba solo ten√≠amos una interrupci√≥n, aqu√≠ <strong>utilizaremos un temporizador que nos interrumpe para realizar una excitaci√≥n peri√≥dica de las filas y esperaremos interrupciones de las columnas.</strong></p>
<p>Como ya hicimos en las versiones anteriores, (i) vamos a implementar la parte <em>portable</em> <code>PORT</code> dependiente del <strong><a href="acronimos.html#acro:HW">HW</a></strong> para gestionar los niveles l√≥gicos de las filas y la lectura de las columnas, y lo probaremos con un test unitario. (ii) Despu√©s, vamos a crear la l√≥gica de la <strong><a href="acronimos.html#acro:FSM">FSM</a></strong> para gestionar el barrido y el <em>anti-rebotes</em> (la parte <code>COMMON</code>), y lo probaremos con un test unitario. (iii) Por √∫ltimo, montaremos el <strong><a href="acronimos.html#acro:HW">HW</a></strong> y probaremos el funcionamiento con un programa de ejemplo.</p>
<p>El teclado matricial es un array de pulsadores conectados en intersecciones de filas y columnas. Cuando no se pulsa ninguna tecla, no hay conexi√≥n entre filas y columnas. Al pulsar una tecla, se cortocircuita una fila con una columna espec√≠fica. Las caracter√≠sticas a destacar del sistema de la Versi√≥n 2 se muestran en la <a href="#tbl:version2_keypad">siguiente tabla</a>.</p>
<div id="tbl:version2_keypad"></div>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong>Par√°metro</strong></th>
<th style="text-align: center;"><strong>Valor</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Pin fila 1</td>
<td style="text-align: center;"><code>PA0</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin fila 2</td>
<td style="text-align: center;"><code>PA1</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin fila 3</td>
<td style="text-align: center;"><code>PA4</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin fila 4</td>
<td style="text-align: center;"><code>PB0</code></td>
</tr>
<tr>
<td style="text-align: left;">Modo filas</td>
<td style="text-align: center;">Salida</td>
</tr>
<tr>
<td style="text-align: left;">Pull up/ down filas</td>
<td style="text-align: center;">No push, no pull</td>
</tr>
<tr>
<td style="text-align: left;">Timeout de excitaci√≥n de filas</td>
<td style="text-align: center;"><span class="arithmatex">\(25 ms\)</span></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 1</td>
<td style="text-align: center;"><code>PA8</code>/ <code>EXTI8</code>/ <code>EXTI9_5_IRQHandler()</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 2</td>
<td style="text-align: center;"><code>PB10</code>/ <code>EXTI10</code>/ <code>EXTI15_10_IRQHandler()</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 3</td>
<td style="text-align: center;"><code>PB4</code>/ <code>EXTI4</code>/ <code>EXTI4_IRQHandler()</code></td>
</tr>
<tr>
<td style="text-align: left;">Pin/ EXTI/ ISR columna 4</td>
<td style="text-align: center;"><code>PB5</code>/ <code>EXTI5</code>/ <code>EXTI9_5_IRQHandler()</code></td>
</tr>
<tr>
<td style="text-align: left;">Modo columnas</td>
<td style="text-align: center;">Entrada</td>
</tr>
<tr>
<td style="text-align: left;">Pull up/ down columnas</td>
<td style="text-align: center;">Pull down</td>
</tr>
<tr>
<td style="text-align: left;">Prioridad todas las columnas</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: left;">Subprioridad todas las columnas</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: left;">Tiempo anti-rebotes todas las columnas</td>
<td style="text-align: center;"><span class="arithmatex">\(100-200 ms\)</span></td>
</tr>
</tbody>
</table>
<h2 id="caracteristicas-del-teclado-matricial-en-version-2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.1</span> Caracter√≠sticas del teclado matricial en Versi√≥n 2<a class="headerlink" href="#caracteristicas-del-teclado-matricial-en-version-2" title="Permanent link">¬∂</a></h2>
<figure style="text-align:center;"> <div style="display: flex; justify-content: center; align-items: center; gap: 10px;"> <img alt="Circuiter√≠a teclado" id="fig:keypad" src="../assets/notebook_imgs/pr_chapters/version_2/keypad.jpeg" style="width:40%;"/> <img alt="Esquema matricial" id="fig:keypad_matrix" src="../assets/notebook_imgs/pr_chapters/version_2/keypad_matrix.png" style="width:50%;"/> </div> <figcaption>(a) Circuio de un teclado matricial de membrana, (b) Esquema de conexiones.</figcaption> </figure>
<p>Si tiene la oportunidad de abrir en casa cualquier sistema que tenga un teclado o botonera<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, seguramente encuentre una circuiter√≠a como la de la <a href="#fig:keypad">figura (a)</a>. La goma gris es la cara interna de los botones, que est√° sobre la PCB verde. Las almohadillas negras que ve son contactos met√°licos que, cuando se pulsa el bot√≥n, se cortocircuitan con el metal de la PCB y cierran el circuito<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.</p>
<p>La idea de colocar los botones as√≠, haciendo una rejilla, es muy inteligente. Haciendo un enrejillado no es necesario tener un cable para cada bot√≥n, porque un cable por cada bot√≥n implicar√≠a tener un pin de entrada en nuestro microcontrolador por cada uno (si no se usan multiplexores, claro), y los pines no es algo que sobre, generalmente, en los encapsulados de los chips. Por ejemplo, en el <a href="#fig:keypad">reclado de la figura (a)</a> se usan 10 cables para 24 botones (ahorro del <span class="arithmatex">\(58.3\%\)</span> de conexiones/pines), y en el del teclado del laboratorio se usar√°n 8 conexiones para 16 botones (ahorro del <span class="arithmatex">\(50.0\%\)</span>).</p>
<p>Pero esta idea no sale gratis. A cambio de reducir el hardware necesario, tenemos que complicar el software un poquito. Debemos ir excitando ‚Äîponiendo tensi√≥n‚Äî las filas o columnas de forma c√≠clica para poder detectar qu√© bot√≥n se ha pulsado (lo hacemos leyendo las columnas o filas respectivamente). Si alguna columna detecta esa tensi√≥n, sabemos qu√© tecla exacta (intersecci√≥n fila-columna) se ha pulsado. Este proceso se repite para todas las filas r√°pidamente. <strong>En nuestro caso excitaremos filas</strong>. F√≠jate que solo podemos tener una fila con tensi√≥n a la vez porque, de otro modo, no ser√≠amos capaces de distinguir entre los botones de una misma columna. Si haces un dibujo, lo ver√°s f√°cilmente.</p>
<p>No te preocupes, la gesti√≥n de filas y columnas tiene f√°cil soluci√≥n si trabajamos con las m√°quinas de estado; pues para controlar la excitaci√≥n de las filas del teclado matricial tendremos la <a href="#fig:fsm_keyboard">FSM del teclado</a>.</p>
<p>Recuerda que, como hicimos con el bot√≥n, <strong>estamos desarrollando una librer√≠a.</strong> El teclado matricial no tiene por qu√© saber nada de las acciones que hace el sistema cuando se pulsa una tecla. Es por eso que en nuestro proyecto, el teclado se encargar√° solo de guardar la tecla pulsada y de avisar de que ha habido una pulsaci√≥n. El sistema que use esta librer√≠a ‚Äîsea en este proyecto u otro‚Äî deber√° comprobar dicho valor guardado con un <em>get</em>. La idea es exactamente la misma que la que implement√≥ en el bot√≥n. As√≠, cada vez que se quiera a√±adir un teclado, le asociaremos una <strong><a href="acronimos.html#acro:FSM">FSM</a></strong>. Las particularidades de d√≥nde est√°n conectadas las filas y columnas son cosas espec√≠ficas del HW, por lo que estar√°n en <code>PORT</code>.</p>
<figure style="text-align:center;"> <div style="display: flex; justify-content: center; align-items: center; gap: 10px;"> <img alt="Estructura HW teclado" id="fig:stm32f4_keyboard_hw_t" src="../assets/notebook_imgs/pr_chapters/version_2/stm32f4_keyboard_hw_t.svg" style="width:50%;"/> <img alt="Estructura FSM teclado" id="fig:fsm_keyboard_t" src="../assets/notebook_imgs/pr_chapters/version_2/fsm_keyboard_t.svg" style="width:50%;"/> </div> <figcaption>(a) Estructura del HW del teeclado en PORT, (b) Estructura de la FSM del teclado en COMMON.</figcaption> </figure>
<p>Las <a href="#stm32f4_keyboard_hw_t">figuras de estructuras HW</a> <a href="#fms_keyboard_t">y SW</a> muestran las estructuras que vamos a necesitar para el teclado. La estructura del HW del teclado en <code>PORT</code>. El <code>PORT</code> de otro microcontrolador podr√≠a implementar internamente una estructura diferente, por eso est√° dentro de la carpeta <code>stm32f4</code>. Por ejemplo, al <em>portar</em> el c√≥digo para PC no tendr√≠a sentido definir la estructura de una GPIO. La estructura de la <a href="acronimos.html#acro:FSM"><strong>FSM</strong></a> del teclado en <code>COMMON</code> se muestra en la <a href="#fsm_keyboard_t">figura de la FSM</a>.</p>
<p>Como en el caso del bot√≥n, aqu√≠, aunque no hay muelles, puede haber igualmente inestabilidades en la pulsaci√≥n, <strong>rebotes</strong>, por lo e vamos a implementar, igualmente, un mecanismo antirebotes. Dejaremos unos tiempos de guarda de antirebotes tambi√©n entre <span class="arithmatex">\(100-200 ms\)</span>.</p>
<p>En el caso del teclado matricial no tenemos circuito preestablecido, por lo que podemos elegir libremente si queremos usar resistencias de <em>pull-up</em> o <em>pull-down</em> en las columnas. <strong>En este caso, usaremos resistencias de <em>pull-down</em> en las columnas y excitaremos las filas poniendo un nivel l√≥gico alto. As√≠, cuando se pulsa una tecla, la columna correspondiente pasa a nivel alto.</strong> Esto es al rev√©s de como pasaba en el bot√≥n. </p>
<p>Ahora s√≠, comencemos. Preparemos el proyecto para poder a√±adir el <em>teclado matricial</em>:</p>
<ol>
<li>Descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte PORT</strong> de la librer√≠a del <em>keyboard</em> correspondientes a la versi√≥n <code>V2</code>: <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2">https://github.com/sdg2DieUpm/simone/tree/simone_v2</a>. Solo descarga por ahora: <code>port_keyboard.h</code>, <code>stm32f4_keyboard.h</code>, y <code>stm32f4_keyboard.c</code> y col√≥calos en las carpetas correspondientes. <strong>De la parte COMMON descarga solo <code>keyboards.h</code>, y <code>keyboards.c</code></strong>, que incluyen los <em>layouts</em> de los teclados matriciales. </li>
<li>Coloca cada uno donde corresponde: <code>PORT</code> o <code>COMMON</code>, en <code>include</code>, o <code>src</code>. <strong>Ten en cuenta que algunos ficheros de <code>PORT</code> est√°n en la carpeta <code>stm32f4</code> porque sus funciones reciben o devuelven estructuras espec√≠ficas de la <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</strong></li>
</ol>
<p>Ver√°s que no compila, y es que solo se te proporciona cierta parte del c√≥digo. Los prototipos de gran parte de las funciones p√∫blicas no est√°n definidos.</p>
<h2 id="sec:layouts_keyboards"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.2</span> Layouts de teclados matriciales<a class="headerlink" href="#sec:layouts_keyboards" title="Permanent link">¬∂</a></h2>
<p>Antes de ponernos a programar, conviene explicar qu√© son los ficheros <code>keyboards.h</code> y <code>keyboards.c</code>. Estos ficheros se han de colocar en la carpeta <code>common/include</code> y <code>common/src</code> respectivamente. Estos ficheros contienen los <em>layouts</em> de los teclados matriciales que queramos usar en nuestro proyecto. Un <em>layout</em> es una matriz que define qu√© car√°cter representa cada tecla del teclado. Por ejemplo, en un teclado 4x4 t√≠pico, la primera fila podr√≠a representar los caracteres '1', '2', '3', 'A'; la segunda fila '4', '5', '6', 'B'; y as√≠ sucesivamente, pero otro tambi√©n de 4x4 podr√≠a tener una distribuci√≥n diferente (solo letras, o solo n√∫meros).</p>
<p>Estos ficheros permiten definir m√∫ltiples <em>layouts</em> para diferentes teclados matriciales, facilitando su uso en la librer√≠a del teclado. En la <a href="#cha:version5">Versi√≥n 5</a> podr√≠as querer a√±adir un nuevo <em>layout</em> de alg√∫n teclado extra, o modificar el existente.</p>
<p>La estructura <code>keyboard_t</code> definida en <code>keyboards.h</code> contiene:</p>
<ul>
<li>Un puntero a una matriz de caracteres (<code>const char *keys</code>), que representa el <em>layout</em> del teclado.</li>
<li>El n√∫mero de filas (<code>uint8_t rows</code>) y columnas (<code>uint8_t cols</code>) del teclado.</li>
<li>Un caracter especial (<code>char null_key</code>) que indica que no se ha pulsado ninguna tecla. Por ejemplo el caracter <a href="acronimos.html#acro:ASCII">ASCII</a> nulo <code>'\0'</code>.</li>
</ul>
<p>En el mismo fichero se declara <code>standard_keyboard</code> como un ejemplo de <em>layout</em> para un teclado matricial 4x4. Este <em>layout</em> se define en <code>keyboards.c</code> como una matriz de caracteres que representa las teclas del teclado. Aqu√≠ se hace p√∫blico para que pueda ser usado en otras partes del c√≥digo; sus particularidades se definen en el <code>.c</code>.</p>
<h2 id="sec:headers_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3</span> <code>PORT</code>: cabeceras de la librer√≠a del teclado<a class="headerlink" href="#sec:headers_keyboard" title="Permanent link">¬∂</a></h2>
<p>Vamos a implementar el <em>contrato con el usuario</em> de la parte dependiente del HW de librer√≠a del teclado. Esta interfaz permitir√° definir cu√°ntas filas y columnas tiene nuestro teclado y qu√© caracteres representa cada tecla. Comenzaremos de nuevo por la cabecera y luego los c√≥digos fuente.</p>
<h3 id="cabecera-port_keyboardh"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3.1</span> Cabecera port_keyboard.h<a class="headerlink" href="#cabecera-port_keyboardh" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera depende del HW pero no de las particularidades del microcontrolador <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. Vamos a seguir los siguientes pasos:</p>
<ul>
<li>Incluye todas las cabeceras necesarias seg√∫n indica la API.</li>
<li>Incluye los (<code>#define</code>) necesarios para el teclado: el identificador <code>PORT_KEYBOARD_MAIN_ID</code> que usaremos en el proyecto Simone, el <em>timeout</em> de excitaci√≥n de filas, y el tiempo de antirebotes de las teclas.</li>
<li>Define los enumerados que identifican los indices de las columnas del teclado, y uqe ser√°n de utilidad para hacer el c√≥digo m√°s legible en el manejo de las interrupciones.</li>
<li>Escribe los prototipos de las funciones p√∫blicas que aparecen en la API del fichero <code>port_keyboard.h</code>. </li>
<li>Puede ser buen momento ahora para documentar con Doxygen.</li>
</ul>
<h3 id="cabecera-stm32f4_keyboardh"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3.2</span> Cabecera stm32f4_keyboard.h<a class="headerlink" href="#cabecera-stm32f4_keyboardh" title="Permanent link">¬∂</a></h3>
<p>Esta cabecera define los pines f√≠sicos a los que est√°n conectadas las filas y columnas del teclado en nuestra placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</p>
<ul>
<li>Incluye todas las cabeceras necesarias.</li>
<li>Define (<code>#define</code>) los valores de las GPIO y pines para las 4 Filas (<code>ROW</code>) y las 3 o 4 Columnas (<code>COL</code>). Es recomendable usar nombres descriptivos como <code>STM32F4_KEYBOARD_ROW_1_PIN</code>, etc.</li>
<li>Documenta los <code>#define</code> con Doxygen.</li>
</ul>
<p>Ya hemos acabado con el encabezado (<em>header</em>) que interact√∫a con el HW. Todav√≠a dar√° errores al compilar. Vamos ahora a implementar todas las funciones prototipadas en <code>port_keyboard.h</code>.</p>
<h2 id="sec:port_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4</span> <code>PORT</code>: fuente de la librer√≠a del teclado<a class="headerlink" href="#sec:port_keyboard" title="Permanent link">¬∂</a></h2>
<p>Vamos a <em>portar</em> las funciones necesarias para controlar los pines del teclado. Programaremos los ficheros fuente de la parte <code>PORT</code>, que <strong>todos estar√°n en el fichero <code>stm32f4_keyboard.c</code></strong>.</p>
<h3 id="fuentes-stm32f4_keyboardc"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4.1</span> Fuentes stm32f4_keyboard.c<a class="headerlink" href="#fuentes-stm32f4_keyboardc" title="Permanent link">¬∂</a></h3>
<p>La complejidad aqu√≠ reside en la gesti√≥n de m√∫ltiples pines y en la l√≥gica de configuraci√≥n de entrada/salida.</p>
<ol>
<li>Incluye las librer√≠as necesarias.</li>
<li>Define la estructura <code>stm32f4_keyboard_hw_t</code>. A diferencia del bot√≥n simple, esta estructura debe contener arrays o listas de los pines correspondientes a las filas y a las columnas.</li>
<li>Define la <strong>variable global privada</strong> <code>static stm32f4_keyboard_hw_t keyboards_arr</code></li>
</ol>
<p> con la configuraci√≥n f√≠sica de nuestro teclado.
4. Codifica la funci√≥n <code>_stm32f4_keyboard_get()</code> para recuperar la configuraci√≥n del hardware.</p>
<p>Ahora vamos a codificar las funciones que permiten la magia del barrido:</p>
<ol>
<li>Codifica la funci√≥n <code>port_keyboard_init()</code>. Esta funci√≥n es cr√≠tica:</li>
<li>Debe configurar los pines de las <strong>FILAS</strong> como salidas digitales.</li>
<li>Debe configurar los pines de las <strong>COLUMNAS</strong> como entradas digitales con resistencia de <em>pull-up</em> (o <em>pull-down</em> seg√∫n tu dise√±o).</li>
<li>
<p>Inicialmente, pon todas las filas en estado inactivo (alto si usas pull-up en columnas, o bajo si usas pull-down).</p>
</li>
<li>
<p>Codifica la funci√≥n <code>port_keyboard_set_row()</code>. Esta funci√≥n recibe un √≠ndice de fila y un valor (0 o 1). Su misi√≥n es escribir en el pin f√≠sico correspondiente a esa fila.</p>
</li>
<li>Codifica la funci√≥n <code>port_keyboard_get_cols()</code>. Esta funci√≥n debe leer el estado de todos los pines de columna y devolver un valor (puede ser una m√°scara de bits o un booleano compuesto) que indique si alguna columna est√° activa.</li>
</ol>
<p>Si ahora compila, el c√≥digo no deber√≠a tener ning√∫n error. <strong>¬°Ya hemos acabado con la implementaci√≥n de <em>portado</em> del teclado!</strong> Vamos a probarlo con el <em>test</em> unitario de la parte <code>PORT</code>.</p>
<h2 id="sec:test_port_v2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.5</span> <code>PORT</code>: Test unitario del teclado<a class="headerlink" href="#sec:test_port_v2" title="Permanent link">¬∂</a></h2>
<p>Antes de intentar detectar pulsaciones complejas con la FSM, debemos asegurarnos de que podemos encender las filas y leer las columnas correctamente.</p>
<p><span style="color: Red"><strong>¬°Importante! Revisa que las conexiones f√≠sicas coincidan con los defines de tu cabecera.</strong></span></p>
<p>Descarga el fichero de test HW del teclado <code>test_port_keyboard.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2_test">https://github.com/sdg2DieUpm/simone/tree/simone_v2_test</a>. Ponlo en la carpeta <code>test/stm32f4</code>.</p>
<ol>
<li>Conecta la placa y el teclado matricial.</li>
<li>Pulsa sobre el <strong>icono de depuraci√≥n { .inline-img }</strong>.</li>
<li>Selecciona el test <code>test_port_keyboard</code>.</li>
<li>Este test probablemente te pedir√° que pulses teclas espec√≠ficas (ej: "Pulsa la tecla de la Fila 1, Columna 1") y verificar√° si el software detecta el cambio de nivel l√≥gico.</li>
<li>Comprueba que todos los test pasan correctamente.</li>
</ol>
<p><strong>¬°Ya hemos acabado con la parte <code>PORT</code>!</strong> Vamos ahora a implementar la parte <code>COMMON</code>.</p>
<h2 id="common-cabecera-de-la-fsm-del-teclado"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.6</span> <code>COMMON</code>: cabecera de la FSM del teclado<a class="headerlink" href="#common-cabecera-de-la-fsm-del-teclado" title="Permanent link">¬∂</a></h2>
<h5 id="consideraciones-fsm-keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.6.0.0.1</span> Consideraciones de la FSM del teclado<a class="headerlink" href="#consideraciones-fsm-keyboard" title="Permanent link">¬∂</a></h5>
<p>Antes de empezar, entendamos c√≥mo funciona el barrido l√≥gico.</p>
<ul>
<li>La FSM no lee todo el teclado de golpe. En cada ciclo (o <em>tick</em>), activa una fila, espera un instante para que la se√±al se estabilice, lee las columnas y luego desactiva la fila para pasar a la siguiente.</li>
<li>Necesitaremos gestionar el <strong>anti-rebotes</strong> (<em>debouncing</em>) igual que con el bot√≥n, pero teniendo en cuenta que estamos saltando de fila en fila.</li>
<li>La FSM debe almacenar la <strong>√∫ltima tecla v√°lida pulsada</strong> en el campo <code>key</code> de su estructura.</li>
</ul>
<figure><embed id="fig:fsm_keyboard" src="../assets/notebook_imgs/pr_chapters/version_2/fsm_keyboard.svg" style="width:100.0%"/><figcaption aria-hidden="true">M√°quina de estados del teclado matricial..</figcaption></figure>
<p>Nuestra librer√≠a implementa la l√≥gica de la <strong><a href="acronimos.html#acro:FSM">FSM</a></strong> mostrada en la y que llamaremos <code>fsm_keyboard</code>. Los estados principales son:</p>
<ul>
<li><code>WAIT_ROW</code>: Estado de espera. La FSM aguarda a que el temporizador indique que es momento de escanear la siguiente fila.</li>
<li><code>SCAN_COL</code>: Se ha activado una fila. En este estado se leen las columnas para ver si hay alguna tecla pulsada en dicha fila.</li>
<li><code>KEY_PRESSED</code>: Se ha detectado una pulsaci√≥n. Aqu√≠ se realiza la validaci√≥n (anti-rebotes) y se decodifica qu√© tecla es bas√°ndose en la fila activa y la columna detectada.</li>
<li>
<p><code>KEY_RELEASED</code>: Esperamos a que el usuario suelte la tecla para evitar lecturas m√∫ltiples de una sola pulsaci√≥n.</p>
</li>
<li>
<p>Descarga los ficheros <code>fsm_keyboard.h</code> y <code>fsm_keyboard.c</code> de la parte <strong>COMMON</strong>.</p>
</li>
</ul>
<p>Ahora, vamos a completar la cabecera <code>fsm_keyboard.h</code>.</p>
<ol>
<li>Incluye las librer√≠as necesarias.</li>
<li>Define el enumerado <code>FSM_KEYBOARD</code> con los estados descritos.</li>
<li>Define la estructura <code>fsm_keyboard_t</code>. Recuerda que debe comenzar con el objeto <code>fsm_t</code>. Necesitar√° campos para almacenar:</li>
<li>El <code>ID</code> del teclado.</li>
<li>La fila actual que se est√° escaneando (<code>current_row</code>).</li>
<li>La tecla detectada (<code>key_pressed</code>).</li>
<li>
<p>Punteros a funciones o tablas para mapear coordenadas (fila, col) a caracteres ASCII.</p>
</li>
<li>
<p>Escribe los prototipos de las funciones p√∫blicas como <code>fsm_keyboard_get_key()</code> o <code>fsm_keyboard_reset()</code>.</p>
</li>
</ol>
<h2 id="common-fuente-de-la-fsm-del-teclado"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.7</span> <code>COMMON</code>: fuente de la FSM del teclado<a class="headerlink" href="#common-fuente-de-la-fsm-del-teclado" title="Permanent link">¬∂</a></h2>
<p>Vamos a implementar la l√≥gica de barrido en <code>fsm_keyboard.c</code>.</p>
<ul>
<li>Incluye las cabeceras necesarias.</li>
<li>Implementa la estructura opaca si no lo hiciste en el .h.</li>
</ul>
<p><strong>Funciones privadas (Entrada/Salida):</strong></p>
<ol>
<li>Codifica las funciones de chequeo <code>check_</code>. Por ejemplo, <code>check_timer_expire()</code> verificar√° si ha pasado el tiempo suficiente para saltar a la siguiente fila. <code>check_col_active()</code> leer√° del puerto si hay pulsaci√≥n.</li>
<li>Codifica las funciones de acci√≥n <code>do_</code>.</li>
<li><code>do_next_row()</code>: Incrementa el √≠ndice de fila, hace <em>wrap-around</em> si llega al final, y llama a <code>port_keyboard_set_row()</code> para activar la nueva fila f√≠sicamente.</li>
<li><code>do_save_key()</code>: Si se detecta pulsaci√≥n, cruza el dato de la fila actual y la columna le√≠da con tu mapa de caracteres para guardar el valor en <code>key_pressed</code>.</li>
</ol>
<p><strong>Tabla de Transiciones:</strong></p>
<ol>
<li>Declara la tabla <code>fsm_trans_keyboard</code>. Aseg√∫rate de cubrir el ciclo completo: esperar timer -&gt; activar fila -&gt; leer columnas -&gt; (si nada) esperar timer... o (si pulsaci√≥n) -&gt; gestionar pulsaci√≥n.</li>
</ol>
<p><strong>Funciones P√∫blicas:</strong></p>
<ol>
<li>Codifica <code>fsm_keyboard_fire()</code>.</li>
<li>Codifica <code>fsm_keyboard_get_key_value()</code> para que el usuario pueda recuperar la tecla detectada.</li>
<li>Completa la inicializaci√≥n en <code>fsm_keyboard_init()</code>.</li>
</ol>
<p><strong>¬°Ya hemos acabado con la programaci√≥n de la librer√≠a del teclado!</strong></p>
<h2 id="sec:test_fsm_v2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.8</span> <code>COMMON</code> Test unitario de la FSM del teclado<a class="headerlink" href="#sec:test_fsm_v2" title="Permanent link">¬∂</a></h2>
<p>Vamos a verificar que la l√≥gica de barrido funciona independientemente del hardware (usando <em>mocks</em> o simulaci√≥n de puertos en el test).</p>
<p><span style="color: Red"><strong>¬°Importante! Los test comprueban la l√≥gica de estados, no si tu cableado est√° bien.</strong></span></p>
<p>Descarga <code>test_fsm_keyboard.c</code> y ponlo en la carpeta <code>test/</code>.</p>
<ol>
<li>Selecciona el test <code>test_fsm_keyboard</code> en tu entorno de depuraci√≥n.</li>
<li>Ejecuta el test. Este simular√° el paso del tiempo y las se√±ales de columnas para verificar que la FSM transiciona correctamente y decodifica el car√°cter esperado.</li>
<li>Si falla, usa el depurador para ver en qu√© estado se queda la m√°quina.</li>
</ol>
<h2 id="ejemplo-de-uso-de-la-version-2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.9</span> Ejemplo de uso de la Versi√≥n 2<a class="headerlink" href="#ejemplo-de-uso-de-la-version-2" title="Permanent link">¬∂</a></h2>
<p>Vamos a integrar todo. Crearemos un peque√±o programa que escanee el teclado y env√≠e por puerto serie (o muestre en depuraci√≥n) la tecla pulsada.</p>
<p>Descarga <code>example2.c</code> y ponlo en <code>example/</code>.</p>
<p><strong>Procedamos</strong>:</p>
<ol>
<li>Monta el teclado matricial con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>.</li>
<li>Ejecuta el ejemplo <code>example_v2</code>.</li>
<li>Abre la terminal o pon un <em>breakpoint</em> donde se lea la tecla.</li>
<li>Pulsa varias teclas y verifica que el car√°cter recibido coincide con la etiqueta f√≠sica de la tecla.</li>
</ol>
<p>¬°Hemos dominado el barrido de entradas! Esta base es fundamental para el proyecto final.</p>
<p>No dejes de documentar el c√≥digo con Doxygen. Guarda una copia de tu proyecto como <code>simone_v2</code>.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>Por ejemplo, un teclado de ordenador, una calculadora, un cajero autom√°tico, etc. No nos hacemos responsables de posibles da√±os que pueda ocasionar üòÖ.¬†<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">‚Ü©</a></p>
</li>
<li id="fn:2">
<p>Para un mejor contacto, el circuito de la imagen son dos pistas de cobre en zig-zag que se cortocircuitan al pulsar el bot√≥n. Lo m√°s simple ser√≠a una cruz que no se toca, pero su contacto es menos fiable. En teclados m√°s avanzados, puede haber circuitos adicionales para mejorar la durabilidad o la respuesta t√°ctil.¬†<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">‚Ü©</a></p>
</li>
<li id="fn:stm322025fundamentos">
<p>Josu√© Pag√°n Ortiz. <em>Fundamentos te√≥ricos de sistemas basados en microcontrolador STM32</em>. Universidad Polit√©cnica de Madrid, 2024.¬†<a class="footnote-backref" href="#fnref:stm322025fundamentos" title="Jump back to footnote 3 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021datasheet">
<p>STMicroelectronics. Stm32f446xc/e. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/datasheet/stm32f446re.pdf">https://www.st.com/resource/en/datasheet/stm32f446re.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021datasheet" title="Jump back to footnote 4 in the text">‚Ü©</a></p>
</li>
<li id="fn:st2021reference">
<p>STMicroelectronics. Rm0390 reference manual. stm32f446xx advanced arm-based 32-bit mcus. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf</a>.¬†<a class="footnote-backref" href="#fnref:st2021reference" title="Jump back to footnote 5 in the text">‚Ü©</a></p>
</li>
</ol>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Volver al principio
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
<script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
</body>
</html>