
<!DOCTYPE html>

<html class="no-js" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://sdg2dieupm.github.io/simone/notebook/version_2.html" rel="canonical"/>
<link href="version_1.html" rel="prev"/>
<link href="version_3.html" rel="next"/>
<link href="../assets/general/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Versión 2 - Laboratorio de Sistemas Digitales II</title>
<link href="../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/notebook-extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="deep_orange" data-md-color-primary="blue_grey" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cha:version2">
          Saltar a contenido
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Cabecera" class="md-header__inner md-grid">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-header__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Laboratorio de Sistemas Digitales II
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Versión 2
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Cambiar a modo oscuro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Cambiar a modo oscuro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Cambiar a modo claro" class="md-option" data-md-color-accent="deep_orange" data-md-color-media="" data-md-color-primary="blue_grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Cambiar a modo claro">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Búsqueda" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Búsqueda" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Buscar" class="md-search__options">
<button aria-label="Limpiar" class="md-search__icon md-icon" tabindex="-1" title="Limpiar" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navegación" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Laboratorio de Sistemas Digitales II" class="md-nav__button md-logo" data-md-component="logo" href="../index.html" title="Laboratorio de Sistemas Digitales II">
<img alt="logo" src="../assets/notebook_imgs/general/etsit.png"/>
</a>
    Laboratorio de Sistemas Digitales II
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../index.html">
<span class="md-ellipsis">
    Portada
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Introducción general
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introducción general
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="intro.html">
<span class="md-ellipsis">
    Introducción a SDG2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="sesion_introduccion.html">
<span class="md-ellipsis">
    Sesión de introducción
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    Proyecto
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Proyecto
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="proyecto_base.html">
<span class="md-ellipsis">
    Proyecto base
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_1.html">
<span class="md-ellipsis">
    Versión 1
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Versión 2
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="version_2.html">
<span class="md-ellipsis">
    Versión 2
    
  </span>
</a>
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_keyboard">
<span class="md-ellipsis">
      PORT: cabeceras de la librería del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_keyboard">
<span class="md-ellipsis">
      PORT: fuente de la librería del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v2">
<span class="md-ellipsis">
      PORT: Test unitario del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-fuente-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v2">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-2">
<span class="md-ellipsis">
      Ejemplo de uso de la Versión 2
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_3.html">
<span class="md-ellipsis">
    Versión 3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_4.html">
<span class="md-ellipsis">
    Versión 4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="version_5.html">
<span class="md-ellipsis">
    Versión 5
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    API
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            API
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/index.html">
<span class="md-ellipsis">
    Documentación API
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    Apéndices
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Apéndices
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="bom.html">
<span class="md-ellipsis">
    BOM
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    Acrónimos
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Acrónimos
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="acronimos.html">
<span class="md-ellipsis">
    Acrónimos
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Tabla de contenidos" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:headers_keyboard">
<span class="md-ellipsis">
      PORT: cabeceras de la librería del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:port_keyboard">
<span class="md-ellipsis">
      PORT: fuente de la librería del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_port_v2">
<span class="md-ellipsis">
      PORT: Test unitario del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-cabecera-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: cabecera de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-fuente-de-la-fsm-del-teclado">
<span class="md-ellipsis">
      COMMON: fuente de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sec:test_fsm_v2">
<span class="md-ellipsis">
      COMMON Test unitario de la FSM del teclado
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ejemplo-de-uso-de-la-version-2">
<span class="md-ellipsis">
      Ejemplo de uso de la Versión 2
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cha:version2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.</span> Versión 2: teclado matricial<a class="headerlink" href="#cha:version2" title="Permanent link">¶</a></h1>
<p>En la versión anterior aprendimos a gestionar un único botón mediante interrupciones. Sin embargo, ¿qué ocurre si nuestro sistema necesita 12, 16 o más botones? Si utilizáramos la estrategia anterior, necesitaríamos una línea de interrupción y un pin GPIO por cada botón, agotando rápidamente los recursos del microcontrolador.</p>
<p>Para solucionar esto, utilizamos la técnica del <strong>barrido</strong> o <em>scanning</em> en un teclado matricial. Esta técnica aprovecha la persistencia temporal para leer muchos pulsadores utilizando pocos pines, organizándolos en filas y columnas.</p>
<div class="admonition example">
<p class="admonition-title">Bibliografía</p>
<ol>
<li>
<p><em>“Fundamentos teóricos de sistemas basados en microcontrolador STM32”</em> <sup id="fnref:stm322025fundamentos"><a class="footnote-ref" href="#fn:stm322025fundamentos">1</a></sup></p>
</li>
<li>
<p><em>Datasheet “STM32F446xC/E”</em> <sup id="fnref:st2021datasheet"><a class="footnote-ref" href="#fn:st2021datasheet">2</a></sup></p>
</li>
<li>
<p><em>Reference manual “RM0390. STM32F446xx advanced Arm-based 32-bit MCUs’</em> <sup id="fnref:st2021reference"><a class="footnote-ref" href="#fn:st2021reference">3</a></sup></p>
</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title"><a href="https://www.youtube.com/channel/UCYIw_gl745WMJ1n0MamDzQw/">Vídeos del canal de SDGII</a></p>
<ul>
<li>
<p><a href="#TO-DO">Demostración Simone</a></p>
</li>
<li>
<p><a href="https://youtu.be/CcbgLVfCXrw?si=A8DP1rescxJNBEb9">Blink LED y manejo de proyecto</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLTFFovUxjNnn19myGVw1kwh6GPbRxwIcC">Conceptos básicos de C (canal SDG1)</a></p>
</li>
<li>
<p><a href="https://youtu.be/VC7fExJJQSY?si=YIY22n5yiqzfZuQd">[MatrixMCU] Documentación de código con Doxygen</a></p>
</li>
</ul>
</div>
<p>En este capítulo vamos a crear una librería que nos permita gestionar un teclado matricial de 4x4 (16 teclas). A diferencia del botón, que funcionaba solo teníamos una interrupción, aquí <strong>utilizaremos un temporizador que nos interrumpe para realizar una excitación periódica de las filas y esperaremos interrupciones de las columnas.</strong></p>
<p>Como ya hicimos en las versiones anteriores, (i) vamos a implementar la parte <em>portable</em> <code>PORT</code> dependiente del <strong><a href="acronimos.html#acro:HW">HW</a></strong> para gestionar los niveles lógicos de las filas y la lectura de las columnas, y lo probaremos con un test unitario. (ii) Después, vamos a crear la lógica de la <strong><a href="acronimos.html#acro:FSM">FSM</a></strong> para gestionar el barrido y el <em>anti-rebotes</em> (la parte <code>COMMON</code>), y lo probaremos con un test unitario. (iii) Por último, montaremos el <strong><a href="acronimos.html#acro:HW">HW</a></strong> y probaremos el funcionamiento con un programa de ejemplo.</p>
<p>El teclado matricial es un array de pulsadores conectados en intersecciones de filas y columnas. Cuando no se pulsa ninguna tecla, no hay conexión entre filas y columnas. Al pulsar una tecla, se cortocircuita una fila con una columna específica. Las características a destacar del sistema de la Versión 2 se muestran en la <a href="#tbl:version2_keypad">siguiente tabla</a>.</p>
<div id="tbl:version2_keypad"></div>
<table>
<thead>
<tr>
<th><strong>Parámetro</strong></th>
<th><strong>Valor</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Filas</td>
<td>Salidas (GPIO Out)</td>
</tr>
<tr>
<td>Columnas</td>
<td>Entradas con Pull-Up/Down</td>
</tr>
<tr>
<td>Lógica</td>
<td>Barrido secuencial</td>
</tr>
<tr>
<td>Timer de escaneo</td>
<td>aprox.</td>
</tr>
<tr>
<td>Anti-rebotes</td>
<td>Software</td>
</tr>
</tbody>
</table>
<p>Características del teclado matricial en Versión 2.</p>
<p>La técnica de barrido consiste en poner una fila a un nivel lógico activo (por ejemplo, '0' si usamos resistencias <em>pull-up</em> en las columnas) y leer el estado de las columnas. Si alguna columna detecta ese '0', sabemos qué tecla exacta (intersección Fila-Columna) se ha pulsado. Este proceso se repite para todas las filas muy rápidamente.</p>
<figure><embed id="fig:keyboard_schematic" src="/assets/pr_chapters/version_2/keyboard_schematic.pdf" style="width:100.0%"/><figcaption aria-hidden="true">Esquemático de conexión del teclado matricial 4x4.</figcaption></figure>
<p>Igual que hemos hecho hasta ahora, <strong>estamos desarrollando una librería.</strong> Así, cada vez que se quiera añadir un teclado, le asociaremos una <strong><a href="acronimos.html#acro:FSM">FSM</a></strong>. Las particularidades de dónde están conectadas las filas y columnas son cosas específicas del HW, por lo que estarán en <code>PORT</code>.</p>
<p>La muestra las estructuras que vamos a necesitar para el teclado. La estructura del HW del teclado (en <code>PORT</code>) se muestra en la . La estructura de la <strong><a href="acronimos.html#acro:FSM">FSM</a></strong> (en <code>COMMON</code>) se muestra en la .</p>
<h5 id="section_v2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.0.0.0.1</span> { #section_v2 }<a class="headerlink" href="#section_v2" title="Permanent link">¶</a></h5>
<p>Preparemos el proyecto para poder añadir el teclado matricial:</p>
<ol>
<li>Descarga del repositorio de la asignatura los ficheros correspondientes <strong>a la parte PORT</strong> de la librería del <em>teclado</em> correspondientes a la versión <code>V2</code>: <a href="https://github.com/sdg2DieUpm/Simone/tree/simone_v2">https://github.com/sdg2DieUpm/Simone/tree/simone_v2</a>. Solo descarga por ahora: <code>port_keyboard.h</code>, <code>stm32f4_keyboard.h</code>, y <code>stm32f4_keyboard.c</code> y colócalos en las carpetas correspondientes. <strong>No añadas los ficheros de la parte COMMON.</strong></li>
<li>Coloca cada uno donde corresponde: <code>PORT</code> o <code>COMMON</code>, en <code>include</code>, o <code>src</code>.</li>
</ol>
<h2 id="sec:headers_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.1</span> <code>PORT</code>: cabeceras de la librería del teclado<a class="headerlink" href="#sec:headers_keyboard" title="Permanent link">¶</a></h2>
<p>Vamos a implementar el <em>contrato con el usuario</em> de la parte dependiente del HW de librería del teclado. Esta interfaz permitirá definir cuántas filas y columnas tiene nuestro teclado y qué caracteres representa cada tecla. Comenzaremos de nuevo por la cabecera y luego los códigos fuente.</p>
<h3 id="cabecera-port_keyboardh"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.1.1</span> Cabecera port_keyboard.h<a class="headerlink" href="#cabecera-port_keyboardh" title="Permanent link">¶</a></h3>
<p>Esta cabecera depende del HW pero no de las particularidades del microcontrolador <span style="color: RoyalBlue; font-weight: bold;">STM32F446RE</span>. Vamos a seguir los siguientes pasos:</p>
<ul>
<li>Incluye todas las cabeceras necesarias según indica la API.</li>
<li>Incluye los (<code>#define</code>) necesarios para el teclado, como el identificador <code>PORT_KEYBOARD_ID</code> que usaremos en el proyecto Simone.</li>
<li>Define también el mapa de caracteres. Esto suele hacerse mediante un array bidimensional o defines específicos para cada posición <code>(fila, columna)</code>.</li>
<li>Escribe los prototipos de las funciones públicas que aparecen en la API del fichero <code>port_keyboard.h</code>. Necesitaremos funciones para inicializar el barrido y para leer el estado de las columnas.</li>
<li>Puede ser buen momento ahora para documentar con Doxygen.</li>
</ul>
<h3 id="cabecera-stm32f4_keyboardh"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.1.2</span> Cabecera stm32f4_keyboard.h<a class="headerlink" href="#cabecera-stm32f4_keyboardh" title="Permanent link">¶</a></h3>
<p>Esta cabecera define los pines físicos a los que están conectadas las filas y columnas del teclado en nuestra placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32F446RE</span>.</p>
<ul>
<li>Incluye todas las cabeceras necesarias.</li>
<li>Define (<code>#define</code>) los valores de las GPIO y pines para las 4 Filas (<code>ROW</code>) y las 3 o 4 Columnas (<code>COL</code>). Es recomendable usar nombres descriptivos como <code>STM32F4_KEYBOARD_ROW_1_PIN</code>, etc.</li>
<li>Documenta los <code>#define</code> con Doxygen.</li>
</ul>
<p>Ya hemos acabado con el encabezado (<em>header</em>) que interactúa con el HW. Todavía dará errores al compilar. Vamos ahora a implementar todas las funciones prototipadas en <code>port_keyboard.h</code>.</p>
<h2 id="sec:port_keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.2</span> <code>PORT</code>: fuente de la librería del teclado<a class="headerlink" href="#sec:port_keyboard" title="Permanent link">¶</a></h2>
<p>Vamos a <em>portar</em> las funciones necesarias para controlar los pines del teclado. Programaremos los ficheros fuente de la parte <code>PORT</code>, que <strong>todos estarán en el fichero <code>stm32f4_keyboard.c</code></strong>.</p>
<h3 id="fuentes-stm32f4_keyboardc"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.2.1</span> Fuentes stm32f4_keyboard.c<a class="headerlink" href="#fuentes-stm32f4_keyboardc" title="Permanent link">¶</a></h3>
<p>La complejidad aquí reside en la gestión de múltiples pines y en la lógica de configuración de entrada/salida.</p>
<ol>
<li>Incluye las librerías necesarias.</li>
<li>Define la estructura <code>stm32f4_keyboard_hw_t</code>. A diferencia del botón simple, esta estructura debe contener arrays o listas de los pines correspondientes a las filas y a las columnas.</li>
<li>Define la <strong>variable global privada</strong> <code>static stm32f4_keyboard_hw_t keyboards_arr</code></li>
</ol>
<p> con la configuración física de nuestro teclado.
4. Codifica la función <code>_stm32f4_keyboard_get()</code> para recuperar la configuración del hardware.</p>
<p>Ahora vamos a codificar las funciones que permiten la magia del barrido:</p>
<ol>
<li>Codifica la función <code>port_keyboard_init()</code>. Esta función es crítica:</li>
<li>Debe configurar los pines de las <strong>FILAS</strong> como salidas digitales.</li>
<li>Debe configurar los pines de las <strong>COLUMNAS</strong> como entradas digitales con resistencia de <em>pull-up</em> (o <em>pull-down</em> según tu diseño).</li>
<li>
<p>Inicialmente, pon todas las filas en estado inactivo (alto si usas pull-up en columnas, o bajo si usas pull-down).</p>
</li>
<li>
<p>Codifica la función <code>port_keyboard_set_row()</code>. Esta función recibe un índice de fila y un valor (0 o 1). Su misión es escribir en el pin físico correspondiente a esa fila.</p>
</li>
<li>Codifica la función <code>port_keyboard_get_cols()</code>. Esta función debe leer el estado de todos los pines de columna y devolver un valor (puede ser una máscara de bits o un booleano compuesto) que indique si alguna columna está activa.</li>
</ol>
<p>Si ahora compila, el código no debería tener ningún error. <strong>¡Ya hemos acabado con la implementación de <em>portado</em> del teclado!</strong> Vamos a probarlo con el <em>test</em> unitario de la parte <code>PORT</code>.</p>
<h2 id="sec:test_port_v2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.3</span> <code>PORT</code>: Test unitario del teclado<a class="headerlink" href="#sec:test_port_v2" title="Permanent link">¶</a></h2>
<p>Antes de intentar detectar pulsaciones complejas con la FSM, debemos asegurarnos de que podemos encender las filas y leer las columnas correctamente.</p>
<p><span style="color: Red"><strong>¡Importante! Revisa que las conexiones físicas coincidan con los defines de tu cabecera.</strong></span></p>
<p>Descarga el fichero de test HW del teclado <code>test_port_keyboard.c</code> de <a href="https://github.com/sdg2DieUpm/simone/tree/simone_v2_test">https://github.com/sdg2DieUpm/simone/tree/simone_v2_test</a>. Ponlo en la carpeta <code>test/stm32f4</code>.</p>
<ol>
<li>Conecta la placa y el teclado matricial.</li>
<li>Pulsa sobre el <strong>icono de depuración { .inline-img }</strong>.</li>
<li>Selecciona el test <code>test_port_keyboard</code>.</li>
<li>Este test probablemente te pedirá que pulses teclas específicas (ej: "Pulsa la tecla de la Fila 1, Columna 1") y verificará si el software detecta el cambio de nivel lógico.</li>
<li>Comprueba que todos los test pasan correctamente.</li>
</ol>
<p><strong>¡Ya hemos acabado con la parte <code>PORT</code>!</strong> Vamos ahora a implementar la parte <code>COMMON</code>.</p>
<h2 id="common-cabecera-de-la-fsm-del-teclado"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4</span> <code>COMMON</code>: cabecera de la FSM del teclado<a class="headerlink" href="#common-cabecera-de-la-fsm-del-teclado" title="Permanent link">¶</a></h2>
<h5 id="consideraciones-fsm-keyboard"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.4.0.0.1</span> Consideraciones de la FSM del teclado<a class="headerlink" href="#consideraciones-fsm-keyboard" title="Permanent link">¶</a></h5>
<p>Antes de empezar, entendamos cómo funciona el barrido lógico.</p>
<ul>
<li>La FSM no lee todo el teclado de golpe. En cada ciclo (o <em>tick</em>), activa una fila, espera un instante para que la señal se estabilice, lee las columnas y luego desactiva la fila para pasar a la siguiente.</li>
<li>Necesitaremos gestionar el <strong>anti-rebotes</strong> (<em>debouncing</em>) igual que con el botón, pero teniendo en cuenta que estamos saltando de fila en fila.</li>
<li>La FSM debe almacenar la <strong>última tecla válida pulsada</strong> en el campo <code>key</code> de su estructura.</li>
</ul>
<figure><embed id="fig:fsm_keyboard" src="/assets/pr_chapters/version_2/fsm_keyboard.pdf" style="width:100.0%"/><figcaption aria-hidden="true">Máquina de estados del <em>Teclado Matricial</em>.</figcaption></figure>
<p>Nuestra librería implementa la lógica de la <strong><a href="acronimos.html#acro:FSM">FSM</a></strong> mostrada en la y que llamaremos <code>fsm_keyboard</code>. Los estados principales son:</p>
<ul>
<li><code>WAIT_ROW</code>: Estado de espera. La FSM aguarda a que el temporizador indique que es momento de escanear la siguiente fila.</li>
<li><code>SCAN_COL</code>: Se ha activado una fila. En este estado se leen las columnas para ver si hay alguna tecla pulsada en dicha fila.</li>
<li><code>KEY_PRESSED</code>: Se ha detectado una pulsación. Aquí se realiza la validación (anti-rebotes) y se decodifica qué tecla es basándose en la fila activa y la columna detectada.</li>
<li>
<p><code>KEY_RELEASED</code>: Esperamos a que el usuario suelte la tecla para evitar lecturas múltiples de una sola pulsación.</p>
</li>
<li>
<p>Descarga los ficheros <code>fsm_keyboard.h</code> y <code>fsm_keyboard.c</code> de la parte <strong>COMMON</strong>.</p>
</li>
</ul>
<p>Ahora, vamos a completar la cabecera <code>fsm_keyboard.h</code>.</p>
<ol>
<li>Incluye las librerías necesarias.</li>
<li>Define el enumerado <code>FSM_KEYBOARD</code> con los estados descritos.</li>
<li>Define la estructura <code>fsm_keyboard_t</code>. Recuerda que debe comenzar con el objeto <code>fsm_t</code>. Necesitará campos para almacenar:</li>
<li>El <code>ID</code> del teclado.</li>
<li>La fila actual que se está escaneando (<code>current_row</code>).</li>
<li>La tecla detectada (<code>key_pressed</code>).</li>
<li>
<p>Punteros a funciones o tablas para mapear coordenadas (fila, col) a caracteres ASCII.</p>
</li>
<li>
<p>Escribe los prototipos de las funciones públicas como <code>fsm_keyboard_get_key()</code> o <code>fsm_keyboard_reset()</code>.</p>
</li>
</ol>
<h2 id="common-fuente-de-la-fsm-del-teclado"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.5</span> <code>COMMON</code>: fuente de la FSM del teclado<a class="headerlink" href="#common-fuente-de-la-fsm-del-teclado" title="Permanent link">¶</a></h2>
<p>Vamos a implementar la lógica de barrido en <code>fsm_keyboard.c</code>.</p>
<ul>
<li>Incluye las cabeceras necesarias.</li>
<li>Implementa la estructura opaca si no lo hiciste en el .h.</li>
</ul>
<p><strong>Funciones privadas (Entrada/Salida):</strong></p>
<ol>
<li>Codifica las funciones de chequeo <code>check_</code>. Por ejemplo, <code>check_timer_expire()</code> verificará si ha pasado el tiempo suficiente para saltar a la siguiente fila. <code>check_col_active()</code> leerá del puerto si hay pulsación.</li>
<li>Codifica las funciones de acción <code>do_</code>.</li>
<li><code>do_next_row()</code>: Incrementa el índice de fila, hace <em>wrap-around</em> si llega al final, y llama a <code>port_keyboard_set_row()</code> para activar la nueva fila físicamente.</li>
<li><code>do_save_key()</code>: Si se detecta pulsación, cruza el dato de la fila actual y la columna leída con tu mapa de caracteres para guardar el valor en <code>key_pressed</code>.</li>
</ol>
<p><strong>Tabla de Transiciones:</strong></p>
<ol>
<li>Declara la tabla <code>fsm_trans_keyboard</code>. Asegúrate de cubrir el ciclo completo: esperar timer -&gt; activar fila -&gt; leer columnas -&gt; (si nada) esperar timer... o (si pulsación) -&gt; gestionar pulsación.</li>
</ol>
<p><strong>Funciones Públicas:</strong></p>
<ol>
<li>Codifica <code>fsm_keyboard_fire()</code>.</li>
<li>Codifica <code>fsm_keyboard_get_key_value()</code> para que el usuario pueda recuperar la tecla detectada.</li>
<li>Completa la inicialización en <code>fsm_keyboard_init()</code>.</li>
</ol>
<p><strong>¡Ya hemos acabado con la programación de la librería del teclado!</strong></p>
<h2 id="sec:test_fsm_v2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.6</span> <code>COMMON</code> Test unitario de la FSM del teclado<a class="headerlink" href="#sec:test_fsm_v2" title="Permanent link">¶</a></h2>
<p>Vamos a verificar que la lógica de barrido funciona independientemente del hardware (usando <em>mocks</em> o simulación de puertos en el test).</p>
<p><span style="color: Red"><strong>¡Importante! Los test comprueban la lógica de estados, no si tu cableado está bien.</strong></span></p>
<p>Descarga <code>test_fsm_keyboard.c</code> y ponlo en la carpeta <code>test/</code>.</p>
<ol>
<li>Selecciona el test <code>test_fsm_keyboard</code> en tu entorno de depuración.</li>
<li>Ejecuta el test. Este simulará el paso del tiempo y las señales de columnas para verificar que la FSM transiciona correctamente y decodifica el carácter esperado.</li>
<li>Si falla, usa el depurador para ver en qué estado se queda la máquina.</li>
</ol>
<h2 id="ejemplo-de-uso-de-la-version-2"><span class="enumerate-headings-plugin enumerate-heading-plugin">5.7</span> Ejemplo de uso de la Versión 2<a class="headerlink" href="#ejemplo-de-uso-de-la-version-2" title="Permanent link">¶</a></h2>
<p>Vamos a integrar todo. Crearemos un pequeño programa que escanee el teclado y envíe por puerto serie (o muestre en depuración) la tecla pulsada.</p>
<p>Descarga <code>example2.c</code> y ponlo en <code>example/</code>.</p>
<p><strong>Procedamos</strong>:</p>
<ol>
<li>Monta el teclado matricial con la placa <span style="color: RoyalBlue; font-weight: bold;">Nucleo-STM32</span>.</li>
<li>Ejecuta el ejemplo <code>example_v2</code>.</li>
<li>Abre la terminal o pon un <em>breakpoint</em> donde se lea la tecla.</li>
<li>Pulsa varias teclas y verifica que el carácter recibido coincide con la etiqueta física de la tecla.</li>
</ol>
<p>¡Hemos dominado el barrido de entradas! Esta base es fundamental para el proyecto final.</p>
<p>No dejes de documentar el código con Doxygen. Guarda una copia de tu proyecto como <code>simone_v2</code>.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:stm322025fundamentos">
<p>Josué Pagán Ortiz. <em>Fundamentos teóricos de sistemas basados en microcontrolador STM32</em>. Universidad Politécnica de Madrid, 2024. <a class="footnote-backref" href="#fnref:stm322025fundamentos" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:st2021datasheet">
<p>STMicroelectronics. Stm32f446xc/e. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/datasheet/stm32f446re.pdf">https://www.st.com/resource/en/datasheet/stm32f446re.pdf</a>. <a class="footnote-backref" href="#fnref:st2021datasheet" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:st2021reference">
<p>STMicroelectronics. Rm0390 reference manual. stm32f446xx advanced arm-based 32-bit mcus. Technical Report, STMicroelectronics, 2021. URL: <a href="https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf</a>. <a class="footnote-backref" href="#fnref:st2021reference" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Volver al principio
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
<script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
</body>
</html>